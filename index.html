<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StokPro - Aplikasi Pencatatan Stok Barang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-boxes text-2xl"></i>
                    <h1 class="text-2xl font-bold">StokPro</h1>
                </div>
                <nav id="main-nav" class="hidden md:flex space-x-6">
                    <button onclick="showSection('dashboard')" class="nav-btn text-blue-200 transition-colors">Dashboard</button>
                    <button onclick="showSection('products')" class="nav-btn hover:text-blue-200 transition-colors">Produk</button>
                    <button onclick="showSection('orders')" class="nav-btn hover:text-blue-200 transition-colors">Order</button>
                    <button onclick="showSection('sales')" class="nav-btn hover:text-blue-200 transition-colors">Penjualan</button>
                    <button onclick="showSection('stock-card')" class="nav-btn hover:text-blue-200 transition-colors">Kartu Stok</button>
                    <button onclick="showSection('settings')" class="nav-btn hover:text-blue-200 transition-colors">Pengaturan</button>
                </nav>
                <div class="flex items-center space-x-4">
                    <button onclick="showKeyboardShortcuts()" class="hidden md:block text-blue-200 hover:text-white transition-colors" title="Keyboard Shortcuts">
                        <i class="fas fa-keyboard text-lg"></i>
                    </button>
                    <button class="md:hidden" onclick="toggleMobileMenu()">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden bg-white shadow-lg md:hidden">
        <div class="px-6 py-4 space-y-2">
            <button onclick="showSection('dashboard'); toggleMobileMenu();" class="block w-full text-left py-2 text-gray-700 hover:text-blue-600">Dashboard</button>
            <button onclick="showSection('products'); toggleMobileMenu();" class="block w-full text-left py-2 text-gray-700 hover:text-blue-600">Produk</button>
            <button onclick="showSection('orders'); toggleMobileMenu();" class="block w-full text-left py-2 text-gray-700 hover:text-blue-600">Order</button>
            <button onclick="showSection('sales'); toggleMobileMenu();" class="block w-full text-left py-2 text-gray-700 hover:text-blue-600">Penjualan</button>
            <button onclick="showSection('stock-card'); toggleMobileMenu();" class="block w-full text-left py-2 text-gray-700 hover:text-blue-600">Kartu Stok</button>
            <button onclick="showSection('settings'); toggleMobileMenu();" class="block w-full text-left py-2 text-gray-700 hover:text-blue-600">Pengaturan</button>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section animate-fade-in">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard</h2>
                <p class="text-gray-600">Ringkasan stok dan aktivitas terkini</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total Produk</p>
                            <p class="text-2xl font-bold text-gray-800" id="total-products">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-box text-blue-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Stok Rendah</p>
                            <p class="text-2xl font-bold text-red-600" id="low-stock">0</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Nilai Stok</p>
                            <p class="text-2xl font-bold text-green-600" id="stock-value">Rp 0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-money-bill-wave text-green-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Transaksi Hari Ini</p>
                            <p class="text-2xl font-bold text-purple-600" id="today-transactions">0</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <i class="fas fa-chart-line text-purple-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Aktivitas Terkini</h3>
                <div id="recent-activities" class="space-y-3">
                    <p class="text-gray-500 text-center py-8">Belum ada aktivitas</p>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products-section" class="section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Manajemen Produk</h2>
                    <p class="text-gray-600">Kelola data produk dan stok</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 mt-4 md:mt-0">
                    <button onclick="showAddProductModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Tambah Produk
                    </button>
                    <button onclick="exportData()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-download mr-2"></i>Export Data
                    </button>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="search-products" placeholder="Cari produk..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <select id="category-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Semua Kategori</option>
                    </select>
                </div>
            </div>

            <!-- Products Table -->
            <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HPP</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Jual</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="products-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">Belum ada produk. Klik "Tambah Produk" untuk memulai.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="orders-section" class="section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Manajemen Order</h2>
                    <p class="text-gray-600">Kelola permintaan stok dan approval</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <button onclick="showCreateOrderModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Buat Order
                    </button>
                </div>
            </div>

            <!-- Order Status Tabs -->
            <div class="bg-white rounded-xl card-shadow mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6">
                        <button onclick="filterOrders('all')" class="order-tab-btn py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium">
                            Semua Order
                        </button>
                        <button onclick="filterOrders('pending')" class="order-tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            Menunggu Approval
                        </button>
                        <button onclick="filterOrders('approved')" class="order-tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            Disetujui
                        </button>
                        <button onclick="filterOrders('rejected')" class="order-tab-btn py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            Ditolak
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Order</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada order. Klik "Buat Order" untuk memulai.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sales Section -->
        <div id="sales-section" class="section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Pencatatan Penjualan</h2>
                    <p class="text-gray-600">Kelola transaksi penjualan produk</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 mt-4 md:mt-0">
                    <button onclick="showCreateSaleModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Transaksi Baru
                    </button>
                    <button onclick="exportSalesData()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-download mr-2"></i>Export Penjualan
                    </button>
                </div>
            </div>

            <!-- Sales Filter -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                        <input type="date" id="sales-date-from" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                        <input type="date" id="sales-date-to" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="filterSales()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-filter mr-2"></i>Filter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sales Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total Transaksi</p>
                            <p class="text-2xl font-bold text-gray-800" id="total-sales-count">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-receipt text-blue-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total Penjualan</p>
                            <p class="text-2xl font-bold text-green-600" id="total-sales-amount">Rp 0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-money-bill-wave text-green-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Rata-rata per Transaksi</p>
                            <p class="text-2xl font-bold text-purple-600" id="avg-sales-amount">Rp 0</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <i class="fas fa-chart-bar text-purple-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Table -->
            <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Transaksi</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pembayaran</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="px-6 py-8 text-center text-gray-500">Belum ada transaksi penjualan. Klik "Transaksi Baru" untuk memulai.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Stock Card Section -->
        <div id="stock-card-section" class="section hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Kartu Stok</h2>
                <p class="text-gray-600">Riwayat pergerakan stok per produk</p>
            </div>

            <!-- Product Selection with Search -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-end">
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cari dan Pilih Produk</label>
                        <div class="relative">
                            <input type="text" id="stock-card-search" placeholder="Ketik nama produk atau kode untuk mencari..." 
                                   class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   oninput="searchStockCardProducts()" onkeydown="handleStockCardSearchKeydown(event)">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                        </div>
                        <select id="stock-card-product" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mt-2">
                            <option value="">Pilih produk untuk melihat kartu stok</option>
                        </select>
                        <div id="stock-card-search-results" class="hidden mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg bg-white shadow-lg">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="showStockInModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Stok Masuk
                        </button>
                        <button onclick="showStockOutModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-minus mr-2"></i>Stok Keluar
                        </button>
                        <button onclick="exportStockCard()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-download mr-2"></i>Export Kartu Stok
                        </button>
                    </div>
                </div>
            </div>

            <!-- Product Information -->
            <div id="stock-card-product-info" class="bg-white rounded-xl card-shadow p-6 mb-6 hidden">
                <!-- Product info will be populated here -->
            </div>

            <!-- Stock Card Table -->
            <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Masuk</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keluar</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai Stok</th>
                            </tr>
                        </thead>
                        <tbody id="stock-card-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-6 py-8 text-center text-gray-500">Pilih produk untuk melihat kartu stok</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="section hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Pengaturan</h2>
                <p class="text-gray-600">Konfigurasi aplikasi dan data master</p>
            </div>

            <!-- App Information -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-info-circle mr-2"></i>Informasi Aplikasi
                </h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Nama Aplikasi:</span>
                            <span class="text-gray-900">StokPro</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Versi:</span>
                            <span class="text-gray-900">v25</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Format Kode Produk:</span>
                            <span class="text-gray-900">2 Huruf + 3 Angka</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Kapasitas Kode:</span>
                            <span class="text-gray-900">675,324 produk unik</span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Fitur Import:</span>
                            <span class="text-green-600">✅ Tersedia</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Format Import:</span>
                            <span class="text-gray-900">CSV, Excel</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Backup/Restore:</span>
                            <span class="text-green-600">✅ Tersedia</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Multi-Item Sales:</span>
                            <span class="text-green-600">✅ Tersedia</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-3">
                        <i class="fas fa-file-import mr-2"></i>Panduan Import Database Produk
                    </h4>
                    <p class="text-gray-700 mb-4">Pelajari cara mengimpor data produk ke StokPro dengan format kode baru (2 huruf + 3 angka)</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-white p-3 rounded border-l-4 border-blue-500">
                            <h5 class="font-semibold text-gray-800 mb-1">📋 Format Kode Produk</h5>
                            <p class="text-sm text-gray-600">2 HURUF + 3 ANGKA (contoh: AA001, BC123, XY999)</p>
                        </div>
                        <div class="bg-white p-3 rounded border-l-4 border-green-500">
                            <h5 class="font-semibold text-gray-800 mb-1">📊 Kolom Wajib</h5>
                            <p class="text-sm text-gray-600">Kode, Nama, Kategori, HPP, Harga Jual, Stok, Satuan</p>
                        </div>
                    </div>
                    
                    <button onclick="showImportGuide()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-book-open mr-2"></i>Buka Panduan Lengkap
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Categories Management -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Kategori Produk</h3>
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <input type="text" id="new-category" placeholder="Nama kategori baru" 
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <button onclick="addCategory()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="categories-list" class="space-y-2">
                            <!-- Categories will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Store Settings -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Informasi Toko</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Toko</label>
                            <input type="text" id="store-name" placeholder="Nama toko Anda"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
                            <textarea id="store-address" rows="2" placeholder="Alamat lengkap toko"
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telepon</label>
                            <input type="text" id="store-phone" placeholder="Nomor telepon toko"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="store-email" placeholder="Email toko"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <!-- App Settings -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Pengaturan Aplikasi</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Batas Stok Minimum</label>
                            <input type="number" id="min-stock-limit" value="10" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mata Uang</label>
                            <select id="currency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="IDR">Rupiah (IDR)</option>
                                <option value="USD">Dollar (USD)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Import Database Produk</label>
                            <input type="file" id="import-file" accept=".json,.csv,.xlsx,.xls" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Format: Excel (.xlsx/.xls), CSV, atau JSON dengan kolom: Kode Produk, Nama Produk, Kategori, HPP (Harga Pokok Penjualan), Harga Jual, Stok Saat Ini, Satuan, Deskripsi</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <button onclick="downloadTemplate()" class="bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-lg transition-colors">
                                <i class="fas fa-file-download mr-2"></i>Download Template
                            </button>
                            <button onclick="importDatabase()" class="bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition-colors">
                                <i class="fas fa-upload mr-2"></i>Import Data
                            </button>
                            <button onclick="saveSettings()" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition-colors">
                                <i class="fas fa-save mr-2"></i>Simpan Pengaturan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Backup & Restore -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Backup & Restore Data</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Backup Data Aplikasi</label>
                            <p class="text-sm text-gray-600 mb-3">Download semua data aplikasi sebagai file backup</p>
                            <button onclick="backupData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">
                                <i class="fas fa-download mr-2"></i>Backup Data
                            </button>
                        </div>
                        
                        <div class="border-t pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Restore Data</label>
                            <p class="text-sm text-gray-600 mb-3">Pilih file backup untuk mengembalikan data</p>
                            <input type="file" id="restore-file" accept=".json" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-3">
                            <button onclick="restoreData()" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-lg transition-colors">
                                <i class="fas fa-upload mr-2"></i>Restore Data
                            </button>
                            <p class="text-xs text-red-600 mt-2">⚠️ Restore akan mengganti semua data yang ada!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="product-modal-title" class="text-2xl font-bold text-gray-800">Tambah Produk</h3>
                    <button onclick="closeModal('product-modal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="product-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kode Produk <span class="text-sm text-gray-500">(Format: 2 Huruf + 3 Angka)</span></label>
                            <input type="text" id="product-code" required readonly
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Produk</label>
                            <input type="text" id="product-name" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                        <select id="product-category" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih kategori</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">HPP (Harga Pokok Penjualan)</label>
                            <input type="number" id="product-hpp" required min="0" step="0.01"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Harga Jual</label>
                            <input type="number" id="product-price" required min="0" step="0.01"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stok Awal</label>
                            <input type="number" id="product-initial-stock" required min="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Satuan</label>
                            <input type="text" id="product-unit" required placeholder="pcs, kg, liter, dll"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                        <textarea id="product-description" rows="3" 
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Simpan
                        </button>
                        <button type="button" onclick="closeModal('product-modal')" 
                                class="px-6 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-lg transition-colors">
                            Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Import Guide Modal -->
    <div id="import-guide-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-6xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-file-import mr-2"></i>Panduan Import Database Produk
                    </h3>
                    <button onclick="closeModal('import-guide-modal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="import-guide-content" class="space-y-8">
                    <!-- Introduction -->
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <div class="text-center mb-4">
                            <i class="fas fa-upload text-3xl text-blue-600 mb-3"></i>
                            <h4 class="text-xl font-bold text-gray-800 mb-2">Panduan Lengkap Import Database Produk</h4>
                            <p class="text-gray-600">Pelajari cara mengimpor data produk ke StokPro dengan mudah dan benar</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-3 bg-white rounded-lg">
                                <i class="fas fa-download text-xl text-blue-600 mb-2"></i>
                                <h5 class="font-semibold text-gray-800">1. Download Template</h5>
                                <p class="text-sm text-gray-600">Unduh template Excel/CSV</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg">
                                <i class="fas fa-edit text-xl text-green-600 mb-2"></i>
                                <h5 class="font-semibold text-gray-800">2. Isi Data Produk</h5>
                                <p class="text-sm text-gray-600">Lengkapi informasi produk</p>
                            </div>
                            <div class="text-center p-3 bg-white rounded-lg">
                                <i class="fas fa-upload text-xl text-purple-600 mb-2"></i>
                                <h5 class="font-semibold text-gray-800">3. Upload File</h5>
                                <p class="text-sm text-gray-600">Import ke StokPro</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1: Download Template -->
                    <div class="bg-white border rounded-lg p-6">
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">1</div>
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-2">Download Template Import</h4>
                                <p class="text-gray-600">Langkah pertama adalah mengunduh template yang sudah disediakan</p>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg mb-4">
                            <h5 class="font-semibold text-blue-800 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>Cara Download Template
                            </h5>
                            <ol class="list-decimal list-inside space-y-1 text-gray-700 text-sm">
                                <li>Scroll ke bagian <strong>"Pengaturan Aplikasi"</strong> di halaman ini</li>
                                <li>Klik tombol <strong>"Download Template"</strong> berwarna orange</li>
                                <li>Akan terdownload 2 file:
                                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                        <li><strong>template-info-import-produk-[tanggal].xls</strong> - Berisi panduan lengkap</li>
                                        <li><strong>template-import-produk-[tanggal].csv</strong> - Template siap pakai</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                    </div>

                    <!-- Step 2: Format Data -->
                    <div class="bg-white border rounded-lg p-6">
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="bg-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">2</div>
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-2">Format Data yang Benar</h4>
                                <p class="text-gray-600">Pahami format dan aturan pengisian data produk</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h5 class="font-semibold text-green-800 mb-3">
                                    <i class="fas fa-check-circle mr-2"></i>Kolom Wajib Diisi
                                </h5>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-medium">Kode Produk:</span>
                                        <span class="text-green-700">2 HURUF + 3 ANGKA</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">Nama Produk:</span>
                                        <span class="text-gray-600">Teks</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">Kategori:</span>
                                        <span class="text-gray-600">Teks</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">HPP:</span>
                                        <span class="text-gray-600">Angka</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">Harga Jual:</span>
                                        <span class="text-gray-600">Angka</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">Stok:</span>
                                        <span class="text-gray-600">Angka bulat</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">Satuan:</span>
                                        <span class="text-gray-600">Teks</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-red-50 p-4 rounded-lg">
                                <h5 class="font-semibold text-red-800 mb-3">
                                    <i class="fas fa-exclamation-circle mr-2"></i>Aturan Kode Produk
                                </h5>
                                <div class="space-y-3">
                                    <div>
                                        <p class="font-semibold text-green-700 text-sm mb-1">✅ Format BENAR:</p>
                                        <div class="space-y-1 text-xs">
                                            <div class="bg-green-100 p-1 rounded">AA001 - 2 huruf + 3 angka</div>
                                            <div class="bg-green-100 p-1 rounded">BC123 - Huruf kapital</div>
                                            <div class="bg-green-100 p-1 rounded">XY999 - Angka 3 digit</div>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-red-700 text-sm mb-1">❌ Format SALAH:</p>
                                        <div class="space-y-1 text-xs">
                                            <div class="bg-red-100 p-1 rounded">A001 - Hanya 1 huruf</div>
                                            <div class="bg-red-100 p-1 rounded">ABC01 - 3 huruf</div>
                                            <div class="bg-red-100 p-1 rounded">aa001 - Huruf kecil</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Example Data -->
                    <div class="bg-white border rounded-lg p-6">
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="bg-purple-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">3</div>
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-2">Contoh Data Produk</h4>
                                <p class="text-gray-600">Lihat contoh pengisian data yang benar</p>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-gray-300 p-2 text-left">Kode Produk</th>
                                        <th class="border border-gray-300 p-2 text-left">Nama Produk</th>
                                        <th class="border border-gray-300 p-2 text-left">Kategori</th>
                                        <th class="border border-gray-300 p-2 text-left">HPP</th>
                                        <th class="border border-gray-300 p-2 text-left">Harga Jual</th>
                                        <th class="border border-gray-300 p-2 text-left">Stok</th>
                                        <th class="border border-gray-300 p-2 text-left">Satuan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border border-gray-300 p-2 font-mono">EL001</td>
                                        <td class="border border-gray-300 p-2">Smartphone Android 128GB</td>
                                        <td class="border border-gray-300 p-2">Elektronik</td>
                                        <td class="border border-gray-300 p-2">2500000</td>
                                        <td class="border border-gray-300 p-2">3200000</td>
                                        <td class="border border-gray-300 p-2">25</td>
                                        <td class="border border-gray-300 p-2">unit</td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 p-2 font-mono">MK001</td>
                                        <td class="border border-gray-300 p-2">Beras Premium 5kg</td>
                                        <td class="border border-gray-300 p-2">Makanan</td>
                                        <td class="border border-gray-300 p-2">45000</td>
                                        <td class="border border-gray-300 p-2">58000</td>
                                        <td class="border border-gray-300 p-2">100</td>
                                        <td class="border border-gray-300 p-2">karung</td>
                                    </tr>
                                    <tr>
                                        <td class="border border-gray-300 p-2 font-mono">MN001</td>
                                        <td class="border border-gray-300 p-2">Air Mineral 600ml</td>
                                        <td class="border border-gray-300 p-2">Minuman</td>
                                        <td class="border border-gray-300 p-2">2500</td>
                                        <td class="border border-gray-300 p-2">3500</td>
                                        <td class="border border-gray-300 p-2">500</td>
                                        <td class="border border-gray-300 p-2">botol</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
                            <h5 class="font-semibold text-yellow-800 mb-2">
                                <i class="fas fa-lightbulb mr-2"></i>Tips Pengisian Data
                            </h5>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                                <li><strong>HPP dan Harga Jual:</strong> Tulis angka tanpa titik, koma, atau simbol Rp</li>
                                <li><strong>Stok:</strong> Hanya angka bulat (tidak boleh desimal)</li>
                                <li><strong>Kode Produk:</strong> Harus unik, tidak boleh ada yang sama</li>
                                <li><strong>Kategori:</strong> Jika kategori belum ada, akan otomatis ditambahkan</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Step 4: Upload Process -->
                    <div class="bg-white border rounded-lg p-6">
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="bg-orange-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">4</div>
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-2">Upload dan Import Data</h4>
                                <p class="text-gray-600">Langkah terakhir untuk mengimpor data ke StokPro</p>
                            </div>
                        </div>

                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-purple-800 mb-3">
                                <i class="fas fa-upload mr-2"></i>Cara Upload File
                            </h5>
                            <ol class="list-decimal list-inside space-y-1 text-sm text-gray-700">
                                <li>Scroll ke bagian <strong>"Pengaturan Aplikasi"</strong> di halaman ini</li>
                                <li>Di bagian <strong>"Import Database Produk"</strong>, klik <strong>Choose File</strong></li>
                                <li>Pilih file CSV yang sudah Anda edit</li>
                                <li>Klik tombol <strong>"Import Data"</strong> berwarna ungu</li>
                                <li>Tunggu proses import selesai</li>
                                <li>Lihat hasil import di popup yang muncul</li>
                            </ol>
                        </div>
                    </div>

                    <!-- FAQ -->
                    <div class="bg-white border rounded-lg p-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-question-circle mr-2"></i>Frequently Asked Questions (FAQ)
                        </h4>

                        <div class="space-y-4">
                            <div class="border-b pb-3">
                                <h5 class="font-semibold text-gray-800 mb-1">Q: Berapa maksimal produk yang bisa diimport sekaligus?</h5>
                                <p class="text-sm text-gray-700">A: Tidak ada batasan khusus, namun disarankan maksimal 100-200 produk per import untuk performa optimal.</p>
                            </div>

                            <div class="border-b pb-3">
                                <h5 class="font-semibold text-gray-800 mb-1">Q: Apakah data yang sudah ada akan tertimpa saat import?</h5>
                                <p class="text-sm text-gray-700">A: Tidak. Produk dengan kode yang sudah ada akan dilewati (skip). Hanya produk dengan kode baru yang akan ditambahkan.</p>
                            </div>

                            <div class="border-b pb-3">
                                <h5 class="font-semibold text-gray-800 mb-1">Q: Bagaimana cara membuat kode produk yang sistematis?</h5>
                                <p class="text-sm text-gray-700">A: Gunakan 2 huruf pertama untuk kategori (EL=Elektronik, MK=Makanan, MN=Minuman) dan 3 angka berurutan (001, 002, 003).</p>
                            </div>

                            <div>
                                <h5 class="font-semibold text-gray-800 mb-1">Q: Apa yang terjadi jika ada error saat import?</h5>
                                <p class="text-sm text-gray-700">A: Sistem akan menampilkan detail error dengan nomor baris yang bermasalah. Data yang valid tetap akan diimport, hanya baris error yang dilewati.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-6 border-t">
                    <button onclick="closeModal('import-guide-modal')" 
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-lg transition-colors">
                        Tutup Panduan
                    </button>
                    <button onclick="downloadTemplate(); closeModal('import-guide-modal');" 
                            class="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-lg transition-colors">
                        <i class="fas fa-download mr-2"></i>Download Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Sale Modal -->
    <div id="sale-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-7xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-shopping-cart mr-2 text-blue-600"></i>Transaksi Penjualan Baru - Version 25
                    </h3>
                    <button onclick="closeSaleModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Side - Product Selection -->
                    <div class="space-y-4">
                        <!-- Transaction Info -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-3">
                                <i class="fas fa-file-invoice mr-2"></i>Informasi Transaksi
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">No. Transaksi</label>
                                    <input type="text" id="transaction-number" readonly
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 font-mono">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                    <input type="date" id="transaction-date" required
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Customer</label>
                                <input type="text" id="customer-name" placeholder="Nama customer (opsional)"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <!-- Enhanced Product Search and Selection -->
                        <div class="bg-white border-2 border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">
                                <i class="fas fa-search mr-2 text-green-600"></i>Cari dan Pilih Produk
                            </h4>
                            
                            <!-- Enhanced Product Search -->
                            <div class="relative mb-4">
                                <input type="text" id="sale-product-search" placeholder="🔍 Ketik nama produk, kode, atau kategori untuk mencari..." 
                                       class="w-full px-4 py-3 pr-12 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm"
                                       oninput="searchSaleProducts()" onkeydown="handleSaleSearchKeydown(event)">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400 text-lg"></i>
                                </div>
                                <div class="absolute top-full left-0 right-0 mt-1 text-xs text-gray-500 px-2">
                                    Minimal 2 karakter • Enter untuk pilih • Esc untuk tutup
                                </div>
                            </div>
                            
                            <!-- Enhanced Search Results -->
                            <div id="sale-product-search-results" class="hidden max-h-80 overflow-y-auto border-2 border-gray-200 rounded-lg bg-white shadow-xl mb-4 z-10">
                                <!-- Search results will appear here -->
                            </div>
                            
                            <!-- Enhanced Selected Product Info -->
                            <div id="sale-selected-product-info" class="hidden mb-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg">
                                <!-- Selected product info will appear here -->
                            </div>
                            
                            <!-- Enhanced Quantity and Price Input -->
                            <div id="sale-quantity-price-section" class="hidden space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-sort-numeric-up mr-1"></i>Jumlah
                                        </label>
                                        <input type="number" id="sale-quantity" min="1" placeholder="Masukkan jumlah"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-center font-semibold"
                                               onchange="calculateItemTotal()" oninput="calculateItemTotal()">
                                        <div class="mt-1 text-xs">
                                            <span id="sale-quantity-info">Stok tersedia akan ditampilkan di sini</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-money-bill-wave mr-1"></i>Harga Satuan
                                        </label>
                                        <input type="number" id="sale-price" min="0" step="0.01" placeholder="0"
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-right font-semibold"
                                               onchange="calculateItemTotal()" oninput="calculateItemTotal()">
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                                    <span class="font-medium text-gray-700">
                                        <i class="fas fa-calculator mr-2 text-blue-600"></i>Subtotal Item:
                                    </span>
                                    <span id="item-subtotal" class="text-xl font-bold text-blue-600">Rp 0</span>
                                </div>
                                
                                <button type="button" onclick="addToCart()" 
                                        class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white py-3 rounded-lg transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105">
                                    <i class="fas fa-cart-plus mr-2"></i>Tambah ke Keranjang
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side - Enhanced Shopping Cart -->
                    <div class="space-y-4">
                        <!-- Enhanced Shopping Cart -->
                        <div class="bg-white border-2 border-orange-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-gray-800">
                                    <i class="fas fa-shopping-cart mr-2 text-orange-600"></i>Keranjang Belanja
                                </h4>
                                <button onclick="clearCart()" class="text-red-600 hover:text-red-800 text-sm px-3 py-1 border border-red-300 rounded-lg hover:bg-red-50 transition-colors">
                                    <i class="fas fa-trash mr-1"></i>Kosongkan
                                </button>
                            </div>
                            
                            <div id="shopping-cart" class="space-y-3 mb-4 max-h-80 overflow-y-auto">
                                <div class="text-center text-gray-500 py-12">
                                    <i class="fas fa-shopping-cart text-4xl mb-3 text-gray-300"></i>
                                    <p class="font-medium">Keranjang masih kosong</p>
                                    <p class="text-sm mt-1">Cari dan pilih produk untuk ditambahkan</p>
                                    <div class="mt-4 text-xs text-gray-400">
                                        <p>💡 Tips: Gunakan pencarian untuk menemukan produk dengan cepat</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Enhanced Cart Summary -->
                            <div class="border-t-2 border-gray-200 pt-4 space-y-3">
                                <div class="flex justify-between text-sm font-medium">
                                    <span><i class="fas fa-boxes mr-1 text-blue-600"></i>Total Item:</span>
                                    <span id="cart-total-items" class="font-bold">0</span>
                                </div>
                                <div class="flex justify-between text-sm font-medium">
                                    <span><i class="fas fa-sort-numeric-up mr-1 text-green-600"></i>Total Quantity:</span>
                                    <span id="cart-total-quantity" class="font-bold">0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Subtotal:</span>
                                    <span id="cart-subtotal" class="font-semibold">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Pajak:</span>
                                    <span id="cart-tax-amount" class="font-semibold">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Diskon:</span>
                                    <span>Rp 0</span>
                                </div>
                                <div class="flex justify-between text-xl font-bold border-t-2 border-gray-300 pt-3 bg-gradient-to-r from-blue-50 to-indigo-50 px-3 py-2 rounded-lg">
                                    <span><i class="fas fa-money-check-alt mr-2 text-blue-600"></i>TOTAL:</span>
                                    <span id="cart-grand-total" class="text-blue-600">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm bg-green-50 px-3 py-2 rounded-lg border border-green-200">
                                    <span><i class="fas fa-money-bill-wave mr-1 text-green-600"></i>Dibayar:</span>
                                    <span id="cart-payment-amount" class="font-semibold text-green-600">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm bg-orange-50 px-3 py-2 rounded-lg border border-orange-200">
                                    <span><i class="fas fa-coins mr-1 text-orange-600"></i>Kembalian:</span>
                                    <span id="cart-change-amount" class="font-semibold text-orange-600">Rp 0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Payment Info -->
                        <div class="bg-white border-2 border-purple-200 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">
                                <i class="fas fa-credit-card mr-2 text-purple-600"></i>Informasi Pembayaran
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Metode Pembayaran</label>
                                    <select id="payment-method" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="Tunai">💵 Tunai</option>
                                        <option value="Transfer Bank">🏦 Transfer Bank</option>
                                        <option value="Kartu Kredit">💳 Kartu Kredit</option>
                                        <option value="E-Wallet">📱 E-Wallet</option>
                                        <option value="QRIS">📱 QRIS</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status Transaksi</label>
                                    <select id="transaction-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="Completed">✅ Selesai</option>
                                        <option value="Pending">⏳ Pending</option>
                                        <option value="Cancelled">❌ Dibatalkan</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Payment Amount and Tax -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nominal Dibayar</label>
                                    <input type="number" id="payment-amount" min="0" step="0.01" placeholder="0"
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                           oninput="calculateChange()">
                                    <div class="mt-1 text-xs text-gray-500">
                                        <span id="change-amount">Kembalian akan dihitung otomatis</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Pengaturan Pajak</label>
                                    <div class="flex items-center space-x-3">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox" id="apply-tax" class="mr-2 rounded focus:ring-2 focus:ring-purple-500" onchange="calculateTaxAndTotal()">
                                            <span class="text-sm">Kenakan Pajak</span>
                                        </label>
                                        <input type="number" id="tax-percentage" value="11" min="0" max="100" step="0.1" disabled
                                               class="w-20 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500"
                                               oninput="calculateTaxAndTotal()">
                                        <span class="text-sm text-gray-600">%</span>
                                    </div>
                                    <div class="mt-1 text-xs text-gray-500">
                                        <span id="tax-amount-display">Pajak: Rp 0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Transaksi</label>
                                <textarea id="transaction-notes" rows="3" placeholder="Catatan tambahan untuk transaksi ini (opsional)"
                                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                            </div>
                        </div>

                        <!-- Enhanced Action Buttons -->
                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-2 border-gray-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <button onclick="processSale()" id="process-sale-btn" disabled
                                        class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 disabled:from-gray-400 disabled:to-gray-500 text-white py-3 rounded-lg transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 disabled:transform-none disabled:shadow-none">
                                    <i class="fas fa-save mr-2"></i>Proses Transaksi
                                </button>
                                <button onclick="processSaleAndPrint()" id="process-print-btn" disabled
                                        class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 disabled:from-gray-400 disabled:to-gray-500 text-white py-3 rounded-lg transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 disabled:transform-none disabled:shadow-none">
                                    <i class="fas fa-print mr-2"></i>Proses & Print Struk
                                </button>
                            </div>
                            <button onclick="closeSaleModal()" 
                                    class="w-full mt-3 bg-gradient-to-r from-gray-300 to-gray-400 hover:from-gray-400 hover:to-gray-500 text-gray-700 py-2 rounded-lg transition-all duration-200 font-medium">
                                <i class="fas fa-times mr-2"></i>Tutup & Batal
                            </button>
                            
                            <!-- Quick Stats -->
                            <div class="mt-4 p-3 bg-white rounded-lg border border-gray-200">
                                <div class="text-xs text-gray-600 text-center">
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <div class="font-semibold text-blue-600" id="quick-total-items">0</div>
                                            <div>Items</div>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-green-600" id="quick-total-qty">0</div>
                                            <div>Quantity</div>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-purple-600" id="quick-total-value">Rp 0</div>
                                            <div>Value</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Order Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Buat Order Baru</h3>
                    <button onclick="closeModal('order-modal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="order-form" class="space-y-4">
                    <!-- Order Info -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">No. Order</label>
                                <input type="text" id="order-number" readonly
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Order</label>
                                <input type="date" id="order-date" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Product Selection with Search -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cari dan Pilih Produk</label>
                            <div class="relative">
                                <input type="text" id="order-product-search" placeholder="Ketik nama produk atau kode untuk mencari..." 
                                       class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       oninput="searchOrderProducts()" onkeydown="handleOrderSearchKeydown(event)">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                            </div>
                            <select id="order-product" required onchange="updateOrderProductInfo()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mt-2">
                                <option value="">Pilih produk untuk order</option>
                            </select>
                            <div id="order-product-search-results" class="hidden mt-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg bg-white shadow-lg">
                                <!-- Search results will appear here -->
                            </div>
                            <div id="order-product-info" class="mt-2 text-sm text-gray-600 hidden">
                                <!-- Product info will be shown here -->
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Order</label>
                            <input type="number" id="order-quantity" required min="1" placeholder="Masukkan jumlah yang dibutuhkan"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <div class="mt-1 text-xs text-gray-500">
                                <span id="order-quantity-info">Pilih produk terlebih dahulu</span>
                            </div>
                        </div>
                    </div>

                    <!-- Order Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Diminta oleh</label>
                            <input type="text" id="requested-by" placeholder="Nama peminta"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Supplier</label>
                            <input type="text" id="supplier" placeholder="Nama supplier (opsional)"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Estimasi Biaya</label>
                            <input type="number" id="estimated-cost" min="0" step="0.01" placeholder="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="order-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="pending">Menunggu Approval</option>
                                <option value="approved">Disetujui</option>
                                <option value="rejected">Ditolak</option>
                                <option value="completed">Selesai</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                        <textarea id="order-notes" rows="3" placeholder="Catatan tambahan untuk order ini"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div class="flex gap-3 pt-4 border-t">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg transition-colors font-semibold">
                            <i class="fas fa-save mr-2"></i>Buat Order
                        </button>
                        <button type="button" onclick="closeModal('order-modal')" 
                                class="px-6 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg transition-colors">
                            Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Other existing modals would continue here... -->

    <script>
        // Data Storage
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || ['Elektronik', 'Makanan', 'Minuman', 'Pakaian'];
        let stockMovements = JSON.parse(localStorage.getItem('stockMovements')) || [];
        let orders = JSON.parse(localStorage.getItem('orders')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let settings = JSON.parse(localStorage.getItem('settings')) || { minStockLimit: 10, currency: 'IDR' };
        let editingProductId = null;
        let currentOrderFilter = 'all';
        let filteredSales = [];

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Only trigger shortcuts when not typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }
                
                // Ctrl/Cmd + key shortcuts
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            showSection('dashboard');
                            break;
                        case '2':
                            e.preventDefault();
                            showSection('products');
                            break;
                        case '3':
                            e.preventDefault();
                            showSection('orders');
                            break;
                        case '4':
                            e.preventDefault();
                            showSection('sales');
                            break;
                        case '5':
                            e.preventDefault();
                            showSection('stock-card');
                            break;
                        case '6':
                            e.preventDefault();
                            showSection('settings');
                            break;
                        case 'n':
                            e.preventDefault();
                            // Quick add product
                            if (document.getElementById('products-section').classList.contains('hidden') === false) {
                                showAddProductModal();
                            }
                            break;
                        case 's':
                            e.preventDefault();
                            // Quick save - trigger form submit if modal is open
                            const openModal = document.querySelector('.fixed.flex:not(.hidden)');
                            if (openModal) {
                                const form = openModal.querySelector('form');
                                if (form) {
                                    form.dispatchEvent(new Event('submit'));
                                }
                            }
                            break;
                    }
                }
                
                // ESC key to close modals
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.fixed.flex:not(.hidden)');
                    if (openModal) {
                        const modalId = openModal.id;
                        if (modalId === 'sale-modal') {
                            closeSaleModal();
                        } else {
                            closeModal(modalId);
                        }
                    }
                }
            });
        });

        function initializeApp() {
            try {
                console.log('Initializing StokPro v25...');
                
                // Initialize data displays with error handling
                try {
                    updateDashboard();
                } catch (error) {
                    console.error('Error updating dashboard:', error);
                }
                
                try {
                    renderProducts();
                } catch (error) {
                    console.error('Error rendering products:', error);
                }
                
                try {
                    renderCategories();
                } catch (error) {
                    console.error('Error rendering categories:', error);
                }
                
                try {
                    renderOrders();
                } catch (error) {
                    console.error('Error rendering orders:', error);
                }
                
                try {
                    renderSales();
                } catch (error) {
                    console.error('Error rendering sales:', error);
                }
                
                try {
                    populateProductSelects();
                } catch (error) {
                    console.error('Error populating product selects:', error);
                }
                
                try {
                    loadSettings();
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
                
                // Add event listeners with error handling
                try {
                    const searchProducts = document.getElementById('search-products');
                    if (searchProducts) {
                        searchProducts.addEventListener('input', filterProducts);
                    }
                    
                    const categoryFilter = document.getElementById('category-filter');
                    if (categoryFilter) {
                        categoryFilter.addEventListener('change', filterProducts);
                    }
                    
                    const stockCardProduct = document.getElementById('stock-card-product');
                    if (stockCardProduct) {
                        stockCardProduct.addEventListener('change', loadStockCard);
                    }
                    
                    // Form submissions
                    const productForm = document.getElementById('product-form');
                    if (productForm) {
                        productForm.addEventListener('submit', handleProductSubmit);
                    }
                    
                    const saleForm = document.getElementById('sale-form');
                    if (saleForm) {
                        saleForm.addEventListener('submit', handleSaleSubmit);
                    }
                    
                    const orderForm = document.getElementById('order-form');
                    if (orderForm) {
                        orderForm.addEventListener('submit', handleOrderSubmit);
                    }
                } catch (error) {
                    console.error('Error adding event listeners:', error);
                }
                
                // Set default dates
                try {
                    setDefaultDates();
                } catch (error) {
                    console.error('Error setting default dates:', error);
                }
                
                // Show dashboard by default
                try {
                    showSection('dashboard');
                } catch (error) {
                    console.error('Error showing dashboard:', error);
                }
                
                console.log('StokPro v25 initialized successfully');
                
                // Show initialization success message
                setTimeout(() => {
                    console.log('✅ All functions loaded and ready to use');
                }, 1000);
                
            } catch (error) {
                console.error('Critical error initializing app:', error);
                alert('Terjadi kesalahan kritis saat memuat aplikasi. Silakan refresh halaman atau hubungi administrator.');
            }
        }

        // Navigation
        function showSection(sectionName) {
            try {
                // Hide all sections
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                // Show selected section
                const targetSection = document.getElementById(sectionName + '-section');
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                } else {
                    console.error(`Section ${sectionName}-section not found`);
                    return;
                }
                
                // Update nav buttons - reset all first
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('text-blue-200');
                    btn.classList.add('hover:text-blue-200');
                });
                
                // Find and highlight the active button based on section name
                const navButtons = document.querySelectorAll('.nav-btn');
                navButtons.forEach(btn => {
                    const btnText = btn.textContent.toLowerCase();
                    if ((sectionName === 'dashboard' && btnText.includes('dashboard')) ||
                        (sectionName === 'products' && btnText.includes('produk')) ||
                        (sectionName === 'orders' && btnText.includes('order')) ||
                        (sectionName === 'sales' && btnText.includes('penjualan')) ||
                        (sectionName === 'stock-card' && btnText.includes('kartu stok')) ||
                        (sectionName === 'settings' && btnText.includes('pengaturan'))) {
                        btn.classList.add('text-blue-200');
                        btn.classList.remove('hover:text-blue-200');
                    }
                });
                
                // Close mobile menu
                const mobileMenu = document.getElementById('mobile-menu');
                if (mobileMenu) {
                    mobileMenu.classList.add('hidden');
                }
                
                // Refresh data for specific sections with error handling
                try {
                    if (sectionName === 'dashboard') {
                        updateDashboard();
                    } else if (sectionName === 'products') {
                        renderProducts();
                        populateFilters();
                    } else if (sectionName === 'orders') {
                        renderOrders();
                        populateOrderProductSelect();
                    } else if (sectionName === 'sales') {
                        renderSales();
                        populateSaleProductSelect();
                    } else if (sectionName === 'stock-card') {
                        populateStockCardProducts();
                        loadStockCard();
                    } else if (sectionName === 'settings') {
                        renderCategories();
                        loadSettings();
                    }
                } catch (error) {
                    console.error(`Error refreshing ${sectionName} section:`, error);
                }
                
            } catch (error) {
                console.error('Error in showSection:', error);
                alert('Terjadi kesalahan saat membuka menu. Silakan refresh halaman.');
            }
        }

        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu) {
                mobileMenu.classList.toggle('hidden');
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            const totalProducts = products.length;
            const lowStockProducts = products.filter(p => p.currentStock <= settings.minStockLimit).length;
            const stockValue = products.reduce((total, p) => total + (p.currentStock * p.hpp), 0);
            const todayTransactions = stockMovements.filter(m => 
                new Date(m.date).toDateString() === new Date().toDateString()
            ).length;

            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('low-stock').textContent = lowStockProducts;
            document.getElementById('stock-value').textContent = formatCurrency(stockValue);
            document.getElementById('today-transactions').textContent = todayTransactions;

            renderRecentActivities();
        }

        function renderRecentActivities() {
            const recentActivities = stockMovements
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            const container = document.getElementById('recent-activities');
            
            if (recentActivities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada aktivitas</p>';
                return;
            }

            container.innerHTML = recentActivities.map(activity => {
                const product = products.find(p => p.id === activity.productId);
                const productName = product ? product.name : 'Produk tidak ditemukan';
                const icon = activity.type === 'in' ? 'fa-plus text-green-600' : 'fa-minus text-red-600';
                const typeText = activity.type === 'in' ? 'Masuk' : 'Keluar';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <i class="fas ${icon}"></i>
                            <div>
                                <p class="font-medium text-gray-800">${productName}</p>
                                <p class="text-sm text-gray-600">${activity.note || typeText}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-medium text-gray-800">${activity.quantity} ${product?.unit || ''}</p>
                            <p class="text-sm text-gray-500">${formatDate(activity.date)}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Product Management
        function renderProducts() {
            const tbody = document.getElementById('products-table');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">Belum ada produk. Klik "Tambah Produk" untuk memulai.</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => {
                const stockStatus = product.currentStock <= settings.minStockLimit ? 
                    '<span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full">Stok Rendah</span>' :
                    '<span class="px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full">Normal</span>';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div>
                                <div class="font-medium text-gray-900">${product.name}</div>
                                <div class="text-sm text-gray-500">${product.code}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${product.category}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${formatCurrency(product.hpp)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${formatCurrency(product.price)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${product.currentStock} ${product.unit}</td>
                        <td class="px-6 py-4">${stockStatus}</td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewProduct('${product.id}')" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editProduct('${product.id}')" class="text-yellow-600 hover:text-yellow-900">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            populateFilters();
        }

        function populateFilters() {
            try {
                const categoryFilter = document.getElementById('category-filter');
                if (!categoryFilter) return;
                
                const uniqueCategories = [...new Set(products.map(p => p.category))];
                
                categoryFilter.innerHTML = '<option value="">Semua Kategori</option>' +
                    uniqueCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            } catch (error) {
                console.error('Error in populateFilters:', error);
            }
        }

        function filterProducts() {
            const searchTerm = document.getElementById('search-products').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            
            const filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                    product.code.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            renderFilteredProducts(filteredProducts);
        }

        function renderFilteredProducts(filteredProducts) {
            const tbody = document.getElementById('products-table');
            
            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">Tidak ada produk yang sesuai dengan filter.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredProducts.map(product => {
                const stockStatus = product.currentStock <= settings.minStockLimit ? 
                    '<span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full">Stok Rendah</span>' :
                    '<span class="px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full">Normal</span>';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div>
                                <div class="font-medium text-gray-900">${product.name}</div>
                                <div class="text-sm text-gray-500">${product.code}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${product.category}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${formatCurrency(product.hpp)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${formatCurrency(product.price)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${product.currentStock} ${product.unit}</td>
                        <td class="px-6 py-4">${stockStatus}</td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewProduct('${product.id}')" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editProduct('${product.id}')" class="text-yellow-600 hover:text-yellow-900">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Product CRUD Operations
        function showAddProductModal() {
            editingProductId = null;
            document.getElementById('product-modal-title').textContent = 'Tambah Produk';
            document.getElementById('product-form').reset();
            
            // Reset product code field to readonly for new products
            const codeInput = document.getElementById('product-code');
            codeInput.setAttribute('readonly', 'readonly');
            codeInput.className = 'w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed';
            
            // Generate automatic product code with 2 letters + 3 digits format
            const generateNextProductCode = () => {
                const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const existingCodes = products.map(p => p.code);
                
                // Generate all possible combinations starting from AA001
                for (let i = 0; i < letters.length; i++) {
                    for (let j = 0; j < letters.length; j++) {
                        const letterPart = letters[i] + letters[j];
                        
                        // Find next available number for this letter combination
                        const codesWithSameLetters = existingCodes
                            .filter(code => code.startsWith(letterPart))
                            .map(code => {
                                const numberPart = code.substring(2);
                                return /^\d{3}$/.test(numberPart) ? parseInt(numberPart) : 0;
                            })
                            .sort((a, b) => a - b);
                        
                        let nextNumber = 1;
                        for (const num of codesWithSameLetters) {
                            if (num === nextNumber) {
                                nextNumber++;
                            } else {
                                break;
                            }
                        }
                        
                        // If we found an available number, return the code
                        if (nextNumber <= 999) {
                            return letterPart + nextNumber.toString().padStart(3, '0');
                        }
                    }
                }
                
                // Fallback if all combinations are exhausted (very unlikely)
                return 'ZZ999';
            };
            
            const autoCode = generateNextProductCode();
            document.getElementById('product-code').value = autoCode;
            
            populateProductCategories();
            showModal('product-modal');
        }

        function editProduct(productId) {
            editingProductId = productId;
            const product = products.find(p => p.id === productId);
            
            document.getElementById('product-modal-title').textContent = 'Edit Produk';
            document.getElementById('product-code').value = product.code;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-hpp').value = product.hpp;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-initial-stock').value = product.currentStock;
            document.getElementById('product-unit').value = product.unit;
            document.getElementById('product-description').value = product.description || '';
            
            // Enable product code editing for existing products
            const codeInput = document.getElementById('product-code');
            codeInput.removeAttribute('readonly');
            codeInput.className = 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500';
            
            populateProductCategories();
            showModal('product-modal');
        }

        function viewProduct(productId) {
            const product = products.find(p => p.id === productId);
            alert(`Detail Produk:\n\nKode: ${product.code}\nNama: ${product.name}\nKategori: ${product.category}\nHPP: ${formatCurrency(product.hpp)}\nHarga Jual: ${formatCurrency(product.price)}\nStok: ${product.currentStock} ${product.unit}\nDeskripsi: ${product.description || 'Tidak ada deskripsi'}`);
        }

        function deleteProduct(productId) {
            if (confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
                products = products.filter(p => p.id !== productId);
                stockMovements = stockMovements.filter(m => m.productId !== productId);
                saveData();
                renderProducts();
                updateDashboard();
                populateProductSelects();
                alert('Produk berhasil dihapus!');
            }
        }

        function handleProductSubmit(e) {
            e.preventDefault();
            
            const productData = {
                code: document.getElementById('product-code').value.trim(),
                name: document.getElementById('product-name').value,
                category: document.getElementById('product-category').value,
                hpp: parseFloat(document.getElementById('product-hpp').value),
                price: parseFloat(document.getElementById('product-price').value),
                currentStock: parseInt(document.getElementById('product-initial-stock').value),
                unit: document.getElementById('product-unit').value,
                description: document.getElementById('product-description').value
            };

            // Validate product code format (2 letters + 3 digits)
            const codePattern = /^[A-Z]{2}\d{3}$/;
            if (!codePattern.test(productData.code)) {
                alert(`Format kode produk tidak valid!\n\nKode produk harus berformat: 2 huruf + 3 angka\nContoh: AA001, BC123, XY999\n\nKode yang dimasukkan: "${productData.code}"`);
                return;
            }

            // Check for duplicate product code (only for new products or when code is changed)
            const existingProduct = products.find(p => p.code === productData.code && p.id !== editingProductId);
            if (existingProduct) {
                alert(`Kode produk "${productData.code}" sudah digunakan!\n\nSilakan gunakan kode produk yang berbeda atau biarkan sistem generate otomatis.`);
                return;
            }

            if (editingProductId) {
                // Update existing product
                const productIndex = products.findIndex(p => p.id === editingProductId);
                const oldProduct = { ...products[productIndex] };
                
                // Update product data while preserving id and createdAt
                products[productIndex] = { 
                    ...oldProduct,
                    ...productData,
                    updatedAt: new Date().toISOString()
                };
                
                // Check if stock changed and add movement record
                const stockDifference = productData.currentStock - oldProduct.currentStock;
                if (stockDifference !== 0) {
                    const movement = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        productId: editingProductId,
                        type: stockDifference > 0 ? 'in' : 'out',
                        quantity: Math.abs(stockDifference),
                        date: new Date().toISOString(),
                        note: `Edit produk - ${stockDifference > 0 ? 'penambahan' : 'pengurangan'} stok`
                    };
                    stockMovements.push(movement);
                }
                
                alert('Produk berhasil diperbarui!');
            } else {
                // Add new product
                const newProduct = {
                    id: Date.now().toString(),
                    ...productData,
                    createdAt: new Date().toISOString()
                };
                products.push(newProduct);
                
                // Add initial stock movement
                if (newProduct.currentStock > 0) {
                    stockMovements.push({
                        id: Date.now().toString(),
                        productId: newProduct.id,
                        type: 'in',
                        quantity: newProduct.currentStock,
                        date: new Date().toISOString(),
                        note: 'Stok awal'
                    });
                }
                alert('Produk berhasil ditambahkan!');
            }

            saveData();
            closeModal('product-modal');
            renderProducts();
            updateDashboard();
            populateProductSelects();
            loadStockCard(); // Refresh stock card if currently viewing
        }

        // Settings Functions
        function renderCategories() {
            const container = document.getElementById('categories-list');
            container.innerHTML = categories.map(category => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-800">${category}</span>
                    <button onclick="deleteCategory('${category}')" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function addCategory() {
            const newCategory = document.getElementById('new-category').value.trim();
            if (newCategory && !categories.includes(newCategory)) {
                categories.push(newCategory);
                saveData();
                renderCategories();
                populateProductCategories();
                document.getElementById('new-category').value = '';
                alert('Kategori berhasil ditambahkan!');
            } else if (categories.includes(newCategory)) {
                alert('Kategori sudah ada!');
            }
        }

        function deleteCategory(category) {
            if (confirm('Apakah Anda yakin ingin menghapus kategori ini?')) {
                categories = categories.filter(c => c !== category);
                saveData();
                renderCategories();
                populateProductCategories();
                alert('Kategori berhasil dihapus!');
            }
        }

        function loadSettings() {
            document.getElementById('min-stock-limit').value = settings.minStockLimit;
            document.getElementById('currency').value = settings.currency;
            document.getElementById('store-name').value = settings.storeName || 'StokPro Store';
            document.getElementById('store-address').value = settings.storeAddress || 'Jl. Contoh No. 123, Kota';
            document.getElementById('store-phone').value = settings.storePhone || '021-12345678';
            document.getElementById('store-email').value = settings.storeEmail || 'info@stokpro.com';
        }

        function saveSettings() {
            settings.minStockLimit = parseInt(document.getElementById('min-stock-limit').value);
            settings.currency = document.getElementById('currency').value;
            settings.storeName = document.getElementById('store-name').value;
            settings.storeAddress = document.getElementById('store-address').value;
            settings.storePhone = document.getElementById('store-phone').value;
            settings.storeEmail = document.getElementById('store-email').value;
            saveData();
            updateDashboard();
            renderProducts();
            alert('Pengaturan berhasil disimpan!');
        }

        // Import Guide Function
        function showImportGuide() {
            showModal('import-guide-modal');
        }

        // Utility Functions
        function populateProductCategories() {
            const select = document.getElementById('product-category');
            if (select) {
                select.innerHTML = '<option value="">Pilih kategori</option>' +
                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            }
        }

        function populateProductSelects() {
            try {
                // Populate sale product select
                const saleSelect = document.getElementById('sale-product');
                if (saleSelect) {
                    try {
                        populateSaleProductSelect();
                    } catch (error) {
                        console.error('Error populating sale product select:', error);
                    }
                }
                
                // Populate order product select
                const orderSelect = document.getElementById('order-product');
                if (orderSelect) {
                    try {
                        populateOrderProductSelect();
                    } catch (error) {
                        console.error('Error populating order product select:', error);
                    }
                }
                
                // Populate stock card product select
                const stockCardSelect = document.getElementById('stock-card-product');
                if (stockCardSelect) {
                    try {
                        populateStockCardProducts();
                    } catch (error) {
                        console.error('Error populating stock card product select:', error);
                    }
                }
            } catch (error) {
                console.error('Error in populateProductSelects:', error);
            }
        }

        function setDefaultDates() {
            const now = new Date();
            const dateString = now.toISOString().slice(0, 10);
            
            // Set default dates for sales filter if elements exist
            const salesDateFrom = document.getElementById('sales-date-from');
            const salesDateTo = document.getElementById('sales-date-to');
            if (salesDateFrom) salesDateFrom.value = dateString;
            if (salesDateTo) salesDateTo.value = dateString;
            
            // Set default date for transaction forms
            const transactionDate = document.getElementById('transaction-date');
            if (transactionDate) transactionDate.value = dateString;
            
            const orderDate = document.getElementById('order-date');
            if (orderDate) orderDate.value = dateString;
        }

        function showModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    
                    // Focus on first input if available
                    const firstInput = modal.querySelector('input:not([readonly]), select, textarea');
                    if (firstInput) {
                        setTimeout(() => firstInput.focus(), 100);
                    }
                } else {
                    console.error(`Modal ${modalId} not found`);
                }
            } catch (error) {
                console.error('Error showing modal:', error);
            }
        }

        function closeModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    
                    // Clear any form data if it's a form modal
                    const form = modal.querySelector('form');
                    if (form && modalId !== 'sale-modal') { // Don't auto-clear sale modal
                        form.reset();
                    }
                } else {
                    console.error(`Modal ${modalId} not found`);
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        function formatCurrency(amount) {
            const currency = settings.currency === 'USD' ? '$' : 'Rp ';
            return currency + amount.toLocaleString('id-ID');
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function saveData() {
            try {
                // Check if localStorage is available
                if (typeof(Storage) === "undefined") {
                    throw new Error('LocalStorage tidak didukung oleh browser ini');
                }
                
                // Save each data type with individual error handling
                try {
                    localStorage.setItem('products', JSON.stringify(products || []));
                } catch (error) {
                    console.error('Error saving products:', error);
                    throw new Error('Gagal menyimpan data produk');
                }
                
                try {
                    localStorage.setItem('categories', JSON.stringify(categories || []));
                } catch (error) {
                    console.error('Error saving categories:', error);
                    throw new Error('Gagal menyimpan data kategori');
                }
                
                try {
                    localStorage.setItem('stockMovements', JSON.stringify(stockMovements || []));
                } catch (error) {
                    console.error('Error saving stock movements:', error);
                    throw new Error('Gagal menyimpan data pergerakan stok');
                }
                
                try {
                    localStorage.setItem('orders', JSON.stringify(orders || []));
                } catch (error) {
                    console.error('Error saving orders:', error);
                    throw new Error('Gagal menyimpan data order');
                }
                
                try {
                    localStorage.setItem('sales', JSON.stringify(sales || []));
                } catch (error) {
                    console.error('Error saving sales:', error);
                    throw new Error('Gagal menyimpan data penjualan');
                }
                
                try {
                    localStorage.setItem('settings', JSON.stringify(settings || {}));
                } catch (error) {
                    console.error('Error saving settings:', error);
                    throw new Error('Gagal menyimpan pengaturan');
                }
                
                console.log('✅ Data berhasil disimpan ke localStorage');
                
            } catch (error) {
                console.error('Critical error saving data:', error);
                
                // Show user-friendly error message
                let errorMsg = '❌ GAGAL MENYIMPAN DATA!\n\n';
                errorMsg += `Error: ${error.message}\n\n`;
                errorMsg += '💡 SOLUSI:\n';
                errorMsg += '• Pastikan browser mendukung localStorage\n';
                errorMsg += '• Bersihkan cache dan cookies browser\n';
                errorMsg += '• Pastikan storage tidak penuh\n';
                errorMsg += '• Coba refresh halaman dan ulangi\n';
                errorMsg += '• Backup data sebelum melanjutkan';
                
                alert(errorMsg);
                throw error; // Re-throw to prevent further operations
            }
        }

        // Download Template Function
        function downloadTemplate() {
            try {
                // Create CSV template with headers and sample data
                const csvHeaders = [
                    'Kode Produk',
                    'Nama Produk', 
                    'Kategori',
                    'HPP',
                    'Harga Jual',
                    'Stok',
                    'Satuan',
                    'Deskripsi'
                ];

                const sampleData = [
                    ['EL001', 'Smartphone Android 128GB', 'Elektronik', '2500000', '3200000', '25', 'unit', 'Smartphone dengan RAM 8GB dan storage 128GB'],
                    ['MK001', 'Beras Premium 5kg', 'Makanan', '45000', '58000', '100', 'karung', 'Beras premium kualitas terbaik'],
                    ['MN001', 'Air Mineral 600ml', 'Minuman', '2500', '3500', '500', 'botol', 'Air mineral dalam kemasan botol 600ml'],
                    ['PK001', 'Kaos Cotton Combed', 'Pakaian', '35000', '55000', '50', 'pcs', 'Kaos berbahan cotton combed berkualitas'],
                    ['OB001', 'Vitamin C 1000mg', 'Obat & Kesehatan', '15000', '25000', '200', 'strip', 'Suplemen vitamin C untuk daya tahan tubuh']
                ];

                // Create CSV content
                const csvContent = [
                    csvHeaders.join(','),
                    ...sampleData.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                // Create and download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                const today = new Date().toISOString().slice(0, 10);
                link.setAttribute('download', `template-import-produk-${today}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Also create info file with detailed instructions
                const infoContent = `PANDUAN IMPORT DATABASE PRODUK STOKPRO v25
==============================================

FORMAT KODE PRODUK BARU: 2 HURUF + 3 ANGKA
Contoh: AA001, BC123, XY999

KOLOM WAJIB:
1. Kode Produk - Format: 2 huruf kapital + 3 angka (contoh: EL001)
2. Nama Produk - Nama lengkap produk
3. Kategori - Kategori produk (akan otomatis ditambahkan jika belum ada)
4. HPP - Harga Pokok Penjualan (angka tanpa titik/koma)
5. Harga Jual - Harga jual produk (angka tanpa titik/koma)
6. Stok - Jumlah stok awal (angka bulat)
7. Satuan - Satuan produk (pcs, kg, liter, dll)
8. Deskripsi - Deskripsi produk (opsional)

ATURAN PENTING:
- Kode produk harus unik (tidak boleh sama)
- Format kode: 2 HURUF KAPITAL + 3 ANGKA
- HPP dan Harga Jual hanya angka (tanpa Rp, titik, koma)
- Stok hanya angka bulat positif
- Jika kategori belum ada, akan otomatis ditambahkan

CONTOH DATA YANG BENAR:
EL001,"Smartphone Android 128GB","Elektronik","2500000","3200000","25","unit","Smartphone dengan RAM 8GB"
MK001,"Beras Premium 5kg","Makanan","45000","58000","100","karung","Beras premium kualitas terbaik"

CARA IMPORT:
1. Edit file CSV template yang sudah didownload
2. Isi data produk sesuai format
3. Simpan file dalam format CSV
4. Upload melalui menu Pengaturan > Import Database Produk
5. Klik tombol "Import Data"

CATATAN:
- Maksimal 1000 produk per import
- Produk dengan kode yang sudah ada akan dilewati
- Sistem akan menampilkan laporan hasil import

Tanggal: ${new Date().toLocaleDateString('id-ID')}
StokPro v25 - Sistem Manajemen Stok Produk`;

                // Download info file
                const infoBlob = new Blob([infoContent], { type: 'text/plain;charset=utf-8;' });
                const infoLink = document.createElement('a');
                const infoUrl = URL.createObjectURL(infoBlob);
                infoLink.setAttribute('href', infoUrl);
                infoLink.setAttribute('download', `panduan-import-produk-${today}.txt`);
                infoLink.style.visibility = 'hidden';
                document.body.appendChild(infoLink);
                infoLink.click();
                document.body.removeChild(infoLink);

                alert('✅ Template berhasil didownload!\n\n📁 File yang didownload:\n1. template-import-produk-' + today + '.csv\n2. panduan-import-produk-' + today + '.txt\n\n📋 Silakan edit file CSV dan ikuti panduan di file TXT untuk import data produk.');

            } catch (error) {
                console.error('Error downloading template:', error);
                alert('❌ Gagal mendownload template. Silakan coba lagi.');
            }
        }

        // Import Database Function
        function importDatabase() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('❌ Silakan pilih file untuk diimport terlebih dahulu!');
                return;
            }

            // Check file type
            const allowedTypes = ['.csv', '.xlsx', '.xls', '.json'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(fileExtension)) {
                alert('❌ Format file tidak didukung!\n\nFormat yang didukung: CSV, Excel (.xlsx/.xls), JSON\n\nFile yang dipilih: ' + file.name);
                return;
            }

            // Show loading
            const originalText = event.target.innerHTML;
            event.target.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengimport...';
            event.target.disabled = true;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let importData = [];
                    
                    if (fileExtension === '.json') {
                        // Handle JSON file
                        const jsonData = JSON.parse(e.target.result);
                        importData = Array.isArray(jsonData) ? jsonData : [jsonData];
                    } else if (fileExtension === '.csv') {
                        // Handle CSV file
                        const csvText = e.target.result;
                        const lines = csvText.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            throw new Error('File CSV kosong atau tidak valid');
                        }

                        // Parse CSV headers
                        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                        
                        // Validate required headers
                        const requiredHeaders = ['Kode Produk', 'Nama Produk', 'Kategori', 'HPP', 'Harga Jual', 'Stok', 'Satuan'];
                        const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                        
                        if (missingHeaders.length > 0) {
                            throw new Error(`Header yang hilang: ${missingHeaders.join(', ')}\n\nHeader yang ditemukan: ${headers.join(', ')}`);
                        }

                        // Parse CSV data
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                            
                            if (values.length >= requiredHeaders.length) {
                                const rowData = {};
                                headers.forEach((header, index) => {
                                    rowData[header] = values[index] || '';
                                });
                                importData.push(rowData);
                            }
                        }
                    } else {
                        throw new Error('Format Excel belum didukung. Silakan gunakan format CSV atau JSON.');
                    }

                    // Process import data
                    processImportData(importData);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert('❌ Gagal mengimport data!\n\nError: ' + error.message + '\n\n💡 Tips:\n- Pastikan format file sesuai template\n- Periksa format kode produk (2 huruf + 3 angka)\n- Pastikan semua kolom wajib terisi');
                } finally {
                    // Reset button
                    event.target.innerHTML = originalText;
                    event.target.disabled = false;
                    fileInput.value = '';
                }
            };

            reader.onerror = function() {
                alert('❌ Gagal membaca file. Silakan coba lagi.');
                event.target.innerHTML = originalText;
                event.target.disabled = false;
            };

            // Read file based on type
            if (fileExtension === '.json' || fileExtension === '.csv') {
                reader.readAsText(file);
            } else {
                alert('❌ Format Excel belum didukung dalam versi ini.\n\n💡 Silakan convert file Excel ke CSV terlebih dahulu atau gunakan template CSV yang disediakan.');
                event.target.innerHTML = originalText;
                event.target.disabled = false;
            }
        }

        // Process Import Data
        function processImportData(importData) {
            let successCount = 0;
            let skipCount = 0;
            let errorCount = 0;
            const errors = [];
            const newCategories = [];

            importData.forEach((row, index) => {
                try {
                    const rowNumber = index + 2; // +2 because index starts at 0 and we skip header
                    
                    // Validate required fields
                    const code = row['Kode Produk']?.toString().trim().toUpperCase();
                    const name = row['Nama Produk']?.toString().trim();
                    const category = row['Kategori']?.toString().trim();
                    const hpp = parseFloat(row['HPP']?.toString().replace(/[^\d.]/g, ''));
                    const price = parseFloat(row['Harga Jual']?.toString().replace(/[^\d.]/g, ''));
                    const stock = parseInt(row['Stok']?.toString().replace(/[^\d]/g, ''));
                    const unit = row['Satuan']?.toString().trim();
                    const description = row['Deskripsi']?.toString().trim() || '';

                    // Validate product code format
                    const codePattern = /^[A-Z]{2}\d{3}$/;
                    if (!code || !codePattern.test(code)) {
                        throw new Error(`Format kode produk tidak valid: "${code}". Harus 2 huruf + 3 angka (contoh: AA001)`);
                    }

                    // Check for required fields
                    if (!name) throw new Error('Nama produk tidak boleh kosong');
                    if (!category) throw new Error('Kategori tidak boleh kosong');
                    if (isNaN(hpp) || hpp < 0) throw new Error(`HPP tidak valid: "${row['HPP']}"`);
                    if (isNaN(price) || price < 0) throw new Error(`Harga jual tidak valid: "${row['Harga Jual']}"`);
                    if (isNaN(stock) || stock < 0) throw new Error(`Stok tidak valid: "${row['Stok']}"`);
                    if (!unit) throw new Error('Satuan tidak boleh kosong');

                    // Check if product code already exists
                    const existingProduct = products.find(p => p.code === code);
                    if (existingProduct) {
                        skipCount++;
                        return; // Skip this product
                    }

                    // Add new category if not exists
                    if (!categories.includes(category)) {
                        categories.push(category);
                        newCategories.push(category);
                    }

                    // Create new product
                    const newProduct = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        code: code,
                        name: name,
                        category: category,
                        hpp: hpp,
                        price: price,
                        currentStock: stock,
                        unit: unit,
                        description: description,
                        createdAt: new Date().toISOString()
                    };

                    products.push(newProduct);

                    // Add initial stock movement
                    if (stock > 0) {
                        stockMovements.push({
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                            productId: newProduct.id,
                            type: 'in',
                            quantity: stock,
                            date: new Date().toISOString(),
                            note: 'Import data - stok awal'
                        });
                    }

                    successCount++;

                } catch (error) {
                    errorCount++;
                    errors.push(`Baris ${rowNumber}: ${error.message}`);
                }
            });

            // Save data
            saveData();
            
            // Update UI
            renderProducts();
            renderCategories();
            updateDashboard();
            populateProductSelects();

            // Show import results
            let resultMessage = `📊 HASIL IMPORT DATABASE PRODUK\n\n`;
            resultMessage += `✅ Berhasil diimport: ${successCount} produk\n`;
            resultMessage += `⏭️ Dilewati (kode sudah ada): ${skipCount} produk\n`;
            resultMessage += `❌ Error: ${errorCount} produk\n`;
            
            if (newCategories.length > 0) {
                resultMessage += `\n📁 Kategori baru ditambahkan: ${newCategories.join(', ')}\n`;
            }

            if (errors.length > 0) {
                resultMessage += `\n❌ DETAIL ERROR:\n${errors.slice(0, 10).join('\n')}`;
                if (errors.length > 10) {
                    resultMessage += `\n... dan ${errors.length - 10} error lainnya`;
                }
            }

            resultMessage += `\n\n💡 Tips: Produk yang error dapat diperbaiki dan diimport ulang.`;

            alert(resultMessage);
        }

        // Backup Data Function
        function backupData() {
            try {
                // Collect all application data
                const backupData = {
                    version: '25',
                    timestamp: new Date().toISOString(),
                    data: {
                        products: products,
                        categories: categories,
                        stockMovements: stockMovements,
                        orders: orders,
                        sales: sales,
                        settings: settings
                    },
                    metadata: {
                        totalProducts: products.length,
                        totalCategories: categories.length,
                        totalStockMovements: stockMovements.length,
                        totalOrders: orders.length,
                        totalSales: sales.length,
                        backupDate: new Date().toLocaleDateString('id-ID'),
                        backupTime: new Date().toLocaleTimeString('id-ID')
                    }
                };

                // Convert to JSON string
                const jsonString = JSON.stringify(backupData, null, 2);
                
                // Create blob and download
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                link.href = url;
                link.download = `stokpro-backup-${timestamp}.json`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                alert(`✅ Backup berhasil dibuat!\n\n📁 File: stokpro-backup-${timestamp}.json\n\n📊 Data yang di-backup:\n• ${products.length} Produk\n• ${categories.length} Kategori\n• ${stockMovements.length} Pergerakan Stok\n• ${orders.length} Order\n• ${sales.length} Penjualan\n• Pengaturan Aplikasi\n\n💾 Simpan file backup di tempat yang aman!`);
                
            } catch (error) {
                console.error('Backup error:', error);
                alert('❌ Gagal membuat backup!\n\nError: ' + error.message + '\n\nSilakan coba lagi.');
            }
        }

        // Restore Data Function
        function restoreData() {
            const fileInput = document.getElementById('restore-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('❌ Silakan pilih file backup terlebih dahulu!');
                return;
            }

            // Validate file type
            if (!file.name.toLowerCase().endsWith('.json')) {
                alert('❌ File harus berformat JSON!\n\nPilih file backup yang berakhiran .json');
                return;
            }

            // Confirm restore action
            const confirmRestore = confirm('⚠️ PERINGATAN!\n\nRestore akan mengganti SEMUA data yang ada dengan data dari file backup.\n\nData saat ini akan hilang dan tidak dapat dikembalikan!\n\nApakah Anda yakin ingin melanjutkan?');
            
            if (!confirmRestore) {
                return;
            }

            // Show loading
            const restoreButton = event.target;
            const originalText = restoreButton.innerHTML;
            restoreButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memulihkan Data...';
            restoreButton.disabled = true;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Support both v25 format (direct data) and v2.8+ format (nested data)
                    let dataToRestore;
                    let detectedVersion = 'Unknown';
                    
                    // Enhanced version detection and data extraction
                    if (Array.isArray(backupData.products) || Array.isArray(backupData.categories) || 
                               Array.isArray(backupData.stockMovements) || Array.isArray(backupData.sales)) {
                        // v25 format - direct data structure (current format)
                        dataToRestore = backupData;
                        detectedVersion = backupData.version || 'v25';
                    } else if (backupData.version && backupData.data && typeof backupData.data === 'object') {
                        // v2.8+ format with nested data (legacy support)
                        dataToRestore = backupData.data;
                        detectedVersion = backupData.version;
                    } else {
                        throw new Error('Format file backup tidak dikenali atau tidak valid');
                    }
                    
                    // Enhanced data validation and migration for v25 compatibility
                    console.log('Detected version:', detectedVersion);
                    console.log('Raw backup data:', backupData);
                    console.log('Data to restore:', dataToRestore);
                    
                    // Initialize arrays if they don't exist
                    if (!Array.isArray(dataToRestore.products)) {
                        dataToRestore.products = [];
                    }
                    if (!Array.isArray(dataToRestore.categories)) {
                        dataToRestore.categories = ['Elektronik', 'Makanan', 'Minuman', 'Pakaian'];
                    }
                    if (!Array.isArray(dataToRestore.stockMovements)) {
                        dataToRestore.stockMovements = [];
                    }
                    if (!Array.isArray(dataToRestore.orders)) {
                        dataToRestore.orders = [];
                    }
                    
                    // Initialize sales array if it doesn't exist
                    if (!Array.isArray(dataToRestore.sales)) {
                        dataToRestore.sales = [];
                    }
                    
                    if (!dataToRestore.settings || typeof dataToRestore.settings !== 'object') {
                        dataToRestore.settings = { minStockLimit: 10, currency: 'IDR' };
                    }

                    // Enhanced data migration for products (ensure all required fields)
                    dataToRestore.products = dataToRestore.products.map(product => ({
                        id: product.id || (Date.now().toString() + Math.random().toString(36).substr(2, 9)),
                        code: product.code || product.productCode || '',
                        name: product.name || product.productName || '',
                        category: product.category || 'Umum',
                        hpp: parseFloat(product.hpp) || 0,
                        price: parseFloat(product.price) || parseFloat(product.sellPrice) || 0,
                        currentStock: parseInt(product.currentStock) || parseInt(product.stock) || 0,
                        unit: product.unit || 'pcs',
                        description: product.description || '',
                        createdAt: product.createdAt || new Date().toISOString(),
                        updatedAt: product.updatedAt || null
                    }));

                    // Enhanced sales data migration with proper total calculation
                    dataToRestore.sales = dataToRestore.sales.map(sale => {
                        const migratedSale = {
                            id: sale.id || (Date.now().toString() + Math.random().toString(36).substr(2, 9)),
                            transactionNumber: sale.transactionNumber || sale.transactionId || `TRX${Date.now()}`,
                            date: sale.date || sale.createdAt || new Date().toISOString(),
                            customerName: sale.customerName || sale.customer || null,
                            paymentMethod: sale.paymentMethod || 'Tunai',
                            status: sale.status || 'Completed',
                            notes: sale.notes || sale.note || null,
                            createdAt: sale.createdAt || sale.date || new Date().toISOString(),
                            updatedAt: sale.updatedAt || null
                        };
                        
                        // Handle items array - migrate from v25 format if needed
                        if (sale.items && Array.isArray(sale.items)) {
                            migratedSale.items = sale.items.map(item => ({
                                productId: item.productId || item.product_id,
                                price: parseFloat(item.price) || 0,
                                quantity: parseInt(item.quantity) || 1
                            }));
                        } else if (sale.productId) {
                            // Single item format from v25
                            migratedSale.items = [{
                                productId: sale.productId,
                                price: parseFloat(sale.price) || 0,
                                quantity: parseInt(sale.quantity) || 1
                            }];
                        } else {
                            migratedSale.items = [];
                        }
                        
                        // Calculate total from items or use existing total
                        if (migratedSale.items.length > 0) {
                            migratedSale.total = migratedSale.items.reduce((sum, item) => {
                                return sum + (item.price * item.quantity);
                            }, 0);
                        } else {
                            migratedSale.total = parseFloat(sale.total) || 0;
                        }
                        
                        return migratedSale;
                    });

                    // Enhanced data migration for stock movements
                    dataToRestore.stockMovements = dataToRestore.stockMovements.map(movement => ({
                        id: movement.id || (Date.now().toString() + Math.random().toString(36).substr(2, 9)),
                        productId: movement.productId || movement.product_id,
                        type: movement.type || 'in',
                        quantity: parseInt(movement.quantity) || 0,
                        date: movement.date || movement.createdAt || new Date().toISOString(),
                        note: movement.note || movement.notes || movement.description || '',
                        salePrice: movement.salePrice || null,
                        profit: movement.profit || null,
                        transactionId: movement.transactionId || null
                    }));

                    // Enhanced data migration for orders
                    dataToRestore.orders = dataToRestore.orders.map(order => ({
                        id: order.id || (Date.now().toString() + Math.random().toString(36).substr(2, 9)),
                        orderNumber: order.orderNumber || order.orderNo || `ORD${Date.now()}`,
                        date: order.date || order.orderDate || new Date().toISOString(),
                        productId: order.productId || order.product_id,
                        quantity: parseInt(order.quantity) || 0,
                        status: order.status || 'pending',
                        notes: order.notes || order.note || null,
                        requestedBy: order.requestedBy || order.requester || '',
                        supplier: order.supplier || null,
                        estimatedCost: parseFloat(order.estimatedCost) || 0,
                        createdAt: order.createdAt || order.date || new Date().toISOString(),
                        updatedAt: order.updatedAt || null,
                        approvedBy: order.approvedBy || null,
                        approvedAt: order.approvedAt || null,
                        rejectedBy: order.rejectedBy || null,
                        rejectedAt: order.rejectedAt || null,
                        rejectionReason: order.rejectionReason || null,
                        completedAt: order.completedAt || null,
                        stockAdded: order.stockAdded || false,
                        actualCost: order.actualCost || null
                    }));

                    console.log('Migrated data:', {
                        products: dataToRestore.products.length,
                        sales: dataToRestore.sales.length,
                        stockMovements: dataToRestore.stockMovements.length,
                        orders: dataToRestore.orders.length,
                        categories: dataToRestore.categories.length
                    });

                    // Restore data with enhanced v25 compatibility
                    products = dataToRestore.products;
                    categories = dataToRestore.categories;
                    stockMovements = dataToRestore.stockMovements;
                    orders = dataToRestore.orders;
                    sales = dataToRestore.sales;
                    settings = { ...settings, ...dataToRestore.settings };

                    // Clear any existing filtered data
                    filteredSales = [];

                    // Save restored data to localStorage
                    saveData();
                    
                    // Force update all UI components
                    renderProducts();
                    renderCategories();
                    renderOrders();
                    renderSales(); // Explicitly render sales
                    updateDashboard();
                    populateProductSelects();
                    loadSettings();
                    
                    // Reset any active filters
                    currentOrderFilter = 'all';
                    
                    // Show enhanced success message
                    const metadata = backupData.metadata || {};
                    
                    let successMessage = `✅ DATA BERHASIL DIPULIHKAN!\n\n`;
                    successMessage += `📱 Format Backup: ${detectedVersion}\n`;
                    
                    if (metadata.backupDate) {
                        successMessage += `📅 Tanggal Backup: ${metadata.backupDate}\n`;
                    }
                    if (metadata.backupTime) {
                        successMessage += `⏰ Waktu Backup: ${metadata.backupTime}\n`;
                    }
                    
                    successMessage += `\n📊 DATA YANG DIPULIHKAN:\n`;
                    successMessage += `• ${products.length} Produk\n`;
                    successMessage += `• ${categories.length} Kategori\n`;
                    successMessage += `• ${stockMovements.length} Pergerakan Stok\n`;
                    successMessage += `• ${orders.length} Order\n`;
                    successMessage += `• ${sales.length} Transaksi Penjualan\n`;
                    successMessage += `• Pengaturan Aplikasi\n`;
                    
                    if (detectedVersion !== 'v25' && detectedVersion !== '25') {
                        successMessage += `\n🔄 MIGRASI DATA:\n`;
                        successMessage += `• Data ${detectedVersion} berhasil dimigrasikan ke v25\n`;
                        successMessage += `• Semua transaksi penjualan telah dikonversi\n`;
                        successMessage += `• Struktur data telah diperbarui\n`;
                    }
                    
                    successMessage += `\n✅ VERIFIKASI:\n`;
                    successMessage += `• Cek menu Dashboard untuk ringkasan\n`;
                    successMessage += `• Cek menu Penjualan untuk transaksi\n`;
                    successMessage += `• Cek menu Produk untuk stok\n`;
                    successMessage += `• Semua data siap digunakan\n`;
                    
                    successMessage += `\n🔄 Halaman akan dimuat ulang dalam 2 detik...`;
                    
                    alert(successMessage);
                    
                    // Reload page to ensure all components are fully updated
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Restore error:', error);
                    console.error('Backup data structure:', backupData);
                    
                    let errorMsg = `❌ GAGAL MEMULIHKAN DATA!\n\n`;
                    errorMsg += `Error: ${error.message}\n\n`;
                    errorMsg += `💡 TROUBLESHOOTING:\n`;
                    errorMsg += `• Pastikan file adalah backup StokPro yang valid\n`;
                    errorMsg += `• File backup v25 dan versi lainnya didukung\n`;
                    errorMsg += `• Periksa apakah file tidak rusak atau corrupt\n`;
                    errorMsg += `• Coba gunakan file backup yang lain\n`;
                    errorMsg += `• Pastikan file berformat JSON yang benar\n\n`;
                    errorMsg += `🔍 DETAIL TEKNIS:\n`;
                    errorMsg += `• File size: ${(file.size / 1024).toFixed(2)} KB\n`;
                    errorMsg += `• File name: ${file.name}\n`;
                    errorMsg += `• Error type: ${error.name || 'Unknown'}\n`;
                    
                    alert(errorMsg);
                } finally {
                    // Reset button state
                    restoreButton.innerHTML = originalText;
                    restoreButton.disabled = false;
                    fileInput.value = '';
                }
            };

            reader.onerror = function() {
                alert('❌ Gagal membaca file backup!\n\nFile mungkin rusak atau tidak dapat dibaca.\nSilakan coba lagi atau gunakan file backup yang lain.');
                restoreButton.innerHTML = originalText;
                restoreButton.disabled = false;
                fileInput.value = '';
            };

            reader.readAsText(file);
        }

        // Export Data Functions
        function exportData() {
            try {
                if (products.length === 0) {
                    alert('❌ Tidak ada data produk untuk diekspor!');
                    return;
                }

                // Create CSV headers
                const headers = [
                    'Kode Produk',
                    'Nama Produk',
                    'Kategori',
                    'HPP',
                    'Harga Jual',
                    'Stok Saat Ini',
                    'Satuan',
                    'Nilai Stok (HPP)',
                    'Nilai Stok (Jual)',
                    'Status Stok',
                    'Deskripsi',
                    'Tanggal Dibuat'
                ];

                // Create CSV data
                const csvData = products.map(product => {
                    const stockValue = product.currentStock * product.hpp;
                    const sellValue = product.currentStock * product.price;
                    const stockStatus = product.currentStock <= settings.minStockLimit ? 'Stok Rendah' : 'Normal';
                    
                    return [
                        product.code,
                        product.name,
                        product.category,
                        product.hpp,
                        product.price,
                        product.currentStock,
                        product.unit,
                        stockValue,
                        sellValue,
                        stockStatus,
                        product.description || '',
                        formatDateForExport(product.createdAt)
                    ];
                });

                // Create CSV content with BOM for proper Excel opening
                const csvContent = '\uFEFF' + [
                    headers.map(h => `"${h}"`).join(','),
                    ...csvData.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\r\n');

                // Download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                const timestamp = new Date().toISOString().slice(0, 10);
                link.setAttribute('download', `data-produk-${timestamp}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                alert(`✅ Data produk berhasil diekspor!\n\n📁 File: data-produk-${timestamp}.csv\n📊 Total: ${products.length} produk\n\n💡 File dapat dibuka dengan Excel atau aplikasi spreadsheet lainnya.`);

            } catch (error) {
                console.error('Export error:', error);
                alert('❌ Gagal mengekspor data produk. Silakan coba lagi.');
            }
        }

        function exportSalesData() {
            try {
                if (sales.length === 0) {
                    alert('❌ Tidak ada data penjualan untuk diekspor!');
                    return;
                }

                // Create CSV headers
                const headers = [
                    'No. Transaksi',
                    'Tanggal',
                    'Waktu',
                    'Customer',
                    'Kode Produk',
                    'Nama Produk',
                    'Kategori',
                    'Harga Satuan',
                    'Jumlah',
                    'Satuan',
                    'Subtotal',
                    'Metode Pembayaran',
                    'Status',
                    'Total Transaksi',
                    'Keuntungan',
                    'Catatan'
                ];

                // Create CSV data - flatten sales with items
                const csvData = [];
                sales.forEach(sale => {
                    if (sale.items && sale.items.length > 0) {
                        sale.items.forEach((item, index) => {
                            const product = products.find(p => p.id === item.productId);
                            const profit = product ? (item.price - product.hpp) * item.quantity : 0;
                            
                            csvData.push([
                                sale.transactionNumber,
                                formatDateForExport(sale.date, 'date'),
                                formatDateForExport(sale.date, 'time'),
                                sale.customerName || 'Walk-in Customer',
                                product ? product.code : 'N/A',
                                product ? product.name : 'Produk tidak ditemukan',
                                product ? product.category : 'N/A',
                                item.price,
                                item.quantity,
                                product ? product.unit : 'pcs',
                                item.price * item.quantity,
                                sale.paymentMethod || 'Tunai',
                                sale.status || 'Completed',
                                index === 0 ? sale.total : '', // Only show total on first item
                                profit,
                                sale.notes || ''
                            ]);
                        });
                    } else {
                        // Handle sales without items (legacy format)
                        csvData.push([
                            sale.transactionNumber,
                            formatDateForExport(sale.date, 'date'),
                            formatDateForExport(sale.date, 'time'),
                            sale.customerName || 'Walk-in Customer',
                            '',
                            '',
                            '',
                            '',
                            '',
                            '',
                            '',
                            sale.paymentMethod || 'Tunai',
                            sale.status || 'Completed',
                            sale.total || 0,
                            '',
                            sale.notes || ''
                        ]);
                    }
                });

                // Create CSV content with BOM
                const csvContent = '\uFEFF' + [
                    headers.map(h => `"${h}"`).join(','),
                    ...csvData.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\r\n');

                // Download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                const timestamp = new Date().toISOString().slice(0, 10);
                link.setAttribute('download', `data-penjualan-${timestamp}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                const totalAmount = sales.reduce((sum, sale) => sum + (sale.total || 0), 0);
                alert(`✅ Data penjualan berhasil diekspor!\n\n📁 File: data-penjualan-${timestamp}.csv\n📊 Total: ${sales.length} transaksi\n💰 Total Penjualan: ${formatCurrency(totalAmount)}\n\n💡 File dapat dibuka dengan Excel atau aplikasi spreadsheet lainnya.`);

            } catch (error) {
                console.error('Export sales error:', error);
                alert('❌ Gagal mengekspor data penjualan. Silakan coba lagi.');
            }
        }

        function exportStockCard() {
            try {
                const selectedProductId = document.getElementById('stock-card-product').value;
                
                if (!selectedProductId) {
                    alert('❌ Silakan pilih produk terlebih dahulu untuk mengekspor kartu stok!');
                    return;
                }

                const product = products.find(p => p.id === selectedProductId);
                if (!product) {
                    alert('❌ Produk tidak ditemukan!');
                    return;
                }

                // Get stock movements for selected product
                const productMovements = stockMovements
                    .filter(m => m.productId === selectedProductId)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                if (productMovements.length === 0) {
                    alert('❌ Tidak ada data pergerakan stok untuk produk ini!');
                    return;
                }

                // Create CSV headers
                const headers = [
                    'Tanggal',
                    'Waktu',
                    'Keterangan',
                    'Masuk',
                    'Keluar',
                    'Saldo',
                    'HPP Satuan',
                    'Nilai Stok',
                    'Jenis Transaksi'
                ];

                // Calculate running balance and create CSV data
                let runningBalance = 0;
                const csvData = [];

                // Add initial stock entry if exists
                const initialMovement = productMovements.find(m => m.note === 'Stok awal');
                if (initialMovement) {
                    runningBalance = initialMovement.quantity;
                    csvData.push([
                        formatDateForExport(initialMovement.date, 'date'),
                        formatDateForExport(initialMovement.date, 'time'),
                        'Stok Awal',
                        initialMovement.quantity,
                        0,
                        runningBalance,
                        product.hpp,
                        runningBalance * product.hpp,
                        'Stok Masuk'
                    ]);
                }

                // Add other movements
                productMovements.forEach(movement => {
                    if (movement.note === 'Stok awal') return; // Skip initial stock as it's already added

                    if (movement.type === 'in') {
                        runningBalance += movement.quantity;
                    } else {
                        runningBalance -= movement.quantity;
                    }

                    csvData.push([
                        formatDateForExport(movement.date, 'date'),
                        formatDateForExport(movement.date, 'time'),
                        movement.note || (movement.type === 'in' ? 'Stok Masuk' : 'Stok Keluar'),
                        movement.type === 'in' ? movement.quantity : 0,
                        movement.type === 'out' ? movement.quantity : 0,
                        runningBalance,
                        product.hpp,
                        runningBalance * product.hpp,
                        movement.type === 'in' ? 'Stok Masuk' : 'Stok Keluar'
                    ]);
                });

                // Create header information
                const headerInfo = [
                    ['KARTU STOK PRODUK'],
                    [''],
                    ['Kode Produk:', product.code],
                    ['Nama Produk:', product.name],
                    ['Kategori:', product.category],
                    ['Satuan:', product.unit],
                    ['HPP:', formatCurrency(product.hpp)],
                    ['Harga Jual:', formatCurrency(product.price)],
                    ['Stok Saat Ini:', `${product.currentStock} ${product.unit}`],
                    ['Tanggal Export:', new Date().toLocaleDateString('id-ID')],
                    [''],
                    ['RIWAYAT PERGERAKAN STOK:'],
                    ['']
                ];

                // Combine header info with data
                const csvContent = '\uFEFF' + [
                    ...headerInfo.map(row => row.map(cell => `"${cell}"`).join(',')),
                    headers.map(h => `"${h}"`).join(','),
                    ...csvData.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\r\n');

                // Download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `kartu-stok-${product.code}-${timestamp}.csv`;
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                alert(`✅ Kartu stok berhasil diekspor!\n\n📁 File: ${filename}\n📦 Produk: ${product.name} (${product.code})\n📊 Total Transaksi: ${productMovements.length}\n💰 Nilai Stok Saat Ini: ${formatCurrency(product.currentStock * product.hpp)}\n\n💡 File dapat dibuka dengan Excel atau aplikasi spreadsheet lainnya.`);

            } catch (error) {
                console.error('Export stock card error:', error);
                alert('❌ Gagal mengekspor kartu stok. Silakan coba lagi.');
            }
        }

        // Helper function for date formatting in exports
        function formatDateForExport(dateString, type = 'full') {
            const date = new Date(dateString);
            
            if (type === 'date') {
                return date.toLocaleDateString('id-ID');
            } else if (type === 'time') {
                return date.toLocaleTimeString('id-ID');
            } else {
                return date.toLocaleDateString('id-ID') + ' ' + date.toLocaleTimeString('id-ID');
            }
        }

        // Sales Management Functions
        let editingSaleId = null;
        let shoppingCart = [];
        let selectedProduct = null;

        function renderSales() {
            const tbody = document.getElementById('sales-table');
            
            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500">Belum ada transaksi penjualan. Klik "Transaksi Baru" untuk memulai.</td></tr>';
                updateSalesSummary();
                return;
            }

            tbody.innerHTML = sales.map(sale => {
                const itemCount = sale.items ? sale.items.length : 1; // Default to 1 for single item sales
                const statusBadge = getStatusBadge(sale.status);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${sale.transactionNumber}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${formatDate(sale.date)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${sale.customerName || 'Walk-in Customer'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${itemCount} item${itemCount > 1 ? 's' : ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${sale.paymentMethod || 'Tunai'}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${formatCurrency(sale.total)}</td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewSale('${sale.id}')" class="text-blue-600 hover:text-blue-900" title="Lihat Detail">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="printReceipt('${sale.id}')" class="text-green-600 hover:text-green-900" title="Print Struk">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button onclick="editSale('${sale.id}')" class="text-yellow-600 hover:text-yellow-900" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteSale('${sale.id}')" class="text-red-600 hover:text-red-900" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updateSalesSummary();
        }

        function updateSalesSummary() {
            const totalCount = sales.length;
            const totalAmount = sales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const avgAmount = totalCount > 0 ? totalAmount / totalCount : 0;

            document.getElementById('total-sales-count').textContent = totalCount;
            document.getElementById('total-sales-amount').textContent = formatCurrency(totalAmount);
            document.getElementById('avg-sales-amount').textContent = formatCurrency(avgAmount);
        }

        function getStatusBadge(status) {
            const statusClasses = {
                'Completed': 'bg-green-100 text-green-800',
                'Pending': 'bg-yellow-100 text-yellow-800',
                'Cancelled': 'bg-red-100 text-red-800'
            };
            
            const statusText = {
                'Completed': 'Selesai',
                'Pending': 'Pending',
                'Cancelled': 'Dibatalkan'
            };

            const className = statusClasses[status] || 'bg-gray-100 text-gray-800';
            const text = statusText[status] || status;
            
            return `<span class="px-2 py-1 text-xs font-semibold ${className} rounded-full">${text}</span>`;
        }

        function showCreateSaleModal() {
            editingSaleId = null;
            shoppingCart = [];
            selectedProduct = null;
            
            // Generate transaction number
            const transactionNumber = generateTransactionNumber();
            document.getElementById('transaction-number').value = transactionNumber;
            
            // Set current date
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('transaction-date').value = today;
            
            // Reset form fields
            document.getElementById('customer-name').value = '';
            document.getElementById('transaction-notes').value = '';
            document.getElementById('payment-method').value = 'Tunai';
            document.getElementById('transaction-status').value = 'Completed';
            
            // Reset payment and tax fields
            document.getElementById('payment-amount').value = '';
            document.getElementById('apply-tax').checked = false;
            document.getElementById('tax-percentage').value = '11';
            document.getElementById('tax-percentage').disabled = true;
            document.getElementById('tax-amount-display').textContent = 'Pajak: Rp 0';
            document.getElementById('change-amount').textContent = 'Kembalian akan dihitung otomatis';
            document.getElementById('change-amount').className = 'mt-1 text-xs text-gray-500';
            
            // Reset product search
            document.getElementById('sale-product-search').value = '';
            document.getElementById('sale-product-search-results').classList.add('hidden');
            document.getElementById('sale-selected-product-info').classList.add('hidden');
            document.getElementById('sale-quantity-price-section').classList.add('hidden');
            
            // Reset cart display
            updateCartDisplay();
            
            showModal('sale-modal');
        }

        function closeSaleModal() {
            // Check if there are items in cart
            if (shoppingCart.length > 0) {
                const confirmClose = confirm('⚠️ PERINGATAN!\n\nAnda memiliki item di keranjang yang belum diproses.\n\nApakah Anda yakin ingin menutup tanpa menyimpan?\n\n• Klik OK untuk menutup tanpa menyimpan\n• Klik Cancel untuk kembali ke form');
                
                if (!confirmClose) {
                    return; // Don't close the modal
                }
            }
            
            // Clear all data
            shoppingCart = [];
            selectedProduct = null;
            editingSaleId = null;
            
            // Reset form
            document.getElementById('customer-name').value = '';
            document.getElementById('transaction-notes').value = '';
            document.getElementById('sale-product-search').value = '';
            document.getElementById('sale-product-search-results').classList.add('hidden');
            document.getElementById('sale-selected-product-info').classList.add('hidden');
            document.getElementById('sale-quantity-price-section').classList.add('hidden');
            
            updateCartDisplay();
            
            closeModal('sale-modal');
        }

        // Shopping Cart Functions
        function searchSaleProducts() {
            const searchTerm = document.getElementById('sale-product-search').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('sale-product-search-results');
            
            if (searchTerm.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // Filter products based on search term
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.code.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm)
            );
            
            if (filteredProducts.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p>Tidak ada produk yang ditemukan untuk "${searchTerm}"</p>
                        <p class="text-sm mt-1">Coba kata kunci lain atau periksa ejaan</p>
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            // Enhanced search results with better styling
            resultsContainer.innerHTML = filteredProducts.map((product, index) => {
                const stockStatus = product.currentStock <= settings.minStockLimit ? 
                    '<span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded-full">⚠️ Stok Rendah</span>' : 
                    '<span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">✅ Stok Normal</span>';
                
                const stockColor = product.currentStock <= settings.minStockLimit ? 'text-red-600' : 'text-green-600';
                const profitMargin = product.price > 0 ? ((product.price - product.hpp) / product.price * 100).toFixed(1) : 0;
                
                return `
                    <div class="p-4 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-all duration-200 ${index === 0 ? 'bg-blue-25' : ''}" 
                         onclick="selectSaleProduct('${product.id}')" 
                         onmouseover="this.classList.add('shadow-md')" 
                         onmouseout="this.classList.remove('shadow-md')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900 text-lg">${product.name}</div>
                                <div class="flex items-center gap-2 mt-2">
                                    <span class="font-mono bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-medium">${product.code}</span>
                                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm font-medium">${product.category}</span>
                                    ${stockStatus}
                                </div>
                                <div class="mt-3 grid grid-cols-2 gap-4 text-sm">
                                    <div class="space-y-1">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Stok:</span>
                                            <span class="font-bold ${stockColor}">${product.currentStock} ${product.unit}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">HPP:</span>
                                            <span class="font-semibold text-gray-800">${formatCurrency(product.hpp)}</span>
                                        </div>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Harga Jual:</span>
                                            <span class="font-bold text-green-600">${formatCurrency(product.price)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Margin:</span>
                                            <span class="font-semibold text-orange-600">${profitMargin}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right ml-4 flex flex-col items-end">
                                <div class="text-xs text-gray-500 mb-1">Nilai Stok</div>
                                <div class="font-bold text-purple-600">${formatCurrency(product.currentStock * product.hpp)}</div>
                                <div class="mt-2 text-xs text-gray-400">
                                    ${index === 0 ? '👆 Tekan Enter' : `Klik untuk pilih`}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.classList.remove('hidden');
        }
        
        function selectSaleProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            selectedProduct = product;
            
            // Set the search input to show selected product
            document.getElementById('sale-product-search').value = `${product.name} (${product.code})`;
            
            // Hide search results
            document.getElementById('sale-product-search-results').classList.add('hidden');
            
            // Show selected product info
            const productInfo = document.getElementById('sale-selected-product-info');
            const stockStatusClass = product.currentStock <= settings.minStockLimit ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200';
            const stockStatusIcon = product.currentStock <= settings.minStockLimit ? '⚠️' : '✅';
            const stockStatusText = product.currentStock <= settings.minStockLimit ? 'STOK RENDAH' : 'STOK NORMAL';
            
            const profitMargin = product.price > 0 ? ((product.price - product.hpp) / product.price * 100).toFixed(1) : 0;
            const stockValue = product.currentStock * product.hpp;
            
            productInfo.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-4">
                            <h5 class="font-bold text-green-800 text-lg">
                                <i class="fas fa-check-circle mr-2"></i>Produk Dipilih
                            </h5>
                            <div class="flex items-center space-x-2">
                                ${stockStatusIcon === '⚠️' ? 
                                    '<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold">⚠️ STOK RENDAH</span>' : 
                                    '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">✅ STOK NORMAL</span>'
                                }
                            </div>
                        </div>
                        
                        <!-- Product Header -->
                        <div class="bg-white p-4 rounded-lg border-2 border-green-300 mb-4">
                            <div class="text-center">
                                <h6 class="font-bold text-xl text-gray-900 mb-2">${product.name}</h6>
                                <div class="flex justify-center items-center space-x-3">
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-mono font-bold">${product.code}</span>
                                    <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full font-medium">${product.category}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Product Details Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-white p-3 rounded-lg border">
                                <h6 class="font-semibold text-gray-700 mb-3 text-center">💰 Informasi Harga</h6>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">HPP:</span>
                                        <span class="font-bold text-gray-800">${formatCurrency(product.hpp)}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Harga Jual:</span>
                                        <span class="font-bold text-green-600 text-lg">${formatCurrency(product.price)}</span>
                                    </div>
                                    <div class="flex justify-between items-center pt-2 border-t">
                                        <span class="text-sm text-gray-600">Margin:</span>
                                        <span class="font-bold text-orange-600">${profitMargin}%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-3 rounded-lg border">
                                <h6 class="font-semibold text-gray-700 mb-3 text-center">📦 Informasi Stok</h6>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Stok Tersedia:</span>
                                        <span class="font-bold text-2xl ${product.currentStock <= settings.minStockLimit ? 'text-red-600' : 'text-green-600'}">${product.currentStock}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Satuan:</span>
                                        <span class="font-semibold text-gray-800">${product.unit}</span>
                                    </div>
                                    <div class="flex justify-between items-center pt-2 border-t">
                                        <span class="text-sm text-gray-600">Nilai Stok:</span>
                                        <span class="font-bold text-purple-600">${formatCurrency(stockValue)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stock Status Alert -->
                        <div class="p-3 ${stockStatusClass} rounded-lg border-2 ${product.currentStock <= settings.minStockLimit ? 'border-red-300' : 'border-green-300'}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-2">${stockStatusIcon}</span>
                                    <div>
                                        <div class="font-bold text-sm">${stockStatusText}</div>
                                        <div class="text-xs opacity-75">
                                            ${product.currentStock <= settings.minStockLimit ? 
                                                `Batas minimum: ${settings.minStockLimit} ${product.unit}` : 
                                                `Stok aman untuk dijual`
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-lg ${product.currentStock <= settings.minStockLimit ? 'text-red-600' : 'text-green-600'}">${product.currentStock} ${product.unit}</div>
                                    <div class="text-xs opacity-75">tersedia</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onclick="clearSelectedProduct()" class="ml-3 text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition-colors" title="Batal Pilih Produk">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            `;
            productInfo.classList.remove('hidden');
            
            // Show quantity and price section
            const quantityPriceSection = document.getElementById('sale-quantity-price-section');
            quantityPriceSection.classList.remove('hidden');
            
            // Set default values
            document.getElementById('sale-quantity').value = 1;
            document.getElementById('sale-price').value = product.price;
            
            // Update quantity info
            updateQuantityInfo();
            
            // Calculate initial total
            calculateItemTotal();
        }
        
        function clearSelectedProduct() {
            selectedProduct = null;
            document.getElementById('sale-product-search').value = '';
            document.getElementById('sale-selected-product-info').classList.add('hidden');
            document.getElementById('sale-quantity-price-section').classList.add('hidden');
            document.getElementById('sale-quantity').value = '';
            document.getElementById('sale-price').value = '';
            document.getElementById('item-subtotal').textContent = 'Rp 0';
        }
        
        function updateQuantityInfo() {
            if (!selectedProduct) return;
            
            const quantityInfo = document.getElementById('sale-quantity-info');
            if (selectedProduct.currentStock <= settings.minStockLimit) {
                quantityInfo.innerHTML = `⚠️ Stok rendah! Tersedia: ${selectedProduct.currentStock} ${selectedProduct.unit}`;
                quantityInfo.className = 'mt-1 text-xs text-red-600 font-medium';
            } else {
                quantityInfo.innerHTML = `✅ Stok tersedia: ${selectedProduct.currentStock} ${selectedProduct.unit}`;
                quantityInfo.className = 'mt-1 text-xs text-green-600';
            }
        }
        
        function calculateItemTotal() {
            const quantity = parseInt(document.getElementById('sale-quantity').value) || 0;
            const price = parseFloat(document.getElementById('sale-price').value) || 0;
            const total = quantity * price;
            
            document.getElementById('item-subtotal').textContent = formatCurrency(total);
        }
        
        function addToCart() {
            if (!selectedProduct) {
                alert('❌ Silakan pilih produk terlebih dahulu!');
                return;
            }
            
            const quantity = parseInt(document.getElementById('sale-quantity').value);
            const price = parseFloat(document.getElementById('sale-price').value);
            
            // Validation
            if (!quantity || quantity <= 0) {
                alert('❌ Jumlah harus lebih dari 0!');
                return;
            }
            
            if (!price || price <= 0) {
                alert('❌ Harga harus lebih dari 0!');
                return;
            }
            
            if (quantity > selectedProduct.currentStock) {
                alert(`❌ Stok tidak mencukupi!\n\nStok tersedia: ${selectedProduct.currentStock} ${selectedProduct.unit}\nJumlah diminta: ${quantity} ${selectedProduct.unit}`);
                return;
            }
            
            // Check if product already in cart
            const existingItemIndex = shoppingCart.findIndex(item => item.productId === selectedProduct.id);
            
            if (existingItemIndex >= 0) {
                // Update existing item
                const existingItem = shoppingCart[existingItemIndex];
                const newQuantity = existingItem.quantity + quantity;
                
                if (newQuantity > selectedProduct.currentStock) {
                    alert(`❌ Total quantity melebihi stok!\n\nDi keranjang: ${existingItem.quantity} ${selectedProduct.unit}\nTambahan: ${quantity} ${selectedProduct.unit}\nTotal: ${newQuantity} ${selectedProduct.unit}\nStok tersedia: ${selectedProduct.currentStock} ${selectedProduct.unit}`);
                    return;
                }
                
                existingItem.quantity = newQuantity;
                existingItem.price = price; // Update price if changed
            } else {
                // Add new item
                shoppingCart.push({
                    productId: selectedProduct.id,
                    productName: selectedProduct.name,
                    productCode: selectedProduct.code,
                    category: selectedProduct.category,
                    unit: selectedProduct.unit,
                    hpp: selectedProduct.hpp,
                    quantity: quantity,
                    price: price
                });
            }
            
            // Clear selection
            clearSelectedProduct();
            
            // Update cart display
            updateCartDisplay();
            
            // Show success message
            alert(`✅ Produk berhasil ditambahkan ke keranjang!\n\n📦 ${selectedProduct ? selectedProduct.name : 'Produk'}\n📊 Jumlah: ${quantity} ${selectedProduct ? selectedProduct.unit : 'pcs'}\n💰 Harga: ${formatCurrency(price)}\n💵 Subtotal: ${formatCurrency(quantity * price)}`);
        }
        
        function updateCartDisplay() {
            const cartContainer = document.getElementById('shopping-cart');
            const totalItemsElement = document.getElementById('cart-total-items');
            const totalQuantityElement = document.getElementById('cart-total-quantity');
            const subtotalElement = document.getElementById('cart-subtotal');
            const taxAmountElement = document.getElementById('cart-tax-amount');
            const grandTotalElement = document.getElementById('cart-grand-total');
            const paymentAmountElement = document.getElementById('cart-payment-amount');
            const changeAmountElement = document.getElementById('cart-change-amount');
            const processBtns = [document.getElementById('process-sale-btn'), document.getElementById('process-print-btn')];
            
            // Quick stats elements
            const quickTotalItems = document.getElementById('quick-total-items');
            const quickTotalQty = document.getElementById('quick-total-qty');
            const quickTotalValue = document.getElementById('quick-total-value');
            
            if (shoppingCart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <i class="fas fa-shopping-cart text-4xl mb-3 text-gray-300"></i>
                        <p class="font-medium">Keranjang masih kosong</p>
                        <p class="text-sm mt-1">Cari dan pilih produk untuk ditambahkan</p>
                        <div class="mt-4 text-xs text-gray-400">
                            <p>💡 Tips: Gunakan pencarian untuk menemukan produk dengan cepat</p>
                        </div>
                    </div>
                `;
                
                // Reset all counters
                totalItemsElement.textContent = '0';
                if (totalQuantityElement) totalQuantityElement.textContent = '0';
                subtotalElement.textContent = 'Rp 0';
                if (taxAmountElement) taxAmountElement.textContent = 'Rp 0';
                grandTotalElement.textContent = 'Rp 0';
                if (paymentAmountElement) paymentAmountElement.textContent = 'Rp 0';
                if (changeAmountElement) changeAmountElement.textContent = 'Rp 0';
                
                // Reset quick stats
                if (quickTotalItems) quickTotalItems.textContent = '0';
                if (quickTotalQty) quickTotalQty.textContent = '0';
                if (quickTotalValue) quickTotalValue.textContent = 'Rp 0';
                
                // Disable process buttons
                processBtns.forEach(btn => {
                    if (btn) {
                        btn.disabled = true;
                        btn.classList.add('disabled:from-gray-400', 'disabled:to-gray-500');
                    }
                });
                
                return;
            }
            
            // Calculate totals
            let totalItems = shoppingCart.length;
            let totalQuantity = 0;
            let subtotal = 0;
            let totalProfit = 0;
            
            shoppingCart.forEach(item => {
                totalQuantity += item.quantity;
                subtotal += item.quantity * item.price;
                totalProfit += (item.price - item.hpp) * item.quantity;
            });
            
            // Enhanced cart items rendering
            cartContainer.innerHTML = shoppingCart.map((item, index) => {
                const itemTotal = item.quantity * item.price;
                const profit = (item.price - item.hpp) * item.quantity;
                const profitMargin = item.price > 0 ? ((item.price - item.hpp) / item.price * 100).toFixed(1) : 0;
                
                return `
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-lg border-2 border-gray-200 hover:border-blue-300 transition-all duration-200">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900 text-lg">${item.productName}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    <span class="font-mono bg-blue-100 px-2 py-1 rounded text-blue-800">${item.productCode}</span> • 
                                    <span class="bg-green-100 px-2 py-1 rounded text-green-800">${item.category}</span>
                                </div>
                                <div class="mt-2 p-2 bg-white rounded border">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="font-medium">Quantity:</span>
                                        <span class="font-bold text-blue-600">${item.quantity} ${item.unit}</span>
                                    </div>
                                    <div class="flex justify-between items-center text-sm mt-1">
                                        <span class="font-medium">Harga Satuan:</span>
                                        <span class="font-bold text-green-600">${formatCurrency(item.price)}</span>
                                    </div>
                                    <div class="flex justify-between items-center text-sm mt-1 pt-1 border-t">
                                        <span class="font-medium">Subtotal:</span>
                                        <span class="font-bold text-purple-600 text-lg">${formatCurrency(itemTotal)}</span>
                                    </div>
                                </div>
                                <div class="mt-2 p-2 bg-green-50 rounded border border-green-200">
                                    <div class="flex justify-between items-center text-xs">
                                        <span class="text-green-700">Profit per item:</span>
                                        <span class="font-bold text-green-700">${formatCurrency(profit)} (${profitMargin}%)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2 ml-3">
                                <button onclick="editCartItem(${index})" 
                                        class="text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 p-2 rounded-lg transition-colors" 
                                        title="Edit Item">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="removeCartItem(${index})" 
                                        class="text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition-colors" 
                                        title="Hapus Item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Calculate tax and grand total
            const applyTax = document.getElementById('apply-tax').checked;
            const taxPercentage = parseFloat(document.getElementById('tax-percentage').value) || 0;
            const taxAmount = applyTax ? (subtotal * taxPercentage / 100) : 0;
            const grandTotal = subtotal + taxAmount;
            
            // Get payment amount and calculate change
            const paymentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
            const changeAmount = paymentAmount > grandTotal ? paymentAmount - grandTotal : 0;
            
            // Update all totals
            totalItemsElement.textContent = totalItems;
            if (totalQuantityElement) totalQuantityElement.textContent = totalQuantity;
            subtotalElement.textContent = formatCurrency(subtotal);
            if (taxAmountElement) taxAmountElement.textContent = formatCurrency(taxAmount);
            grandTotalElement.textContent = formatCurrency(grandTotal);
            if (paymentAmountElement) paymentAmountElement.textContent = formatCurrency(paymentAmount);
            if (changeAmountElement) changeAmountElement.textContent = formatCurrency(changeAmount);
            
            // Update quick stats
            if (quickTotalItems) quickTotalItems.textContent = totalItems;
            if (quickTotalQty) quickTotalQty.textContent = totalQuantity;
            if (quickTotalValue) quickTotalValue.textContent = formatCurrency(grandTotal);
            
            // Enable process buttons with enhanced styling
            processBtns.forEach(btn => {
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('disabled:from-gray-400', 'disabled:to-gray-500');
                }
            });
        }
        
        // Tax and Payment Calculation Functions
        function calculateTaxAndTotal() {
            const applyTaxCheckbox = document.getElementById('apply-tax');
            const taxPercentageInput = document.getElementById('tax-percentage');
            const taxAmountDisplay = document.getElementById('tax-amount-display');
            
            // Enable/disable tax percentage input based on checkbox
            taxPercentageInput.disabled = !applyTaxCheckbox.checked;
            
            // Calculate tax amount
            let subtotal = 0;
            shoppingCart.forEach(item => {
                subtotal += item.quantity * item.price;
            });
            
            const taxPercentage = applyTaxCheckbox.checked ? (parseFloat(taxPercentageInput.value) || 0) : 0;
            const taxAmount = subtotal * taxPercentage / 100;
            
            // Update tax display
            taxAmountDisplay.textContent = `Pajak: ${formatCurrency(taxAmount)} (${taxPercentage}%)`;
            
            // Update cart display
            updateCartDisplay();
            
            // Recalculate change
            calculateChange();
        }
        
        function calculateChange() {
            const paymentAmountInput = document.getElementById('payment-amount');
            const changeAmountDisplay = document.getElementById('change-amount');
            
            // Calculate current grand total
            let subtotal = 0;
            shoppingCart.forEach(item => {
                subtotal += item.quantity * item.price;
            });
            
            const applyTax = document.getElementById('apply-tax').checked;
            const taxPercentage = parseFloat(document.getElementById('tax-percentage').value) || 0;
            const taxAmount = applyTax ? (subtotal * taxPercentage / 100) : 0;
            const grandTotal = subtotal + taxAmount;
            
            const paymentAmount = parseFloat(paymentAmountInput.value) || 0;
            const changeAmount = paymentAmount > grandTotal ? paymentAmount - grandTotal : 0;
            
            // Update change display
            if (paymentAmount === 0) {
                changeAmountDisplay.textContent = 'Kembalian akan dihitung otomatis';
                changeAmountDisplay.className = 'mt-1 text-xs text-gray-500';
            } else if (paymentAmount < grandTotal) {
                const shortage = grandTotal - paymentAmount;
                changeAmountDisplay.textContent = `Kurang: ${formatCurrency(shortage)}`;
                changeAmountDisplay.className = 'mt-1 text-xs text-red-600 font-medium';
            } else if (changeAmount === 0) {
                changeAmountDisplay.textContent = 'Pembayaran pas';
                changeAmountDisplay.className = 'mt-1 text-xs text-green-600 font-medium';
            } else {
                changeAmountDisplay.textContent = `Kembalian: ${formatCurrency(changeAmount)}`;
                changeAmountDisplay.className = 'mt-1 text-xs text-blue-600 font-medium';
            }
            
            // Update cart display
            updateCartDisplay();
        }
        
        function editCartItem(index) {
            const item = shoppingCart[index];
            const product = products.find(p => p.id === item.productId);
            
            if (!product) {
                alert('❌ Produk tidak ditemukan!');
                return;
            }
            
            const newQuantity = prompt(`Edit jumlah untuk ${item.productName}:\n\nStok tersedia: ${product.currentStock} ${item.unit}\nJumlah saat ini: ${item.quantity} ${item.unit}`, item.quantity);
            
            if (newQuantity === null) return; // User cancelled
            
            const quantity = parseInt(newQuantity);
            if (!quantity || quantity <= 0) {
                alert('❌ Jumlah harus lebih dari 0!');
                return;
            }
            
            if (quantity > product.currentStock) {
                alert(`❌ Stok tidak mencukupi!\n\nStok tersedia: ${product.currentStock} ${item.unit}\nJumlah diminta: ${quantity} ${item.unit}`);
                return;
            }
            
            item.quantity = quantity;
            updateCartDisplay();
        }
        
        function removeCartItem(index) {
            const item = shoppingCart[index];
            if (confirm(`Hapus ${item.productName} dari keranjang?`)) {
                shoppingCart.splice(index, 1);
                updateCartDisplay();
            }
        }
        
        function clearCart() {
            if (shoppingCart.length === 0) return;
            
            if (confirm('Kosongkan semua item dari keranjang?')) {
                shoppingCart = [];
                updateCartDisplay();
            }
        }
        
        function handleSaleSearchKeydown(event) {
            const resultsContainer = document.getElementById('sale-product-search-results');
            
            if (event.key === 'Escape') {
                resultsContainer.classList.add('hidden');
                event.target.blur();
            } else if (event.key === 'Enter') {
                event.preventDefault();
                const firstResult = resultsContainer.querySelector('[onclick]');
                if (firstResult) {
                    firstResult.click();
                }
            }
        }

        function populateSaleProductSelect() {
            try {
                // This function is no longer needed with the new cart system
                // Keeping for backward compatibility
                console.log('populateSaleProductSelect called - using new cart system');
            } catch (error) {
                console.error('Error in populateSaleProductSelect:', error);
            }
        }

        function updateSaleProductInfo() {
            const productSelect = document.getElementById('sale-product');
            const productInfo = document.getElementById('sale-product-info');
            const quantityInfo = document.getElementById('sale-quantity-info');
            const priceInput = document.getElementById('sale-price');
            
            if (!productSelect.value) {
                productInfo.classList.add('hidden');
                quantityInfo.textContent = 'Pilih produk terlebih dahulu';
                priceInput.value = '';
                calculateSaleTotal();
                return;
            }
            
            const product = products.find(p => p.id === productSelect.value);
            if (!product) return;
            
            // Set default price
            priceInput.value = product.price;
            
            // Show product info
            const stockStatusClass = product.currentStock <= settings.minStockLimit ? 'text-red-600' : 'text-green-600';
            const stockStatusIcon = product.currentStock <= settings.minStockLimit ? '⚠️' : '✅';
            
            productInfo.innerHTML = `
                <div class="bg-blue-50 p-2 rounded border border-blue-200">
                    <div class="text-xs space-y-1">
                        <div class="flex justify-between">
                            <span class="font-medium">Kategori:</span>
                            <span>${product.category}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Stok:</span>
                            <span class="${stockStatusClass} font-medium">${stockStatusIcon} ${product.currentStock} ${product.unit}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">HPP:</span>
                            <span>${formatCurrency(product.hpp)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Harga Jual:</span>
                            <span class="font-semibold">${formatCurrency(product.price)}</span>
                        </div>
                    </div>
                </div>
            `;
            productInfo.classList.remove('hidden');
            
            // Update quantity info
            if (product.currentStock <= settings.minStockLimit) {
                quantityInfo.innerHTML = `⚠️ Stok rendah! Tersedia: ${product.currentStock} ${product.unit}`;
                quantityInfo.className = 'mt-1 text-xs text-red-600 font-medium';
            } else {
                quantityInfo.innerHTML = `✅ Stok tersedia: ${product.currentStock} ${product.unit}`;
                quantityInfo.className = 'mt-1 text-xs text-green-600';
            }
            
            calculateSaleTotal();
        }

        function calculateSaleTotal() {
            const price = parseFloat(document.getElementById('sale-price').value) || 0;
            const quantity = parseInt(document.getElementById('sale-quantity').value) || 0;
            const total = price * quantity;
            
            document.getElementById('sale-total-display').value = formatCurrency(total);
        }

        function generateTransactionNumber() {
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = today.getHours().toString().padStart(2, '0') + today.getMinutes().toString().padStart(2, '0');
            const randomStr = Math.random().toString(36).substr(2, 3).toUpperCase();
            return `TRX${dateStr}${timeStr}${randomStr}`;
        }

        // Process Sale Functions
        function processSale() {
            if (shoppingCart.length === 0) {
                alert('❌ Keranjang masih kosong! Silakan tambahkan produk terlebih dahulu.');
                return;
            }
            
            // Show loading state
            const processBtn = document.getElementById('process-sale-btn');
            const originalText = processBtn.innerHTML;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';
            processBtn.disabled = true;
            
            try {
                // Calculate subtotal
                const subtotal = shoppingCart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                
                // Calculate tax
                const applyTax = document.getElementById('apply-tax').checked;
                const taxPercentage = parseFloat(document.getElementById('tax-percentage').value) || 0;
                const taxAmount = applyTax ? (subtotal * taxPercentage / 100) : 0;
                const grandTotal = subtotal + taxAmount;
                
                // Get payment information
                const paymentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
                const changeAmount = paymentAmount > grandTotal ? paymentAmount - grandTotal : 0;
                
                // Collect transaction data
                const transactionData = {
                    transactionNumber: document.getElementById('transaction-number').value,
                    date: new Date(document.getElementById('transaction-date').value).toISOString(),
                    customerName: document.getElementById('customer-name').value.trim() || null,
                    paymentMethod: document.getElementById('payment-method').value,
                    status: document.getElementById('transaction-status').value,
                    notes: document.getElementById('transaction-notes').value.trim() || null,
                    items: [...shoppingCart], // Copy cart items
                    subtotal: subtotal,
                    taxPercentage: applyTax ? taxPercentage : 0,
                    taxAmount: taxAmount,
                    total: grandTotal,
                    paymentAmount: paymentAmount,
                    changeAmount: changeAmount
                };
                
                // Validate stock availability for all items
                const stockErrors = [];
                shoppingCart.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (!product) {
                        stockErrors.push(`• ${item.productName}: Produk tidak ditemukan`);
                    } else if (item.quantity > product.currentStock) {
                        stockErrors.push(`• ${item.productName}: Stok tidak mencukupi (tersedia: ${product.currentStock}, diminta: ${item.quantity})`);
                    }
                });
                
                if (stockErrors.length > 0) {
                    alert(`❌ VALIDASI STOK GAGAL!\n\nKesalahan:\n${stockErrors.join('\n')}\n\nSilakan periksa dan sesuaikan jumlah item di keranjang.`);
                    return;
                }
                
                // Create new sale
                const newSale = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    ...transactionData,
                    createdAt: new Date().toISOString()
                };
                sales.push(newSale);
                
                // Process stock updates and movements ONLY if status is "Completed"
                let totalProfit = 0;
                const stockUpdates = [];
                
                if (transactionData.status === 'Completed') {
                    shoppingCart.forEach(item => {
                        const product = products.find(p => p.id === item.productId);
                        if (product) {
                            const itemProfit = (item.price - item.hpp) * item.quantity;
                            totalProfit += itemProfit;
                            
                            // Store old stock for reporting
                            const oldStock = product.currentStock;
                            
                            // Update stock
                            product.currentStock -= item.quantity;
                            
                            stockUpdates.push({
                                productName: product.name,
                                productCode: product.code,
                                oldStock: oldStock,
                                newStock: product.currentStock,
                                soldQuantity: item.quantity,
                                unit: product.unit,
                                profit: itemProfit
                            });
                            
                            // Add stock movement record
                            stockMovements.push({
                                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                                productId: item.productId,
                                type: 'out',
                                quantity: item.quantity,
                                date: transactionData.date,
                                note: `Penjualan - ${transactionData.transactionNumber} | Customer: ${transactionData.customerName || 'Walk-in'} | ${item.productName} | Harga: ${formatCurrency(item.price)} | Profit: ${formatCurrency(itemProfit)}`,
                                salePrice: item.price,
                                profit: itemProfit,
                                transactionId: newSale.id
                            });
                        }
                    });
                }
                
                saveData();
                
                // Generate success message
                let successMsg = `🎉 TRANSAKSI BERHASIL DIPROSES!\n\n`;
                successMsg += `📋 DETAIL TRANSAKSI:\n`;
                successMsg += `• No. Transaksi: ${transactionData.transactionNumber}\n`;
                successMsg += `• Tanggal: ${formatDate(transactionData.date)}\n`;
                successMsg += `• Customer: ${transactionData.customerName || 'Walk-in Customer'}\n`;
                successMsg += `• Total Item: ${shoppingCart.length} jenis produk\n`;
                successMsg += `• Total Quantity: ${shoppingCart.reduce((sum, item) => sum + item.quantity, 0)} unit\n`;
                successMsg += `• Subtotal: ${formatCurrency(transactionData.subtotal)}\n`;
                
                if (transactionData.taxAmount > 0) {
                    successMsg += `• Pajak (${transactionData.taxPercentage}%): ${formatCurrency(transactionData.taxAmount)}\n`;
                }
                
                successMsg += `• Total Penjualan: ${formatCurrency(transactionData.total)}\n`;
                successMsg += `• Metode Pembayaran: ${transactionData.paymentMethod}\n`;
                
                if (transactionData.paymentAmount > 0) {
                    successMsg += `• Dibayar: ${formatCurrency(transactionData.paymentAmount)}\n`;
                    successMsg += `• Kembalian: ${formatCurrency(transactionData.changeAmount)}\n`;
                }
                
                successMsg += `• Status: ${transactionData.status}\n`;
                
                if (transactionData.status === 'Completed') {
                    successMsg += `\n💰 RINGKASAN KEUNTUNGAN:\n`;
                    successMsg += `• Total Profit: ${formatCurrency(totalProfit)}\n`;
                    successMsg += `• Margin: ${((totalProfit / transactionData.subtotal) * 100).toFixed(1)}%\n`;
                    
                    successMsg += `\n📦 UPDATE STOK:\n`;
                    stockUpdates.forEach(update => {
                        successMsg += `• ${update.productName} (${update.productCode}):\n`;
                        successMsg += `  Sebelum: ${update.oldStock} ${update.unit} → Sekarang: ${update.newStock} ${update.unit}\n`;
                        successMsg += `  Terjual: ${update.soldQuantity} ${update.unit} | Profit: ${formatCurrency(update.profit)}\n`;
                    });
                    
                    // Check for low stock warnings
                    const lowStockItems = stockUpdates.filter(update => update.newStock <= settings.minStockLimit);
                    if (lowStockItems.length > 0) {
                        successMsg += `\n⚠️ PERINGATAN STOK RENDAH:\n`;
                        lowStockItems.forEach(item => {
                            successMsg += `• ${item.productName}: ${item.newStock} ${item.unit} (batas minimum: ${settings.minStockLimit})\n`;
                        });
                        successMsg += `• Pertimbangkan untuk melakukan restock segera.\n`;
                    }
                } else if (transactionData.status === 'Pending') {
                    successMsg += `\n⏳ STATUS PENDING:\n`;
                    successMsg += `• Stok produk belum dikurangi\n`;
                    successMsg += `• Transaksi dapat diubah ke "Selesai" untuk memproses stok\n`;
                    successMsg += `• Atau dapat dibatalkan tanpa mempengaruhi stok\n`;
                } else if (transactionData.status === 'Cancelled') {
                    successMsg += `\n❌ STATUS DIBATALKAN:\n`;
                    successMsg += `• Transaksi dibatalkan\n`;
                    successMsg += `• Stok produk tidak terpengaruh\n`;
                    successMsg += `• Data tersimpan untuk referensi\n`;
                }
                
                if (transactionData.notes) {
                    successMsg += `\n📝 Catatan: ${transactionData.notes}\n`;
                }
                
                successMsg += `\n💾 Data telah disimpan dan dashboard diperbarui.`;
                
                alert(successMsg);
                
                // Close modal and refresh UI
                closeSaleModal();
                renderSales();
                renderProducts();
                updateDashboard();
                populateProductSelects();
                
            } catch (error) {
                console.error('Error processing sale:', error);
                alert(`❌ GAGAL MEMPROSES TRANSAKSI!\n\nError: ${error.message}\n\nSilakan coba lagi atau hubungi administrator.`);
            } finally {
                // Reset button state
                processBtn.innerHTML = originalText;
                processBtn.disabled = false;
            }
        }
        
        function processSaleAndPrint() {
            if (shoppingCart.length === 0) {
                alert('❌ Keranjang masih kosong! Silakan tambahkan produk terlebih dahulu.');
                return;
            }
            
            // Show loading state
            const processBtn = document.getElementById('process-print-btn');
            const originalText = processBtn.innerHTML;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses & Print...';
            processBtn.disabled = true;
            
            try {
                // Process the sale first
                processSale();
                
                // Get the last sale (just created)
                const lastSale = sales[sales.length - 1];
                
                // Print receipt after a short delay
                setTimeout(() => {
                    printReceipt(lastSale.id);
                }, 1000);
                
            } catch (error) {
                console.error('Error processing sale and print:', error);
                alert(`❌ GAGAL MEMPROSES TRANSAKSI!\n\nError: ${error.message}\n\nSilakan coba lagi atau hubungi administrator.`);
            } finally {
                // Reset button state
                processBtn.innerHTML = originalText;
                processBtn.disabled = false;
            }
        }

        function handleSaleSubmit(e) {
            // This function is no longer used with the new cart system
            // Keeping for backward compatibility
            e.preventDefault();
        }

        function viewSale(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            
            let details = `DETAIL TRANSAKSI PENJUALAN\n\n`;
            details += `No. Transaksi: ${sale.transactionNumber}\n`;
            details += `Tanggal: ${formatDate(sale.date)}\n`;
            details += `Customer: ${sale.customerName || 'Walk-in Customer'}\n`;
            details += `Metode Pembayaran: ${sale.paymentMethod}\n`;
            details += `Status: ${sale.status}\n\n`;
            
            details += `ITEM PENJUALAN:\n`;
            if (sale.items && sale.items.length > 0) {
                sale.items.forEach((item, index) => {
                    const product = products.find(p => p.id === item.productId);
                    const productName = product ? product.name : 'Produk tidak ditemukan';
                    const subtotal = item.price * item.quantity;
                    
                    details += `${index + 1}. ${productName}\n`;
                    details += `   Harga: ${formatCurrency(item.price)}\n`;
                    details += `   Jumlah: ${item.quantity} ${product ? product.unit : 'pcs'}\n`;
                    details += `   Subtotal: ${formatCurrency(subtotal)}\n\n`;
                });
            }
            
            details += `TOTAL: ${formatCurrency(sale.total)}\n`;
            
            if (sale.notes) {
                details += `\nCatatan: ${sale.notes}`;
            }
            
            alert(details);
        }

        function editSale(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) {
                alert('❌ Transaksi tidak ditemukan!');
                return;
            }
            
            editingSaleId = saleId;
            
            // Clear current cart and reset
            shoppingCart = [];
            selectedProduct = null;
            
            // Fill form data
            document.getElementById('transaction-number').value = sale.transactionNumber;
            document.getElementById('transaction-date').value = new Date(sale.date).toISOString().slice(0, 10);
            document.getElementById('customer-name').value = sale.customerName || '';
            document.getElementById('payment-method').value = sale.paymentMethod || 'Tunai';
            document.getElementById('transaction-status').value = sale.status || 'Completed';
            document.getElementById('transaction-notes').value = sale.notes || '';
            
            // Fill payment and tax data
            document.getElementById('payment-amount').value = sale.paymentAmount || '';
            document.getElementById('apply-tax').checked = (sale.taxAmount && sale.taxAmount > 0);
            document.getElementById('tax-percentage').value = sale.taxPercentage || 11;
            document.getElementById('tax-percentage').disabled = !(sale.taxAmount && sale.taxAmount > 0);
            
            // Populate shopping cart from sale items
            if (sale.items && sale.items.length > 0) {
                sale.items.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (product) {
                        shoppingCart.push({
                            productId: item.productId,
                            productName: product.name,
                            productCode: product.code,
                            category: product.category,
                            unit: product.unit,
                            hpp: product.hpp,
                            quantity: item.quantity,
                            price: item.price
                        });
                    } else {
                        // Handle case where product might have been deleted
                        shoppingCart.push({
                            productId: item.productId,
                            productName: item.productName || 'Produk tidak ditemukan',
                            productCode: item.productCode || 'N/A',
                            category: item.category || 'N/A',
                            unit: item.unit || 'pcs',
                            hpp: item.hpp || 0,
                            quantity: item.quantity,
                            price: item.price
                        });
                    }
                });
            }
            
            // Reset product search
            document.getElementById('sale-product-search').value = '';
            document.getElementById('sale-product-search-results').classList.add('hidden');
            document.getElementById('sale-selected-product-info').classList.add('hidden');
            document.getElementById('sale-quantity-price-section').classList.add('hidden');
            
            // Update displays
            updateCartDisplay();
            calculateTaxAndTotal();
            calculateChange();
            
            showModal('sale-modal');
        }

        function deleteSale(saleId) {
            if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?\n\nStok produk akan dikembalikan.')) {
                return;
            }
            
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            
            // Restore stock
            if (sale.items) {
                sale.items.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (product) {
                        product.currentStock += item.quantity;
                        
                        // Add stock movement for restoration
                        stockMovements.push({
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                            productId: item.productId,
                            type: 'in',
                            quantity: item.quantity,
                            date: new Date().toISOString(),
                            note: `Pembatalan penjualan - ${sale.transactionNumber}`
                        });
                    }
                });
            }
            
            // Remove sale and related stock movements
            sales = sales.filter(s => s.id !== saleId);
            stockMovements = stockMovements.filter(m => !m.note.includes(sale.transactionNumber));
            
            saveData();
            renderSales();
            renderProducts();
            updateDashboard();
            alert('Transaksi berhasil dihapus dan stok telah dikembalikan!');
        }

        function filterSales() {
            const dateFrom = document.getElementById('sales-date-from').value;
            const dateTo = document.getElementById('sales-date-to').value;
            
            if (!dateFrom || !dateTo) {
                alert('Silakan pilih rentang tanggal terlebih dahulu!');
                return;
            }
            
            const fromDate = new Date(dateFrom);
            const toDate = new Date(dateTo);
            toDate.setHours(23, 59, 59, 999); // Include the entire end date
            
            filteredSales = sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate >= fromDate && saleDate <= toDate;
            });
            
            renderFilteredSales();
        }

        function renderFilteredSales() {
            const tbody = document.getElementById('sales-table');
            
            if (filteredSales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500">Tidak ada transaksi dalam rentang tanggal yang dipilih.</td></tr>';
                updateFilteredSalesSummary();
                return;
            }

            tbody.innerHTML = filteredSales.map(sale => {
                const itemCount = sale.items ? sale.items.length : 0;
                const statusBadge = getStatusBadge(sale.status);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${sale.transactionNumber}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${formatDate(sale.date)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${sale.customerName || 'Walk-in Customer'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${itemCount} item${itemCount > 1 ? 's' : ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${sale.paymentMethod || 'Tunai'}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${formatCurrency(sale.total)}</td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewSale('${sale.id}')" class="text-blue-600 hover:text-blue-900" title="Lihat Detail">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="printReceipt('${sale.id}')" class="text-green-600 hover:text-green-900" title="Print Struk">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button onclick="editSale('${sale.id}')" class="text-yellow-600 hover:text-yellow-900" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteSale('${sale.id}')" class="text-red-600 hover:text-red-900" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updateFilteredSalesSummary();
        }

        function updateFilteredSalesSummary() {
            const totalCount = filteredSales.length;
            const totalAmount = filteredSales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const avgAmount = totalCount > 0 ? totalAmount / totalCount : 0;

            document.getElementById('total-sales-count').textContent = totalCount;
            document.getElementById('total-sales-amount').textContent = formatCurrency(totalAmount);
            document.getElementById('avg-sales-amount').textContent = formatCurrency(avgAmount);
        }

        // Order Management Functions
        let editingOrderId = null;

        // Order Product Search Functions
        function searchOrderProducts() {
            const searchTerm = document.getElementById('order-product-search').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('order-product-search-results');
            const productSelect = document.getElementById('order-product');
            
            if (searchTerm.length < 2) {
                resultsContainer.classList.add('hidden');
                // Reset select to show all products
                populateOrderProductSelect();
                return;
            }
            
            // Filter products based on search term
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.code.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm)
            );
            
            if (filteredProducts.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p>Tidak ada produk yang ditemukan untuk "${searchTerm}"</p>
                        <p class="text-sm mt-1">Coba kata kunci lain atau periksa ejaan</p>
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                
                // Clear select options
                productSelect.innerHTML = '<option value="">Tidak ada produk yang cocok</option>';
                return;
            }
            
            // Show search results in dropdown
            resultsContainer.innerHTML = filteredProducts.map(product => {
                const stockStatus = product.currentStock <= settings.minStockLimit ? 
                    '<span class="text-red-600 text-xs font-medium">⚠️ Stok Rendah</span>' : 
                    '<span class="text-green-600 text-xs font-medium">✅ Normal</span>';
                
                const stockColor = product.currentStock <= settings.minStockLimit ? 'text-red-600' : 'text-green-600';
                
                return `
                    <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
                         onclick="selectOrderProduct('${product.id}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${product.name}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    <span class="font-mono bg-gray-100 px-2 py-1 rounded">${product.code}</span> • 
                                    <span class="text-blue-600">${product.category}</span>
                                </div>
                                <div class="text-sm text-gray-600 mt-1">
                                    <span class="font-medium ${stockColor}">${product.currentStock} ${product.unit}</span> • 
                                    <span>HPP: ${formatCurrency(product.hpp)}</span>
                                </div>
                            </div>
                            <div class="text-right ml-3">
                                ${stockStatus}
                                <div class="text-xs text-gray-500 mt-1">${formatCurrency(product.currentStock * product.hpp)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.classList.remove('hidden');
            
            // Update select with filtered products
            productSelect.innerHTML = '<option value="">Pilih dari hasil pencarian</option>' +
                filteredProducts.map(p => `<option value="${p.id}" data-stock="${p.currentStock}" data-unit="${p.unit}">${p.name} (${p.code}) - Stok: ${p.currentStock} ${p.unit}</option>`).join('');
        }
        
        function selectOrderProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Set the search input to show selected product
            document.getElementById('order-product-search').value = `${product.name} (${product.code})`;
            
            // Set the select value
            document.getElementById('order-product').value = productId;
            
            // Hide search results
            document.getElementById('order-product-search-results').classList.add('hidden');
            
            // Update product info
            updateOrderProductInfo();
        }
        
        function handleOrderSearchKeydown(event) {
            const resultsContainer = document.getElementById('order-product-search-results');
            
            if (event.key === 'Escape') {
                resultsContainer.classList.add('hidden');
                event.target.blur();
            } else if (event.key === 'Enter') {
                event.preventDefault();
                const firstResult = resultsContainer.querySelector('[onclick]');
                if (firstResult) {
                    firstResult.click();
                }
            }
        }
        
        function populateOrderProductSelect() {
            try {
                const select = document.getElementById('order-product');
                if (!select) return;
                
                select.innerHTML = '<option value="">Pilih produk untuk order</option>' +
                    products.map(p => `<option value="${p.id}" data-stock="${p.currentStock}" data-unit="${p.unit}">${p.name} (${p.code}) - Stok: ${p.currentStock} ${p.unit}</option>`).join('');
            } catch (error) {
                console.error('Error in populateOrderProductSelect:', error);
            }
        }

        function renderOrders() {
            const tbody = document.getElementById('orders-table');
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada order. Klik "Buat Order" untuk memulai.</td></tr>';
                return;
            }

            // Filter orders based on current filter
            let filteredOrders = orders;
            if (currentOrderFilter !== 'all') {
                filteredOrders = orders.filter(order => order.status === currentOrderFilter);
            }

            if (filteredOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Tidak ada order dengan status yang dipilih.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredOrders.map(order => {
                const product = products.find(p => p.id === order.productId);
                const productName = product ? product.name : 'Produk tidak ditemukan';
                const statusBadge = getOrderStatusBadge(order.status);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${order.orderNumber}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${formatDate(order.date)}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-900">${productName}</div>
                            <div class="text-sm text-gray-500">${product ? product.code : 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${order.quantity} ${product ? product.unit : 'pcs'}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewOrder('${order.id}')" class="text-blue-600 hover:text-blue-900" title="Lihat Detail">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${order.status === 'pending' ? `
                                    <button onclick="approveOrder('${order.id}')" class="text-green-600 hover:text-green-900" title="Setujui">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button onclick="rejectOrder('${order.id}')" class="text-red-600 hover:text-red-900" title="Tolak">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                                <button onclick="editOrder('${order.id}')" class="text-yellow-600 hover:text-yellow-900" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteOrder('${order.id}')" class="text-red-600 hover:text-red-900" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getOrderStatusBadge(status) {
            const statusClasses = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'approved': 'bg-green-100 text-green-800',
                'rejected': 'bg-red-100 text-red-800',
                'completed': 'bg-blue-100 text-blue-800'
            };
            
            const statusText = {
                'pending': 'Menunggu Approval',
                'approved': 'Disetujui',
                'rejected': 'Ditolak',
                'completed': 'Selesai'
            };

            const className = statusClasses[status] || 'bg-gray-100 text-gray-800';
            const text = statusText[status] || status;
            
            return `<span class="px-2 py-1 text-xs font-semibold ${className} rounded-full">${text}</span>`;
        }

        function filterOrders(status) {
            currentOrderFilter = status;
            
            // Update tab buttons
            document.querySelectorAll('.order-tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            event.target.classList.remove('border-transparent', 'text-gray-500');
            event.target.classList.add('border-blue-500', 'text-blue-600');
            
            renderOrders();
        }

        function showCreateOrderModal() {
            editingOrderId = null;
            document.getElementById('order-form').reset();
            
            // Generate order number
            const orderNumber = generateOrderNumber();
            document.getElementById('order-number').value = orderNumber;
            
            // Set current date
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('order-date').value = today;
            
            // Set default status
            document.getElementById('order-status').value = 'pending';
            
            showModal('order-modal');
        }

        function generateOrderNumber() {
            const today = new Date();
            const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = today.getHours().toString().padStart(2, '0') + today.getMinutes().toString().padStart(2, '0');
            const randomStr = Math.random().toString(36).substr(2, 3).toUpperCase();
            return `ORD${dateStr}${timeStr}${randomStr}`;
        }

        function updateOrderProductInfo() {
            const productSelect = document.getElementById('order-product');
            const productInfo = document.getElementById('order-product-info');
            const quantityInfo = document.getElementById('order-quantity-info');
            
            if (!productSelect.value) {
                productInfo.classList.add('hidden');
                quantityInfo.textContent = 'Pilih produk terlebih dahulu';
                return;
            }
            
            const product = products.find(p => p.id === productSelect.value);
            if (!product) return;
            
            // Show enhanced product info with stock status
            const stockStatusClass = product.currentStock <= settings.minStockLimit ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200';
            const stockStatusIcon = product.currentStock <= settings.minStockLimit ? '⚠️' : '✅';
            const stockStatusText = product.currentStock <= settings.minStockLimit ? 'STOK RENDAH' : 'STOK NORMAL';
            
            productInfo.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h4 class="font-semibold text-blue-800 mb-3">📦 Informasi Produk</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-700">Kode:</span>
                                <span class="text-sm text-gray-900 font-mono">${product.code}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-700">Kategori:</span>
                                <span class="text-sm text-gray-900">${product.category}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-700">Satuan:</span>
                                <span class="text-sm text-gray-900">${product.unit}</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-700">HPP:</span>
                                <span class="text-sm text-gray-900 font-semibold">${formatCurrency(product.hpp)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-700">Harga Jual:</span>
                                <span class="text-sm text-gray-900 font-semibold">${formatCurrency(product.price)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm font-medium text-gray-700">Nilai Stok:</span>
                                <span class="text-sm text-gray-900 font-semibold">${formatCurrency(product.currentStock * product.hpp)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-3 ${stockStatusClass} rounded-lg border">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Status Stok:</span>
                            <span class="text-sm font-bold">${stockStatusIcon} ${stockStatusText}</span>
                        </div>
                        <div class="flex items-center justify-between mt-1">
                            <span class="text-sm font-medium text-gray-700">Stok Saat Ini:</span>
                            <span class="text-lg font-bold ${product.currentStock <= settings.minStockLimit ? 'text-red-600' : 'text-green-600'}">${product.currentStock} ${product.unit}</span>
                        </div>
                    </div>
                </div>
            `;
            productInfo.classList.remove('hidden');
            
            // Update quantity info with recommendations
            let quantityText = '';
            if (product.currentStock <= settings.minStockLimit) {
                const recommendedOrder = Math.max(50, product.currentStock * 2);
                quantityText = `⚠️ Stok rendah! Disarankan order minimal ${recommendedOrder} ${product.unit}`;
            } else {
                quantityText = `✅ Stok mencukupi. Masukkan jumlah sesuai kebutuhan.`;
            }
            quantityInfo.innerHTML = quantityText;
            quantityInfo.className = product.currentStock <= settings.minStockLimit ? 
                'mt-1 text-xs text-red-600 font-medium' : 
                'mt-1 text-xs text-green-600';
        }

        function handleOrderSubmit(e) {
            e.preventDefault();
            
            // Collect form data
            const orderData = {
                orderNumber: document.getElementById('order-number').value.trim(),
                date: new Date(document.getElementById('order-date').value).toISOString(),
                productId: document.getElementById('order-product').value,
                quantity: parseInt(document.getElementById('order-quantity').value),
                status: document.getElementById('order-status').value,
                notes: document.getElementById('order-notes').value.trim() || null,
                requestedBy: document.getElementById('requested-by').value.trim(),
                supplier: document.getElementById('supplier').value.trim() || null,
                estimatedCost: parseFloat(document.getElementById('estimated-cost').value) || 0
            };

            // Enhanced validation
            const validationErrors = [];
            
            if (!orderData.orderNumber) {
                validationErrors.push('• Nomor order tidak boleh kosong');
            }
            
            if (!orderData.productId) {
                validationErrors.push('• Produk harus dipilih');
            }
            
            if (!orderData.quantity || orderData.quantity <= 0) {
                validationErrors.push('• Jumlah order harus lebih dari 0');
            }
            
            if (!orderData.requestedBy) {
                validationErrors.push('• Nama peminta harus diisi');
            }

            if (validationErrors.length > 0) {
                alert(`❌ VALIDASI GAGAL!\n\nSilakan perbaiki kesalahan berikut:\n${validationErrors.join('\n')}`);
                return;
            }

            // Get product info for validation and display
            const product = products.find(p => p.id === orderData.productId);
            if (!product) {
                alert('❌ Produk tidak ditemukan! Silakan refresh halaman dan coba lagi.');
                return;
            }

            // Check for duplicate order number (only for new orders)
            if (!editingOrderId) {
                const existingOrder = orders.find(o => o.orderNumber === orderData.orderNumber);
                if (existingOrder) {
                    // Auto-generate new unique order number
                    let attempts = 0;
                    do {
                        orderData.orderNumber = generateOrderNumber();
                        attempts++;
                    } while (orders.find(o => o.orderNumber === orderData.orderNumber) && attempts < 10);
                    
                    if (attempts >= 10) {
                        alert('❌ Gagal generate nomor order unik. Silakan coba lagi.');
                        return;
                    }
                }
            }

            // Calculate estimated cost if not provided
            if (orderData.estimatedCost === 0 && product.hpp > 0) {
                orderData.estimatedCost = product.hpp * orderData.quantity;
            }

            if (editingOrderId) {
                // Update existing order
                const orderIndex = orders.findIndex(o => o.id === editingOrderId);
                if (orderIndex === -1) {
                    alert('❌ Order tidak ditemukan untuk diupdate!');
                    return;
                }
                
                const oldOrder = orders[orderIndex];
                orders[orderIndex] = { 
                    ...oldOrder, 
                    ...orderData, 
                    updatedAt: new Date().toISOString(),
                    updatedBy: orderData.requestedBy
                };
                
                // Add activity record for update
                const updateNote = `Order diupdate - ${product.name} (${orderData.quantity} ${product.unit}) oleh ${orderData.requestedBy}`;
                
                alert(`✅ ORDER BERHASIL DIPERBARUI!\n\n📋 Detail Order:\n• No. Order: ${orderData.orderNumber}\n• Produk: ${product.name} (${product.code})\n• Kategori: ${product.category}\n• Jumlah: ${orderData.quantity} ${product.unit}\n• Status: ${getOrderStatusText(orderData.status)}\n• Diminta oleh: ${orderData.requestedBy}\n• Supplier: ${orderData.supplier || 'Belum ditentukan'}\n• Estimasi Biaya: ${formatCurrency(orderData.estimatedCost)}\n• Tanggal Update: ${formatDate(new Date().toISOString())}\n\n${orderData.notes ? `📝 Catatan: ${orderData.notes}\n\n` : ''}💡 Perubahan telah disimpan dan dapat dilihat di daftar order.`);
            } else {
                // Create new order
                const newOrder = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    ...orderData,
                    createdAt: new Date().toISOString(),
                    createdBy: orderData.requestedBy
                };
                orders.push(newOrder);
                
                // Add stock movement record for tracking
                stockMovements.push({
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    productId: orderData.productId,
                    type: 'order_created',
                    quantity: 0, // No stock change yet
                    date: new Date().toISOString(),
                    note: `Order dibuat - ${orderData.orderNumber} (${orderData.quantity} ${product.unit}) oleh ${orderData.requestedBy}`
                });
                
                // Determine next steps message based on status
                let nextStepsMsg = '';
                if (orderData.status === 'pending') {
                    nextStepsMsg = '\n🔄 LANGKAH SELANJUTNYA:\n• Order menunggu approval dari supervisor\n• Cek status di menu Order Management\n• Stok akan ditambah setelah disetujui';
                } else if (orderData.status === 'approved') {
                    nextStepsMsg = '\n✅ Order langsung disetujui\n• Stok dapat ditambahkan melalui approval\n• Atau tambah manual di Kartu Stok';
                }
                
                alert(`🎉 ORDER BERHASIL DIBUAT!\n\n📋 Detail Order:\n• No. Order: ${orderData.orderNumber}\n• Produk: ${product.name} (${product.code})\n• Kategori: ${product.category}\n• Stok Saat Ini: ${product.currentStock} ${product.unit}\n• Jumlah Order: ${orderData.quantity} ${product.unit}\n• Status: ${getOrderStatusText(orderData.status)}\n• Diminta oleh: ${orderData.requestedBy}\n• Supplier: ${orderData.supplier || 'Belum ditentukan'}\n• Estimasi Biaya: ${formatCurrency(orderData.estimatedCost)}\n• Tanggal Dibuat: ${formatDate(orderData.date)}\n\n${orderData.notes ? `📝 Catatan: ${orderData.notes}\n` : ''}${nextStepsMsg}`);
            }

            saveData();
            closeModal('order-modal');
            renderOrders();
            updateDashboard();
            populateProductSelects();
        }

        function getOrderStatusText(status) {
            const statusText = {
                'pending': '⏳ Menunggu Approval',
                'approved': '✅ Disetujui',
                'rejected': '❌ Ditolak',
                'completed': '🎉 Selesai'
            };
            return statusText[status] || status;
        }

        function viewOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                alert('❌ Order tidak ditemukan!');
                return;
            }
            
            const product = products.find(p => p.id === order.productId);
            const productName = product ? product.name : 'Produk tidak ditemukan';
            
            // Enhanced order details view
            let details = `📋 DETAIL ORDER LENGKAP\n\n`;
            
            // Header Information
            details += `🆔 IDENTITAS ORDER:\n`;
            details += `• No. Order: ${order.orderNumber}\n`;
            details += `• Tanggal Dibuat: ${formatDate(order.createdAt)}\n`;
            details += `• Dibuat oleh: ${order.createdBy || order.requestedBy}\n`;
            
            // Product Information
            details += `\n📦 INFORMASI PRODUK:\n`;
            details += `• Nama: ${productName}\n`;
            details += `• Kode: ${product ? product.code : 'N/A'}\n`;
            details += `• Kategori: ${product ? product.category : 'N/A'}\n`;
            details += `• Satuan: ${product ? product.unit : 'pcs'}\n`;
            
            // Order Details
            details += `\n📊 DETAIL ORDER:\n`;
            details += `• Jumlah Order: ${order.quantity} ${product ? product.unit : 'pcs'}\n`;
            details += `• Diminta oleh: ${order.requestedBy}\n`;
            details += `• Supplier: ${order.supplier || 'Belum ditentukan'}\n`;
            details += `• Estimasi Biaya: ${formatCurrency(order.estimatedCost)}\n`;
            
            // Current Stock Information
            if (product) {
                details += `\n📈 INFO STOK SAAT INI:\n`;
                details += `• Stok Tersedia: ${product.currentStock} ${product.unit}\n`;
                details += `• Status Stok: ${product.currentStock <= settings.minStockLimit ? '⚠️ Stok Rendah' : '✅ Stok Normal'}\n`;
                details += `• HPP per Unit: ${formatCurrency(product.hpp)}\n`;
                details += `• Harga Jual: ${formatCurrency(product.price)}\n`;
                details += `• Nilai Stok Saat Ini: ${formatCurrency(product.currentStock * product.hpp)}\n`;
                details += `• Nilai Order: ${formatCurrency(order.quantity * product.hpp)}\n`;
            }
            
            // Status Information with enhanced details
            const statusEmoji = {
                'pending': '⏳',
                'approved': '✅',
                'rejected': '❌',
                'completed': '🎉'
            };
            const statusText = {
                'pending': 'Menunggu Approval',
                'approved': 'Disetujui',
                'rejected': 'Ditolak',
                'completed': 'Selesai'
            };
            
            details += `\n🏷️ STATUS ORDER:\n`;
            details += `• Status: ${statusEmoji[order.status] || '📋'} ${statusText[order.status] || order.status}\n`;
            
            // Approval Details
            if (order.approvedBy) {
                details += `\n✅ DETAIL APPROVAL:\n`;
                details += `• Disetujui oleh: ${order.approvedBy}\n`;
                details += `• Tanggal Approval: ${formatDate(order.approvedAt)}\n`;
                details += `• Stok Ditambahkan: ${order.stockAdded ? 'Ya' : 'Belum'}\n`;
                if (order.stockAdded && order.completedAt) {
                    details += `• Tanggal Selesai: ${formatDate(order.completedAt)}\n`;
                    details += `• Biaya Aktual: ${formatCurrency(order.actualCost || order.estimatedCost)}\n`;
                }
            }
            
            // Rejection Details
            if (order.rejectedBy) {
                details += `\n❌ DETAIL PENOLAKAN:\n`;
                details += `• Ditolak oleh: ${order.rejectedBy}\n`;
                details += `• Tanggal Penolakan: ${formatDate(order.rejectedAt)}\n`;
                details += `• Alasan Penolakan:\n  "${order.rejectionReason}"\n`;
            }
            
            // Notes
            if (order.notes) {
                details += `\n📝 CATATAN ORDER:\n`;
                details += `"${order.notes}"\n`;
            }
            
            // Timeline
            details += `\n⏰ TIMELINE ORDER:\n`;
            details += `• 📅 Dibuat: ${formatDate(order.createdAt)}\n`;
            
            if (order.updatedAt && order.updatedAt !== order.createdAt) {
                details += `• ✏️ Diupdate: ${formatDate(order.updatedAt)}\n`;
                if (order.updatedBy) {
                    details += `  oleh: ${order.updatedBy}\n`;
                }
            }
            
            if (order.approvedAt) {
                details += `• ✅ Disetujui: ${formatDate(order.approvedAt)}\n`;
                details += `  oleh: ${order.approvedBy}\n`;
            }
            
            if (order.rejectedAt) {
                details += `• ❌ Ditolak: ${formatDate(order.rejectedAt)}\n`;
                details += `  oleh: ${order.rejectedBy}\n`;
            }
            
            if (order.completedAt) {
                details += `• 🎉 Selesai: ${formatDate(order.completedAt)}\n`;
            }
            
            // Action Recommendations
            details += `\n💡 REKOMENDASI:\n`;
            if (order.status === 'pending') {
                details += `• Order menunggu approval dari supervisor\n`;
                details += `• Dapat disetujui atau ditolak melalui tombol aksi\n`;
                details += `• Dapat diedit jika diperlukan perubahan\n`;
            } else if (order.status === 'approved' && !order.stockAdded) {
                details += `• Order sudah disetujui tapi stok belum ditambah\n`;
                details += `• Tambahkan stok melalui menu Kartu Stok\n`;
                details += `• Atau approve ulang untuk menambah stok otomatis\n`;
            } else if (order.status === 'rejected') {
                details += `• Order ditolak, dapat diedit dan diajukan ulang\n`;
                details += `• Hubungi peminta untuk memberitahu penolakan\n`;
                details += `• Pertimbangkan solusi alternatif\n`;
            } else if (order.status === 'completed') {
                details += `• Order telah selesai dan stok sudah ditambahkan\n`;
                details += `• Data tersimpan untuk referensi dan audit\n`;
                details += `• Dapat dilihat di laporan pergerakan stok\n`;
            }
            
            alert(details);
        }

        function editOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            editingOrderId = orderId;
            
            document.getElementById('order-number').value = order.orderNumber;
            document.getElementById('order-date').value = new Date(order.date).toISOString().slice(0, 10);
            document.getElementById('order-product').value = order.productId;
            document.getElementById('order-quantity').value = order.quantity;
            document.getElementById('order-status').value = order.status;
            document.getElementById('order-notes').value = order.notes || '';
            document.getElementById('requested-by').value = order.requestedBy || '';
            document.getElementById('supplier').value = order.supplier || '';
            document.getElementById('estimated-cost').value = order.estimatedCost || '';
            
            // Update product info after setting the product
            setTimeout(() => {
                updateOrderProductInfo();
            }, 100);
            
            showModal('order-modal');
        }

        function approveOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                alert('❌ Order tidak ditemukan!');
                return;
            }
            
            const product = products.find(p => p.id === order.productId);
            if (!product) {
                alert('❌ Produk tidak ditemukan! Order mungkin menggunakan produk yang sudah dihapus.');
                return;
            }
            
            // Enhanced approval dialog with more details
            let approvalDialog = `🔍 APPROVAL ORDER\n\n`;
            approvalDialog += `📋 DETAIL ORDER:\n`;
            approvalDialog += `• No. Order: ${order.orderNumber}\n`;
            approvalDialog += `• Tanggal Order: ${formatDate(order.date)}\n`;
            approvalDialog += `• Produk: ${product.name} (${product.code})\n`;
            approvalDialog += `• Kategori: ${product.category}\n`;
            approvalDialog += `• Jumlah Order: ${order.quantity} ${product.unit}\n`;
            approvalDialog += `• Diminta oleh: ${order.requestedBy}\n`;
            approvalDialog += `• Supplier: ${order.supplier || 'Belum ditentukan'}\n`;
            approvalDialog += `• Estimasi Biaya: ${formatCurrency(order.estimatedCost)}\n`;
            
            approvalDialog += `\n📊 INFO STOK SAAT INI:\n`;
            approvalDialog += `• Stok Tersedia: ${product.currentStock} ${product.unit}\n`;
            approvalDialog += `• Status: ${product.currentStock <= settings.minStockLimit ? '⚠️ Stok Rendah' : '✅ Stok Normal'}\n`;
            approvalDialog += `• Nilai Stok: ${formatCurrency(product.currentStock * product.hpp)}\n`;
            
            if (order.notes) {
                approvalDialog += `\n📝 Catatan: ${order.notes}\n`;
            }
            
            approvalDialog += `\n👤 Masukkan nama Anda sebagai approver:`;
            
            const approver = prompt(approvalDialog);
            
            if (!approver || approver.trim() === '') {
                alert('❌ Nama approver harus diisi untuk melanjutkan approval!');
                return;
            }
            
            // Update order status
            order.status = 'approved';
            order.approvedBy = approver.trim();
            order.approvedAt = new Date().toISOString();
            
            // Enhanced stock addition dialog
            let stockDialog = `✅ ORDER DISETUJUI!\n\nApprover: ${approver}\n\n`;
            stockDialog += `📦 PENAMBAHAN STOK\n\n`;
            stockDialog += `Apakah Anda ingin menambahkan stok produk sekarang?\n\n`;
            stockDialog += `📋 Detail Penambahan:\n`;
            stockDialog += `• Produk: ${product.name} (${product.code})\n`;
            stockDialog += `• Jumlah yang akan ditambah: ${order.quantity} ${product.unit}\n`;
            stockDialog += `• Stok saat ini: ${product.currentStock} ${product.unit}\n`;
            stockDialog += `• Stok setelah ditambah: ${product.currentStock + order.quantity} ${product.unit}\n`;
            stockDialog += `• Nilai tambahan: ${formatCurrency(order.quantity * product.hpp)}\n`;
            stockDialog += `• Total nilai stok: ${formatCurrency((product.currentStock + order.quantity) * product.hpp)}\n\n`;
            stockDialog += `Pilih:\n• OK = Tambah stok sekarang (order selesai)\n• Cancel = Approve saja (stok ditambah nanti)`;
            
            const addStock = confirm(stockDialog);
            
            if (addStock) {
                const oldStock = product.currentStock;
                const oldStockValue = oldStock * product.hpp;
                product.currentStock += order.quantity;
                const newStockValue = product.currentStock * product.hpp;
                
                // Add comprehensive stock movement record
                stockMovements.push({
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    productId: order.productId,
                    type: 'in',
                    quantity: order.quantity,
                    date: new Date().toISOString(),
                    note: `Order approved & completed - ${order.orderNumber} | Approver: ${approver} | Supplier: ${order.supplier || 'N/A'}`
                });
                
                // Mark order as completed
                order.status = 'completed';
                order.completedAt = new Date().toISOString();
                order.stockAdded = true;
                order.actualCost = order.estimatedCost; // Can be updated later if needed
                
                // Success message with comprehensive details
                let successMsg = `🎉 ORDER SELESAI!\n\n`;
                successMsg += `✅ Order disetujui dan stok telah ditambahkan!\n\n`;
                successMsg += `📋 RINGKASAN ORDER:\n`;
                successMsg += `• No. Order: ${order.orderNumber}\n`;
                successMsg += `• Produk: ${product.name} (${product.code})\n`;
                successMsg += `• Jumlah: ${order.quantity} ${product.unit}\n`;
                successMsg += `• Approver: ${approver}\n`;
                successMsg += `• Tanggal Approval: ${formatDate(order.approvedAt)}\n`;
                successMsg += `• Tanggal Selesai: ${formatDate(order.completedAt)}\n`;
                
                successMsg += `\n📊 UPDATE STOK:\n`;
                successMsg += `• Stok sebelum: ${oldStock} ${product.unit}\n`;
                successMsg += `• Stok ditambah: ${order.quantity} ${product.unit}\n`;
                successMsg += `• Stok sekarang: ${product.currentStock} ${product.unit}\n`;
                
                successMsg += `\n💰 NILAI STOK:\n`;
                successMsg += `• Nilai sebelum: ${formatCurrency(oldStockValue)}\n`;
                successMsg += `• Nilai ditambah: ${formatCurrency(order.quantity * product.hpp)}\n`;
                successMsg += `• Nilai sekarang: ${formatCurrency(newStockValue)}\n`;
                successMsg += `• Estimasi Biaya Order: ${formatCurrency(order.estimatedCost)}\n`;
                
                alert(successMsg);
            } else {
                // Just approve without adding stock
                let approvalMsg = `✅ ORDER DISETUJUI!\n\n`;
                approvalMsg += `📋 Detail Approval:\n`;
                approvalMsg += `• No. Order: ${order.orderNumber}\n`;
                approvalMsg += `• Produk: ${product.name} (${product.code})\n`;
                approvalMsg += `• Jumlah: ${order.quantity} ${product.unit}\n`;
                approvalMsg += `• Approver: ${approver}\n`;
                approvalMsg += `• Tanggal Approval: ${formatDate(order.approvedAt)}\n`;
                approvalMsg += `• Status: Disetujui (stok belum ditambah)\n\n`;
                approvalMsg += `💡 LANGKAH SELANJUTNYA:\n`;
                approvalMsg += `• Stok dapat ditambahkan melalui menu "Kartu Stok"\n`;
                approvalMsg += `• Atau approve ulang order ini untuk menambah stok\n`;
                approvalMsg += `• Order akan otomatis selesai setelah stok ditambahkan`;
                
                alert(approvalMsg);
            }
            
            saveData();
            renderOrders();
            renderProducts();
            updateDashboard();
            populateProductSelects();
        }

        function rejectOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) {
                alert('❌ Order tidak ditemukan!');
                return;
            }
            
            const product = products.find(p => p.id === order.productId);
            if (!product) {
                alert('❌ Produk tidak ditemukan! Order mungkin menggunakan produk yang sudah dihapus.');
                return;
            }
            
            // Enhanced rejection dialog with complete order details
            let rejectionDialog = `❌ PENOLAKAN ORDER\n\n`;
            rejectionDialog += `📋 DETAIL ORDER:\n`;
            rejectionDialog += `• No. Order: ${order.orderNumber}\n`;
            rejectionDialog += `• Tanggal Order: ${formatDate(order.date)}\n`;
            rejectionDialog += `• Produk: ${product.name} (${product.code})\n`;
            rejectionDialog += `• Kategori: ${product.category}\n`;
            rejectionDialog += `• Jumlah: ${order.quantity} ${product.unit}\n`;
            rejectionDialog += `• Diminta oleh: ${order.requestedBy}\n`;
            rejectionDialog += `• Supplier: ${order.supplier || 'Belum ditentukan'}\n`;
            rejectionDialog += `• Estimasi Biaya: ${formatCurrency(order.estimatedCost)}\n`;
            
            rejectionDialog += `\n📊 INFO STOK:\n`;
            rejectionDialog += `• Stok Saat Ini: ${product.currentStock} ${product.unit}\n`;
            rejectionDialog += `• Status: ${product.currentStock <= settings.minStockLimit ? '⚠️ Stok Rendah' : '✅ Stok Normal'}\n`;
            
            if (order.notes) {
                rejectionDialog += `\n📝 Catatan Order: ${order.notes}\n`;
            }
            
            rejectionDialog += `\n👤 Masukkan nama Anda sebagai yang menolak:`;
            
            const rejector = prompt(rejectionDialog);
            
            if (!rejector || rejector.trim() === '') {
                alert('❌ Nama yang menolak harus diisi untuk melanjutkan penolakan!');
                return;
            }
            
            // Enhanced reason dialog
            let reasonDialog = `📝 ALASAN PENOLAKAN\n\n`;
            reasonDialog += `Order: ${order.orderNumber}\n`;
            reasonDialog += `Produk: ${product.name} (${product.code})\n`;
            reasonDialog += `Diminta oleh: ${order.requestedBy}\n`;
            reasonDialog += `Ditolak oleh: ${rejector}\n\n`;
            reasonDialog += `Masukkan alasan penolakan yang jelas:\n`;
            reasonDialog += `(Contoh: Budget tidak tersedia, Supplier tidak ready, Stok masih cukup, dll)`;
            
            const reason = prompt(reasonDialog);
            
            if (!reason || reason.trim() === '') {
                alert('❌ Alasan penolakan harus diisi! Penolakan dibatalkan.');
                return;
            }
            
            // Update order with rejection details
            order.status = 'rejected';
            order.rejectedBy = rejector.trim();
            order.rejectedAt = new Date().toISOString();
            order.rejectionReason = reason.trim();
            
            // Add stock movement record for tracking
            stockMovements.push({
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                productId: order.productId,
                type: 'order_rejected',
                quantity: 0, // No stock change
                date: new Date().toISOString(),
                note: `Order rejected - ${order.orderNumber} | Rejected by: ${rejector} | Reason: ${reason.substring(0, 50)}${reason.length > 50 ? '...' : ''}`
            });
            
            saveData();
            renderOrders();
            
            // Comprehensive rejection confirmation
            let rejectionMsg = `❌ ORDER DITOLAK!\n\n`;
            rejectionMsg += `📋 DETAIL PENOLAKAN:\n`;
            rejectionMsg += `• No. Order: ${order.orderNumber}\n`;
            rejectionMsg += `• Produk: ${product.name} (${product.code})\n`;
            rejectionMsg += `• Kategori: ${product.category}\n`;
            rejectionMsg += `• Jumlah: ${order.quantity} ${product.unit}\n`;
            rejectionMsg += `• Diminta oleh: ${order.requestedBy}\n`;
            rejectionMsg += `• Ditolak oleh: ${rejector}\n`;
            rejectionMsg += `• Tanggal Penolakan: ${formatDate(order.rejectedAt)}\n`;
            rejectionMsg += `• Estimasi Biaya: ${formatCurrency(order.estimatedCost)}\n\n`;
            rejectionMsg += `📝 ALASAN PENOLAKAN:\n${reason}\n\n`;
            rejectionMsg += `💡 OPSI SELANJUTNYA:\n`;
            rejectionMsg += `• Order yang ditolak dapat diedit dan diajukan ulang\n`;
            rejectionMsg += `• Hubungi ${order.requestedBy} untuk memberitahu penolakan\n`;
            rejectionMsg += `• Pertimbangkan alternatif solusi jika memungkinkan\n`;
            rejectionMsg += `• Order tetap tersimpan untuk referensi`;
            
            alert(rejectionMsg);
        }

        function deleteOrder(orderId) {
            if (!confirm('Apakah Anda yakin ingin menghapus order ini?')) {
                return;
            }
            
            orders = orders.filter(o => o.id !== orderId);
            saveData();
            renderOrders();
            alert('Order berhasil dihapus!');
        }

        // Stock Card Search Functions
        function searchStockCardProducts() {
            const searchTerm = document.getElementById('stock-card-search').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('stock-card-search-results');
            const productSelect = document.getElementById('stock-card-product');
            
            if (searchTerm.length < 2) {
                resultsContainer.classList.add('hidden');
                // Reset select to show all products
                populateStockCardProducts();
                return;
            }
            
            // Filter products based on search term
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.code.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm)
            );
            
            if (filteredProducts.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p>Tidak ada produk yang ditemukan untuk "${searchTerm}"</p>
                        <p class="text-sm mt-1">Coba kata kunci lain atau periksa ejaan</p>
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                
                // Clear select options
                productSelect.innerHTML = '<option value="">Tidak ada produk yang cocok</option>';
                return;
            }
            
            // Show search results in dropdown
            resultsContainer.innerHTML = filteredProducts.map(product => {
                const stockStatus = product.currentStock <= settings.minStockLimit ? 
                    '<span class="text-red-600 text-xs">⚠️ Stok Rendah</span>' : 
                    '<span class="text-green-600 text-xs">✅ Normal</span>';
                
                return `
                    <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0" 
                         onclick="selectStockCardProduct('${product.id}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${product.name}</div>
                                <div class="text-sm text-gray-600">
                                    <span class="font-mono">${product.code}</span> • 
                                    <span>${product.category}</span> • 
                                    <span>${product.currentStock} ${product.unit}</span>
                                </div>
                            </div>
                            <div class="text-right ml-3">
                                ${stockStatus}
                                <div class="text-xs text-gray-500 mt-1">${formatCurrency(product.currentStock * product.hpp)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsContainer.classList.remove('hidden');
            
            // Update select with filtered products
            productSelect.innerHTML = '<option value="">Pilih dari hasil pencarian</option>' +
                filteredProducts.map(p => `<option value="${p.id}">${p.name} (${p.code}) - Stok: ${p.currentStock}</option>`).join('');
        }
        
        function selectStockCardProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Set the search input to show selected product
            document.getElementById('stock-card-search').value = `${product.name} (${product.code})`;
            
            // Set the select value
            document.getElementById('stock-card-product').value = productId;
            
            // Hide search results
            document.getElementById('stock-card-search-results').classList.add('hidden');
            
            // Load the stock card for selected product
            loadStockCard();
        }
        
        function handleStockCardSearchKeydown(event) {
            const resultsContainer = document.getElementById('stock-card-search-results');
            
            if (event.key === 'Escape') {
                resultsContainer.classList.add('hidden');
                event.target.blur();
            } else if (event.key === 'Enter') {
                event.preventDefault();
                const firstResult = resultsContainer.querySelector('[onclick]');
                if (firstResult) {
                    firstResult.click();
                }
            }
        }
        
        function populateStockCardProducts() {
            try {
                const select = document.getElementById('stock-card-product');
                if (!select) return;
                
                select.innerHTML = '<option value="">Pilih produk untuk melihat kartu stok</option>' +
                    products.map(p => `<option value="${p.id}">${p.name} (${p.code}) - Stok: ${p.currentStock}</option>`).join('');
            } catch (error) {
                console.error('Error in populateStockCardProducts:', error);
            }
        }
        
        // Stock Card Functions
        function loadStockCard() {
            const selectedProductId = document.getElementById('stock-card-product').value;
            
            if (!selectedProductId) {
                document.getElementById('stock-card-product-info').classList.add('hidden');
                document.getElementById('stock-card-table').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">Pilih produk untuk melihat kartu stok</td>
                    </tr>
                `;
                return;
            }

            const product = products.find(p => p.id === selectedProductId);
            if (!product) return;

            // Show product info
            const productInfo = document.getElementById('stock-card-product-info');
            productInfo.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-semibold text-blue-800">Kode Produk</h4>
                        <p class="text-lg font-bold text-blue-600">${product.code}</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <h4 class="font-semibold text-green-800">Stok Saat Ini</h4>
                        <p class="text-lg font-bold text-green-600">${product.currentStock} ${product.unit}</p>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <h4 class="font-semibold text-purple-800">HPP</h4>
                        <p class="text-lg font-bold text-purple-600">${formatCurrency(product.hpp)}</p>
                    </div>
                    <div class="text-center p-4 bg-orange-50 rounded-lg">
                        <h4 class="font-semibold text-orange-800">Nilai Stok</h4>
                        <p class="text-lg font-bold text-orange-600">${formatCurrency(product.currentStock * product.hpp)}</p>
                    </div>
                </div>
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2">${product.name}</h4>
                    <p class="text-gray-600">Kategori: ${product.category} | Harga Jual: ${formatCurrency(product.price)}</p>
                    ${product.description ? `<p class="text-gray-600 mt-1">${product.description}</p>` : ''}
                </div>
            `;
            productInfo.classList.remove('hidden');

            // Get stock movements for this product
            const productMovements = stockMovements
                .filter(m => m.productId === selectedProductId)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            const tbody = document.getElementById('stock-card-table');
            
            if (productMovements.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada pergerakan stok untuk produk ini</td>
                    </tr>
                `;
                return;
            }

            // Calculate running balance
            let runningBalance = 0;
            const tableRows = productMovements.map(movement => {
                if (movement.type === 'in') {
                    runningBalance += movement.quantity;
                } else {
                    runningBalance -= movement.quantity;
                }

                const stockValue = runningBalance * product.hpp;
                const typeIcon = movement.type === 'in' ? 
                    '<i class="fas fa-arrow-up text-green-600"></i>' : 
                    '<i class="fas fa-arrow-down text-red-600"></i>';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-900">${formatDate(movement.date)}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-2">
                                ${typeIcon}
                                <span class="text-sm text-gray-900">${movement.note || (movement.type === 'in' ? 'Stok Masuk' : 'Stok Keluar')}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-green-600 font-medium">
                            ${movement.type === 'in' ? movement.quantity : '-'}
                        </td>
                        <td class="px-6 py-4 text-sm text-red-600 font-medium">
                            ${movement.type === 'out' ? movement.quantity : '-'}
                        </td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${runningBalance}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${formatCurrency(stockValue)}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = tableRows.join('');
        }

        function showStockInModal() {
            const selectedProductId = document.getElementById('stock-card-product').value;
            if (!selectedProductId) {
                alert('Silakan pilih produk terlebih dahulu!');
                return;
            }
            
            const product = products.find(p => p.id === selectedProductId);
            const quantity = prompt(`Masukkan jumlah stok masuk untuk ${product.name}:`);
            
            if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
                alert('Jumlah tidak valid!');
                return;
            }
            
            const note = prompt('Keterangan (opsional):') || 'Stok masuk manual';
            
            // Add stock
            product.currentStock += parseInt(quantity);
            
            // Add movement record
            stockMovements.push({
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                productId: selectedProductId,
                type: 'in',
                quantity: parseInt(quantity),
                date: new Date().toISOString(),
                note: note
            });
            
            saveData();
            loadStockCard();
            renderProducts();
            updateDashboard();
            alert(`Stok berhasil ditambahkan!\n\nProduk: ${product.name}\nJumlah: ${quantity} ${product.unit}\nStok sekarang: ${product.currentStock} ${product.unit}`);
        }

        function showStockOutModal() {
            const selectedProductId = document.getElementById('stock-card-product').value;
            if (!selectedProductId) {
                alert('Silakan pilih produk terlebih dahulu!');
                return;
            }
            
            const product = products.find(p => p.id === selectedProductId);
            const quantity = prompt(`Masukkan jumlah stok keluar untuk ${product.name}:\n\nStok tersedia: ${product.currentStock} ${product.unit}`);
            
            if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
                alert('Jumlah tidak valid!');
                return;
            }
            
            if (parseInt(quantity) > product.currentStock) {
                alert(`Stok tidak mencukupi!\n\nStok tersedia: ${product.currentStock} ${product.unit}\nJumlah diminta: ${quantity} ${product.unit}`);
                return;
            }
            
            const note = prompt('Keterangan (opsional):') || 'Stok keluar manual';
            
            // Reduce stock
            product.currentStock -= parseInt(quantity);
            
            // Add movement record
            stockMovements.push({
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                productId: selectedProductId,
                type: 'out',
                quantity: parseInt(quantity),
                date: new Date().toISOString(),
                note: note
            });
            
            saveData();
            loadStockCard();
            renderProducts();
            updateDashboard();
            alert(`Stok berhasil dikurangi!\n\nProduk: ${product.name}\nJumlah: ${quantity} ${product.unit}\nStok sekarang: ${product.currentStock} ${product.unit}`);
        }

        // Print Receipt Functions
        function printReceipt(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) {
                alert('❌ Transaksi tidak ditemukan!');
                return;
            }
            
            generateReceiptHTML(sale);
        }

        function saveAndPrint() {
            window.shouldPrintAfterSave = true;
            document.getElementById('sale-form').dispatchEvent(new Event('submit'));
        }

        function generateReceiptHTML(sale) {
            const storeName = settings.storeName || 'StokPro Store';
            const storeAddress = settings.storeAddress || 'Jl. Contoh No. 123, Kota';
            const storePhone = settings.storePhone || '021-12345678';
            
            let receiptItems = '';
            let totalAmount = 0;
            let totalQuantity = 0;
            let totalProfit = 0;
            
            if (sale.items && sale.items.length > 0) {
                sale.items.forEach((item, index) => {
                    const product = products.find(p => p.id === item.productId);
                    const productName = product ? product.name : (item.productName || 'Produk tidak ditemukan');
                    const productCode = product ? product.code : (item.productCode || 'N/A');
                    const unit = product ? product.unit : (item.unit || 'pcs');
                    const category = item.category || (product ? product.category : 'N/A');
                    const subtotal = item.price * item.quantity;
                    const itemProfit = product ? (item.price - product.hpp) * item.quantity : 0;
                    
                    totalAmount += subtotal;
                    totalQuantity += item.quantity;
                    totalProfit += itemProfit;
                    
                    receiptItems += `
                        <tr>
                            <td style="padding: 3px 0; border-bottom: 1px dotted #ccc;">
                                <div style="font-weight: bold; font-size: 11px; margin-bottom: 1px;">${productName}</div>
                                <div style="font-size: 8px; color: #666; margin-bottom: 2px;">
                                    <span style="background: #f0f0f0; padding: 1px 3px; border-radius: 2px;">${productCode}</span> • 
                                    <span>${category}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 10px; align-items: center;">
                                    <span style="color: #666;">
                                        ${item.quantity} ${unit} × ${formatCurrency(item.price)}
                                    </span>
                                    <span style="font-weight: bold; font-size: 11px;">
                                        ${formatCurrency(subtotal)}
                                    </span>
                                </div>
                                ${itemProfit > 0 ? `
                                <div style="font-size: 7px; color: #28a745; text-align: right; margin-top: 1px;">
                                    Profit: ${formatCurrency(itemProfit)}
                                </div>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
            }
            
            const finalTotal = sale.total || totalAmount;
            
            const receiptWindow = window.open('', '_blank', 'width=300,height=600,scrollbars=yes,resizable=yes');
            receiptWindow.document.write(`<!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Struk Penjualan - ${sale.transactionNumber}</title>
                    <style>
                        @media print {
                            @page { size: 58mm auto; margin: 0; }
                            body { margin: 0; padding: 0; }
                        }
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 10px;
                            line-height: 1.2;
                            margin: 0;
                            padding: 5px;
                            width: 58mm;
                            background: white;
                        }
                        .receipt-container { width: 100%; max-width: 58mm; }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #000;
                            padding-bottom: 5px;
                            margin-bottom: 8px;
                        }
                        .store-name {
                            font-size: 14px;
                            font-weight: bold;
                            margin-bottom: 2px;
                        }
                        .store-info {
                            font-size: 8px;
                            line-height: 1.1;
                            margin-bottom: 1px;
                        }
                        .transaction-info {
                            font-size: 9px;
                            margin-bottom: 8px;
                            border-bottom: 1px dashed #000;
                            padding-bottom: 5px;
                        }
                        .items-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 8px;
                        }
                        .total-section {
                            border-top: 2px solid #000;
                            padding-top: 5px;
                            font-size: 11px;
                        }
                        .total-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 2px;
                        }
                        .grand-total {
                            font-weight: bold;
                            font-size: 12px;
                            border-top: 1px solid #000;
                            padding-top: 3px;
                            margin-top: 3px;
                        }
                        .footer {
                            text-align: center;
                            font-size: 8px;
                            margin-top: 10px;
                            border-top: 1px dashed #000;
                            padding-top: 5px;
                        }
                        .no-print {
                            display: block;
                            text-align: center;
                            margin: 10px 0;
                        }
                        @media print {
                            .no-print { display: none !important; }
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt-container">
                        <div class="header">
                            <div class="store-name">${storeName}</div>
                            <div class="store-info">${storeAddress}</div>
                            <div class="store-info">Telp: ${storePhone}</div>
                        </div>
                        
                        <div class="transaction-info">
                            <div style="display: flex; justify-content: space-between;">
                                <span>No. Transaksi:</span>
                                <span style="font-weight: bold;">${sale.transactionNumber}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Tanggal:</span>
                                <span>${formatDateForReceipt(sale.date)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Waktu:</span>
                                <span>${formatTimeForReceipt(sale.date)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Kasir:</span>
                                <span>StokPro System</span>
                            </div>
                            ${sale.customerName ? `
                            <div style="display: flex; justify-content: space-between;">
                                <span>Customer:</span>
                                <span>${sale.customerName}</span>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between;">
                                <span>Total Item:</span>
                                <span>${sale.items ? sale.items.length : 1} jenis</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Total Qty:</span>
                                <span>${totalQuantity} unit</span>
                            </div>
                        </div>
                        
                        <table class="items-table">
                            ${receiptItems}
                        </table>
                        
                        <div class="total-section">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span>${formatCurrency(sale.subtotal || finalTotal)}</span>
                            </div>
                            ${sale.taxAmount && sale.taxAmount > 0 ? `
                            <div class="total-row">
                                <span>Pajak (${sale.taxPercentage || 0}%):</span>
                                <span>${formatCurrency(sale.taxAmount)}</span>
                            </div>
                            ` : `
                            <div class="total-row">
                                <span>Pajak:</span>
                                <span>Rp 0</span>
                            </div>
                            `}
                            <div class="total-row">
                                <span>Diskon:</span>
                                <span>Rp 0</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>TOTAL:</span>
                                <span>${formatCurrency(finalTotal)}</span>
                            </div>
                            <div class="total-row" style="margin-top: 5px;">
                                <span>Pembayaran:</span>
                                <span>${sale.paymentMethod || 'Tunai'}</span>
                            </div>
                            ${sale.paymentAmount && sale.paymentAmount > 0 ? `
                            <div class="total-row">
                                <span>Dibayar:</span>
                                <span>${formatCurrency(sale.paymentAmount)}</span>
                            </div>
                            <div class="total-row">
                                <span>Kembalian:</span>
                                <span>${formatCurrency(sale.changeAmount || 0)}</span>
                            </div>
                            ` : ''}
                            <div class="total-row">
                                <span>Status:</span>
                                <span>${sale.status === 'Completed' ? 'LUNAS' : sale.status}</span>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <div style="font-weight: bold; margin-bottom: 3px;">*** TERIMA KASIH ***</div>
                            <div style="margin-bottom: 2px;">Barang yang sudah dibeli</div>
                            <div style="margin-bottom: 5px;">tidak dapat dikembalikan</div>
                            
                            ${totalProfit > 0 ? `
                            <div style="margin: 5px 0; padding: 3px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 3px;">
                                <div style="font-size: 8px; text-align: center;">
                                    <div>Total Profit: ${formatCurrency(totalProfit)}</div>
                                    <div>Margin: ${totalAmount > 0 ? ((totalProfit / totalAmount) * 100).toFixed(1) : 0}%</div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="margin-top: 5px; font-size: 8px;">
                                <div>Powered by StokPro v25</div>
                                <div>Multi-Item Shopping Cart System</div>
                            </div>
                            
                            ${sale.notes ? `
                            <div style="margin-top: 5px; padding: 3px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 3px;">
                                <div style="font-size: 8px; font-weight: bold; margin-bottom: 1px;">Catatan:</div>
                                <div style="font-size: 8px; font-style: italic;">${sale.notes}</div>
                            </div>
                            ` : ''}
                            
                            <div style="margin-top: 8px; font-size: 7px; text-align: center; color: #666;">
                                <div>Struk ini adalah bukti pembayaran yang sah</div>
                                <div>Simpan struk untuk keperluan garansi</div>
                            </div>
                        </div>
                        
                        <div class="no-print">
                            <button onclick="window.print()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                                🖨️ Print Struk
                            </button>
                            <button onclick="window.close()" style="background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                                ❌ Tutup
                            </button>
                        </div>
                    </div>
                </body>
                </html>`);
            receiptWindow.document.close();
            receiptWindow.focus();
        }

        function formatDateForReceipt(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
        }

        function formatTimeForReceipt(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Keyboard Shortcuts Help
        function showKeyboardShortcuts() {
            let shortcutsMsg = `⌨️ KEYBOARD SHORTCUTS\n\n`;
            shortcutsMsg += `🔢 NAVIGASI MENU:\n`;
            shortcutsMsg += `• Ctrl+1 = Dashboard\n`;
            shortcutsMsg += `• Ctrl+2 = Produk\n`;
            shortcutsMsg += `• Ctrl+3 = Order\n`;
            shortcutsMsg += `• Ctrl+4 = Penjualan\n`;
            shortcutsMsg += `• Ctrl+5 = Kartu Stok\n`;
            shortcutsMsg += `• Ctrl+6 = Pengaturan\n\n`;
            shortcutsMsg += `⚡ QUICK ACTIONS:\n`;
            shortcutsMsg += `• Ctrl+N = Tambah Produk (di menu Produk)\n`;
            shortcutsMsg += `• Ctrl+S = Simpan Form (jika modal terbuka)\n`;
            shortcutsMsg += `• ESC = Tutup Modal\n\n`;
            shortcutsMsg += `💡 Tips: Shortcut hanya bekerja saat tidak mengetik di input field.`;
            
            alert(shortcutsMsg);
        }

        // Close modals and search results when clicking outside
        window.onclick = function(event) {
            const modals = ['product-modal', 'import-guide-modal', 'order-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
            
            // Special handling for sale modal - prevent closing by clicking outside
            const saleModal = document.getElementById('sale-modal');
            if (event.target === saleModal) {
                // Don't close automatically - user must use buttons
                return;
            }
            
            // Close sale product search results when clicking outside
            const saleSearchResults = document.getElementById('sale-product-search-results');
            const saleSearchInput = document.getElementById('sale-product-search');
            if (saleSearchResults && !saleSearchResults.contains(event.target) && event.target !== saleSearchInput) {
                saleSearchResults.classList.add('hidden');
            }
            
            // Close stock card search results when clicking outside
            const stockCardSearchResults = document.getElementById('stock-card-search-results');
            const stockCardSearchInput = document.getElementById('stock-card-search');
            if (stockCardSearchResults && !stockCardSearchResults.contains(event.target) && event.target !== stockCardSearchInput) {
                stockCardSearchResults.classList.add('hidden');
            }
            
            // Close order product search results when clicking outside
            const orderSearchResults = document.getElementById('order-product-search-results');
            const orderSearchInput = document.getElementById('order-product-search');
            if (orderSearchResults && !orderSearchResults.contains(event.target) && event.target !== orderSearchInput) {
                orderSearchResults.classList.add('hidden');
            }
        };
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e63d74b24181d1',t:'MTc1NTA2NzQyNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
