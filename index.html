<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Koperasi Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .login-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .receipt-print { font-family: 'Courier New', monospace; }
        
        /* Mobile Navigation */
        .mobile-nav { display: none; }
        @media (max-width: 768px) {
            .mobile-nav { display: block; }
            .desktop-nav { display: none; }
            .nav-btn { 
                display: block; 
                width: 100%; 
                text-align: left; 
                padding: 12px 16px; 
                border-left: 4px solid transparent;
                border-bottom: none !important;
                transition: all 0.2s ease;
            }
            .nav-btn.active {
                border-left-color: #3b82f6 !important;
                background-color: #eff6ff;
                color: #3b82f6 !important;
            }
            .nav-btn:hover {
                background-color: #f3f4f6;
            }
        }
        
        /* Responsive Tables */
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        
        .table-responsive table {
            min-width: 1200px;
        }
        
        @media (min-width: 1024px) {
            .table-responsive {
                overflow-x: visible;
                white-space: normal;
            }
            .table-responsive table {
                min-width: 100%;
                width: 100%;
            }
            .table-responsive th,
            .table-responsive td {
                white-space: normal;
                word-wrap: break-word;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Desktop column widths */
            .table-responsive th:nth-child(1), .table-responsive td:nth-child(1) { width: 8%; }  /* Kode */
            .table-responsive th:nth-child(2), .table-responsive td:nth-child(2) { width: 15%; } /* Nama Produk */
            .table-responsive th:nth-child(3), .table-responsive td:nth-child(3) { width: 10%; } /* Kategori */
            .table-responsive th:nth-child(4), .table-responsive td:nth-child(4) { width: 10%; } /* Tanggal Beli */
            .table-responsive th:nth-child(5), .table-responsive td:nth-child(5) { width: 10%; } /* Harga Beli */
            .table-responsive th:nth-child(6), .table-responsive td:nth-child(6) { width: 10%; } /* Harga Jual */
            .table-responsive th:nth-child(7), .table-responsive td:nth-child(7) { width: 8%; }  /* Margin */
            .table-responsive th:nth-child(8), .table-responsive td:nth-child(8) { width: 6%; }  /* Stok */
            .table-responsive th:nth-child(9), .table-responsive td:nth-child(9) { width: 10%; } /* Nilai Stok */
            .table-responsive th:nth-child(9), .table-responsive td:nth-child(9) { width: 10%; } /* Nilai Pembelian */
            .table-responsive th:nth-child(10), .table-responsive td:nth-child(10) { width: 10%; } /* Total Jual */
            .table-responsive th:nth-child(11), .table-responsive td:nth-child(11) { width: 8%; } /* Status */
            .table-responsive th:nth-child(12), .table-responsive td:nth-child(12) { width: 8%; } /* Aksi */
        }
        
        @media (max-width: 768px) {
            .table-responsive table {
                min-width: 900px;
                font-size: 0.875rem;
            }
            .table-responsive th,
            .table-responsive td {
                padding: 8px 6px;
            }
        }
        
        @media (max-width: 480px) {
            .table-responsive table {
                min-width: 800px;
                font-size: 0.75rem;
            }
            .table-responsive th,
            .table-responsive td {
                padding: 6px 4px;
            }
        }
        
        /* Mobile Modal */
        @media (max-width: 640px) {
            .modal-content {
                margin: 0.5rem;
                max-height: calc(100vh - 1rem);
                overflow-y: auto;
                border-radius: 0.75rem;
            }
            .modal-content h3 {
                font-size: 1.125rem;
            }
            .modal-content input,
            .modal-content select,
            .modal-content button {
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                margin: 0.25rem;
                max-height: calc(100vh - 0.5rem);
            }
        }
        
        /* Mobile Cards */
        @media (max-width: 640px) {
            .mobile-card {
                display: block !important;
            }
            .mobile-card .desktop-table {
                display: none;
            }
        }
        
        /* Mobile POS Grid */
        @media (max-width: 640px) {
            #productGrid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem;
            }
            #productGrid > div {
                padding: 0.75rem;
            }
            #productGrid h3 {
                font-size: 0.875rem;
                margin-bottom: 0.25rem;
            }
            #productGrid p {
                font-size: 0.75rem;
            }
            #productGrid .text-lg {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            #productGrid {
                grid-template-columns: repeat(1, 1fr) !important;
            }
        }
        
        /* Sticky Mobile Header */
        @media (max-width: 768px) {
            .mobile-header {
                position: sticky;
                top: 0;
                z-index: 40;
            }
        }
        
        /* Mobile Button Improvements */
        @media (max-width: 640px) {
            button {
                min-height: 44px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            .btn-sm {
                min-height: 36px;
                font-size: 0.875rem;
            }
            .btn-xs {
                min-height: 32px;
                font-size: 0.75rem;
            }
        }
        
        /* Improve touch targets */
        @media (max-width: 640px) {
            .table-responsive button {
                padding: 0.5rem;
                margin: 0.125rem;
                min-width: 44px;
                min-height: 36px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                border: none;
                border-radius: 0.5rem;
                font-weight: 500;
                cursor: pointer;
                user-select: none;
                -webkit-user-select: none;
                transition: all 0.2s ease;
            }
            
            /* Mobile action buttons container */
            .mobile-actions {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
                width: 100%;
                min-width: 80px;
            }
            
            .mobile-actions button {
                width: 100%;
                text-align: center;
                font-size: 0.75rem;
                padding: 0.5rem 0.25rem;
                min-height: 36px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                cursor: pointer;
                user-select: none;
                -webkit-user-select: none;
                border: none;
                border-radius: 0.5rem;
                font-weight: 500;
                transition: all 0.2s ease;
                position: relative;
                overflow: hidden;
            }
            
            .mobile-actions button:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
            
            .mobile-actions button:focus {
                outline: 2px solid #3b82f6;
                outline-offset: 2px;
            }
            
            /* Ensure delete buttons are properly styled */
            .mobile-actions button.bg-red-500 {
                background-color: #ef4444 !important;
                color: white !important;
            }
            
            .mobile-actions button.bg-red-500:hover {
                background-color: #dc2626 !important;
            }
            
            .mobile-actions button.bg-red-500:active {
                background-color: #b91c1c !important;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="login-bg min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="bg-blue-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Sistem Inventory & POS</h1>
                <p class="text-gray-600">Silakan login untuk melanjutkan</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan password">
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                    Login
                </button>
            </form>
            

        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b-4 border-blue-500 mobile-header">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-3 md:py-4">
                    <div class="flex items-center space-x-2 md:space-x-3">
                        <div class="bg-blue-500 p-1.5 md:p-2 rounded-lg">
                            <svg class="w-6 h-6 md:w-8 md:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-lg md:text-xl font-bold text-gray-900">Sistem Inventory & POS</h1>
                            <p class="text-xs md:text-sm text-gray-600" id="userRole">Admin Dashboard</p>
                        </div>
                        <button onclick="toggleMobileNav()" class="md:hidden ml-4 p-2 rounded-lg bg-gray-100">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <span class="text-xs md:text-sm text-gray-600 hidden sm:block" id="currentUser">Selamat datang, Admin</span>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 md:px-4 md:py-2 rounded-lg transition duration-200 text-sm">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b">
            <!-- Desktop Navigation -->
            <div class="desktop-nav max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showSection('dashboard')" class="nav-btn py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium">
                        Dashboard
                    </button>
                    <button onclick="showSection('inventory')" class="nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" id="inventoryNav">
                        Inventory
                    </button>
                    <button onclick="showSection('pos')" class="nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                        Point of Sale
                    </button>
                    <button onclick="showSection('reports')" class="nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" id="reportsNav">
                        Laporan
                    </button>
                    <button onclick="showSection('settings')" class="nav-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" id="settingsNav">
                        Pengaturan
                    </button>
                </div>
            </div>
            
            <!-- Mobile Navigation -->
            <div class="mobile-nav hidden" id="mobileNav">
                <div class="px-4 py-2 space-y-1">
                    <button onclick="showSection('dashboard')" class="nav-btn active">
                        <svg class="w-5 h-5 inline-block mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                        </svg>
                        Dashboard
                    </button>
                    <button onclick="showSection('inventory')" class="nav-btn" id="inventoryNavMobile">
                        <svg class="w-5 h-5 inline-block mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        Inventory
                    </button>
                    <button onclick="showSection('pos')" class="nav-btn">
                        <svg class="w-5 h-5 inline-block mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                        Point of Sale
                    </button>
                    <button onclick="showSection('reports')" class="nav-btn" id="reportsNavMobile">
                        <svg class="w-5 h-5 inline-block mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Laporan
                    </button>
                    <button onclick="showSection('settings')" class="nav-btn" id="settingsNavMobile">
                        <svg class="w-5 h-5 inline-block mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Pengaturan
                    </button>
                </div>
            </div>
        </nav>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="section-content max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">
            <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8">
                <div class="bg-white rounded-xl shadow-lg p-3 md:p-6 border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <div class="bg-blue-100 p-1.5 md:p-3 rounded-full flex-shrink-0">
                            <svg class="w-4 h-4 md:w-6 md:h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                        </div>
                        <div class="ml-2 md:ml-4 min-w-0 flex-1">
                            <p class="text-xs md:text-sm font-medium text-gray-600 truncate">Total Produk</p>
                            <p class="text-lg md:text-2xl font-bold text-gray-900" id="totalProducts">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-3 md:p-6 border-l-4 border-green-500">
                    <div class="flex items-center">
                        <div class="bg-green-100 p-1.5 md:p-3 rounded-full flex-shrink-0">
                            <svg class="w-4 h-4 md:w-6 md:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <div class="ml-2 md:ml-4 min-w-0 flex-1">
                            <p class="text-xs md:text-sm font-medium text-gray-600 truncate">Penjualan Hari Ini</p>
                            <p class="text-lg md:text-2xl font-bold text-gray-900" id="todaySales">Rp 0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-3 md:p-6 border-l-4 border-yellow-500">
                    <div class="flex items-center">
                        <div class="bg-yellow-100 p-1.5 md:p-3 rounded-full flex-shrink-0">
                            <svg class="w-4 h-4 md:w-6 md:h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div class="ml-2 md:ml-4 min-w-0 flex-1">
                            <p class="text-xs md:text-sm font-medium text-gray-600 truncate">Stok Menipis</p>
                            <p class="text-lg md:text-2xl font-bold text-gray-900" id="lowStock">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-3 md:p-6 border-l-4 border-purple-500">
                    <div class="flex items-center">
                        <div class="bg-purple-100 p-1.5 md:p-3 rounded-full flex-shrink-0">
                            <svg class="w-4 h-4 md:w-6 md:h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div class="ml-2 md:ml-4 min-w-0 flex-1">
                            <p class="text-xs md:text-sm font-medium text-gray-600 truncate">Total Transaksi</p>
                            <p class="text-lg md:text-2xl font-bold text-gray-900" id="totalTransactions">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Produk Terlaris</h3>
                    <div id="topProducts" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Belum ada data penjualan</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Aktivitas Terbaru</h3>
                    <div id="recentActivity" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Belum ada aktivitas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Section -->
        <div id="inventorySection" class="section-content hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 md:mb-6 gap-4">
                <h2 class="text-xl md:text-2xl font-bold text-gray-900">Manajemen Inventory</h2>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
                    <button onclick="exportInventory()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg transition duration-200 text-sm">
                        Export Excel
                    </button>
                    <button onclick="showAddProductModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg transition duration-200 text-sm" id="addProductBtn">
                        Tambah Produk
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-4 md:p-6 border-b">
                    <div class="flex flex-col md:flex-row gap-3 md:gap-4">
                        <div class="flex-1">
                            <input type="text" id="searchProduct" placeholder="Cari produk berdasarkan nama atau kode..." class="w-full px-3 py-2 md:px-4 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        </div>
                        <div class="md:w-48">
                            <select id="categoryFilter" class="w-full px-3 py-2 md:px-4 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                <option value="">Semua Kategori</option>
                                <option value="Makanan">Makanan</option>
                                <option value="Minuman">Minuman</option>
                                <option value="Elektronik">Elektronik</option>
                                <option value="Pakaian">Pakaian</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Produk</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Beli</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Beli</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Jual</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Margin</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai Stock</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai Pembelian</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Jual</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable" class="bg-white divide-y divide-gray-200">
                            <!-- Products will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- POS Section -->
        <div id="posSection" class="section-content hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-8">
                <!-- Product Selection -->
                <div class="lg:col-span-2 order-2 lg:order-1">
                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 md:mb-6 gap-3">
                            <h2 class="text-lg md:text-xl font-bold text-gray-900">Pilih Produk</h2>
                            <input type="text" id="posSearch" placeholder="Cari produk..." class="w-full sm:w-auto px-3 py-2 md:px-4 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        </div>
                        
                        <div id="productGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-2 xl:grid-cols-3 gap-3 md:gap-4">
                            <!-- Products will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Cart -->
                <div class="lg:col-span-1 order-1 lg:order-2">
                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 lg:sticky lg:top-8">
                        <div class="flex justify-between items-center mb-4 md:mb-6">
                            <h2 class="text-lg md:text-xl font-bold text-gray-900">Keranjang</h2>
                            <div class="text-xs text-gray-500" id="transactionDate"></div>
                        </div>
                        
                        <div id="cartItems" class="space-y-2 md:space-y-3 mb-4 md:mb-6 max-h-48 md:max-h-64 overflow-y-auto">
                            <p class="text-gray-500 text-center py-6 md:py-8 text-sm">Keranjang kosong</p>
                        </div>
                        
                        <div class="border-t pt-3 md:pt-4">
                            <div class="flex justify-between items-center mb-2 text-sm md:text-base">
                                <span class="text-gray-600">Subtotal:</span>
                                <span class="font-semibold" id="subtotal">Rp 0</span>
                            </div>
                            <div class="flex justify-between items-center mb-2 text-sm md:text-base">
                                <span class="text-gray-600">Pajak:</span>
                                <span class="font-semibold" id="tax">Rp 0</span>
                            </div>
                            <div class="flex justify-between items-center mb-3 md:mb-4 text-base md:text-lg font-bold">
                                <span>Total:</span>
                                <span id="total">Rp 0</span>
                            </div>
                            
                            <div class="space-y-2 md:space-y-3">
                                <div class="flex items-center space-x-2 mb-2">
                                    <input type="checkbox" id="taxCheckbox" checked onchange="updateCartTotals()" class="rounded">
                                    <label for="taxCheckbox" class="text-sm text-gray-600">Kenakan Pajak</label>
                                </div>
                                <select id="paymentMethod" class="w-full px-3 py-2 md:px-4 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                    <option value="cash">Cash</option>
                                    <option value="transfer">Transfer</option>
                                </select>
                                <input type="number" id="paymentAmount" placeholder="Jumlah bayar" class="w-full px-3 py-2 md:px-4 md:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                <div class="flex justify-between items-center text-sm md:text-base">
                                    <span class="text-gray-600">Kembalian:</span>
                                    <span class="font-semibold" id="change">Rp 0</span>
                                </div>
                                <button onclick="processPayment()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 md:py-3 px-4 rounded-lg transition duration-200 text-sm md:text-base" disabled id="payButton">
                                    Proses Pembayaran
                                </button>
                                <button onclick="clearCart()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm md:text-base">
                                    Bersihkan Keranjang
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reportsSection" class="section-content hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 md:mb-6 gap-4">
                <h2 class="text-xl md:text-2xl font-bold text-gray-900">Laporan Sistem</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button onclick="exportSalesReport()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg transition duration-200 text-sm">
                        Export Laporan Penjualan
                    </button>
                    <button onclick="exportStockReport()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg transition duration-200 text-sm">
                        Export Laporan Stok
                    </button>
                </div>
            </div>

            <!-- Report Navigation Tabs -->
            <div class="bg-white rounded-xl shadow-lg mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6">
                        <button onclick="showReportTab('sales')" class="report-tab-btn active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                            Laporan Penjualan
                        </button>
                        <button onclick="showReportTab('stock')" class="report-tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Laporan Stok
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Sales Report Tab -->
            <div id="salesReportTab" class="report-tab-content">
                <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
                        <h3 class="text-xs md:text-sm font-medium text-gray-600 mb-2">Penjualan Hari Ini</h3>
                        <p class="text-xl md:text-2xl font-bold text-blue-600" id="reportTodaySales">Rp 0</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
                        <h3 class="text-xs md:text-sm font-medium text-gray-600 mb-2">Penjualan Minggu Ini</h3>
                        <p class="text-xl md:text-2xl font-bold text-green-600" id="reportWeeklySales">Rp 0</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
                        <h3 class="text-xs md:text-sm font-medium text-gray-600 mb-2">Penjualan Bulan Ini</h3>
                        <p class="text-xl md:text-2xl font-bold text-purple-600" id="reportMonthlySales">Rp 0</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
                        <h3 class="text-xs md:text-sm font-medium text-gray-600 mb-2">Total Transaksi</h3>
                        <p class="text-xl md:text-2xl font-bold text-orange-600" id="reportTotalTransactions">0</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">Riwayat Transaksi</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Transaksi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kasir</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="transactionHistory" class="bg-white divide-y divide-gray-200">
                                <!-- Transactions will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stock Report Tab -->
            <div id="stockReportTab" class="report-tab-content hidden">
                <!-- Stock Report Filters -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Laporan Stok</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                            <input type="date" id="stockReportStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label>
                            <input type="date" id="stockReportEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                            <select id="stockReportCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                <option value="">Semua Kategori</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="generateStockReport()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200 text-sm">
                                Generate Laporan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stock Report Summary -->
                <div id="stockReportSummary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                        <h3 class="text-sm font-medium mb-2 opacity-90">Total Produk Masuk</h3>
                        <p class="text-2xl font-bold" id="totalStockIn">0</p>
                        <p class="text-xs opacity-75" id="totalStockInValue">Rp 0</p>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                        <h3 class="text-sm font-medium mb-2 opacity-90">Total Produk Keluar</h3>
                        <p class="text-2xl font-bold" id="totalStockOut">0</p>
                        <p class="text-xs opacity-75" id="totalStockOutValue">Rp 0</p>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                        <h3 class="text-sm font-medium mb-2 opacity-90">Total Margin</h3>
                        <p class="text-2xl font-bold" id="totalMarginValue">Rp 0</p>
                        <p class="text-xs opacity-75" id="averageMarginPercent">0% rata-rata</p>
                    </div>
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                        <h3 class="text-sm font-medium mb-2 opacity-90">Sisa Stok</h3>
                        <p class="text-2xl font-bold" id="remainingStock">0</p>
                        <p class="text-xs opacity-75" id="remainingStockValue">Rp 0</p>
                    </div>
                </div>

                <!-- Stock Report Table -->
                <div id="stockReportTable" class="bg-white rounded-xl shadow-lg overflow-hidden hidden">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">Detail Laporan Stok</h3>
                            <div class="text-sm text-gray-600" id="stockReportPeriod"></div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Produk</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Produk</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Beli</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Jual</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Margin %</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok Masuk</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok Keluar</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sisa Stok</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai Masuk</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai Keluar</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Margin Rupiah</th>
                                </tr>
                            </thead>
                            <tbody id="stockReportTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Stock report data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- No Data Message -->
                <div id="stockReportNoData" class="bg-white rounded-xl shadow-lg p-12 text-center hidden">
                    <div class="text-gray-400 mb-4">
                        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Tidak Ada Data</h3>
                    <p class="text-gray-600">Silakan pilih periode tanggal dan generate laporan untuk melihat data stok.</p>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="section-content hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">
            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6">Pengaturan Sistem</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- User Management -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Manajemen User</h3>
                        <button onclick="showAddUserModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                            Tambah User
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="userTable" class="divide-y divide-gray-200">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Category Management -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Kategori Produk</h3>
                        <button onclick="showAddCategoryModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                            Tambah Kategori
                        </button>
                    </div>
                    <div id="categoryList" class="space-y-2">
                        <!-- Categories will be populated here -->
                    </div>
                </div>

                <!-- Product Code Settings -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Pengaturan Kode Produk</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prefix Kode Produk</label>
                            <input type="text" id="productCodePrefixInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="P">
                        </div>
                        <button onclick="updateProductCodePrefix()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                            Update Prefix
                        </button>
                        <div class="text-sm text-gray-600">
                            <p>Contoh: Jika prefix "P", maka kode produk akan menjadi P001, P002, dst.</p>
                        </div>
                    </div>
                </div>

                <!-- Store Information Settings -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Informasi Toko</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Toko</label>
                            <input type="text" id="storeName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="TOKO ABC">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Alamat Toko</label>
                            <textarea id="storeAddress" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Jl. Contoh No. 123"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Telepon</label>
                            <input type="text" id="storePhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="021-12345678">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email (Opsional)</label>
                            <input type="email" id="storeEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="info@tokoabc.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pesan Footer Struk</label>
                            <textarea id="receiptFooter" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Terima kasih atas kunjungan Anda!"></textarea>
                        </div>
                        <button onclick="updateStoreInfo()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                            Update Informasi Toko
                        </button>
                    </div>
                </div>

                <!-- System Settings -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Pengaturan Sistem</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Pajak Default</span>
                            <input type="checkbox" id="defaultTaxEnabled" onchange="updateDefaultTax()" class="rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Persentase Pajak (%)</label>
                            <input type="number" id="taxPercentage" value="11" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button onclick="updateTaxSettings()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                            Update Pengaturan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-auto max-h-[90vh] overflow-y-auto modal-content">
            <!-- Fixed Header -->
            <div class="sticky top-0 bg-white rounded-t-xl border-b border-gray-200 px-4 sm:px-6 py-4 z-10">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900">Tambah User Baru</h3>
                    <button onclick="closeAddUserModal()" class="text-gray-400 hover:text-gray-600 p-1">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Scrollable Content -->
            <div class="px-4 sm:px-6 py-4">
                <form id="addUserForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="newUsername" required class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="newPassword" required class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <select id="newUserRole" required class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                            <option value="">Pilih Role</option>
                            <option value="admin">Admin</option>
                            <option value="kasir">Kasir</option>
                        </select>
                    </div>
                </form>
            </div>
            
            <!-- Fixed Footer -->
            <div class="sticky bottom-0 bg-white rounded-b-xl border-t border-gray-200 px-4 sm:px-6 py-4">
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="submit" form="addUserForm" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200 text-sm sm:text-base">
                        Tambah User
                    </button>
                    <button type="button" onclick="closeAddUserModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200 text-sm sm:text-base">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-auto max-h-[90vh] overflow-y-auto modal-content">
            <!-- Fixed Header -->
            <div class="sticky top-0 bg-white rounded-t-xl border-b border-gray-200 px-4 sm:px-6 py-4 z-10">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900">Tambah Kategori Baru</h3>
                    <button onclick="closeAddCategoryModal()" class="text-gray-400 hover:text-gray-600 p-1">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Scrollable Content -->
            <div class="px-4 sm:px-6 py-4">
                <form id="addCategoryForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kategori</label>
                        <input type="text" id="newCategoryName" required class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" placeholder="Masukkan nama kategori">
                    </div>
                </form>
            </div>
            
            <!-- Fixed Footer -->
            <div class="sticky bottom-0 bg-white rounded-b-xl border-t border-gray-200 px-4 sm:px-6 py-4">
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="submit" form="addCategoryForm" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200 text-sm sm:text-base">
                        Tambah Kategori
                    </button>
                    <button type="button" onclick="closeAddCategoryModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200 text-sm sm:text-base">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto max-h-[95vh] overflow-y-auto modal-content">
            <!-- Fixed Header -->
            <div class="sticky top-0 bg-white rounded-t-xl border-b border-gray-200 px-4 sm:px-6 py-4 z-10">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900">Tambah Produk Baru</h3>
                    <button onclick="closeAddProductModal()" class="text-gray-400 hover:text-gray-600 p-1">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Scrollable Content -->
            <div class="px-4 sm:px-6 py-4">
                <form id="addProductForm" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="sm:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kode Produk</label>
                            <input type="text" id="productCode" required class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                        </div>
                        <div class="sm:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                            <select id="productCategory" required class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                                <option value="">Pilih Kategori</option>
                                <option value="Makanan">Makanan</option>
                                <option value="Minuman">Minuman</option>
                                <option value="Elektronik">Elektronik</option>
                                <option value="Pakaian">Pakaian</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Produk</label>
                        <input type="text" id="productName" required class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Stok Masuk</label>
                        <input type="date" id="productPurchaseDate" required class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Harga Beli</label>
                            <input type="number" id="productBuyPrice" required class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Harga Jual</label>
                            <input type="number" id="productSellPrice" required class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" placeholder="0">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stok Saat Ini</label>
                            <input type="number" id="productStock" class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stok Masuk</label>
                            <input type="number" id="productTotalPurchased" class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" placeholder="0">
                        </div>
                    </div>
                    
                    <!-- Info Box -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="text-sm text-blue-700">
                                <p class="font-medium mb-1">Tips Pengisian:</p>
                                <ul class="text-xs space-y-1">
                                    <li>• Pastikan kode produk unik</li>
                                    <li>• Stok Masuk ≥ stok saat ini</li>
                                    <li>• Harga jual > harga beli untuk profit</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Fixed Footer -->
            <div class="sticky bottom-0 bg-white rounded-b-xl border-t border-gray-200 px-4 sm:px-6 py-4">
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="submit" form="addProductForm" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200 text-sm sm:text-base">
                        Tambah Produk
                    </button>
                    <button type="button" onclick="closeAddProductModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200 text-sm sm:text-base">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="productDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-auto max-h-[95vh] overflow-y-auto modal-content">
            <!-- Fixed Header -->
            <div class="sticky top-0 bg-white rounded-t-xl border-b border-gray-200 px-4 sm:px-6 py-4 z-10">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900">Detail Produk</h3>
                    <button onclick="closeProductDetailModal()" class="text-gray-400 hover:text-gray-600 p-1">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Scrollable Content -->
            <div class="px-4 sm:px-6 py-4">
                <div id="productDetailContent">
                    <!-- Product detail content will be populated here -->
                </div>
            </div>
            
            <!-- Fixed Footer -->
            <div class="sticky bottom-0 bg-white rounded-b-xl border-t border-gray-200 px-4 sm:px-6 py-4">
                <div class="flex justify-end">
                    <button onclick="closeProductDetailModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 px-6 rounded-lg transition duration-200 text-sm sm:text-base">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 p-2 sm:p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-auto max-h-[95vh] overflow-y-auto modal-content">
            <!-- Fixed Header -->
            <div class="sticky top-0 bg-white rounded-t-xl border-b border-gray-200 px-4 sm:px-6 py-4 z-10">
                <div class="text-center">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-1">Struk Pembayaran</h3>
                    <p class="text-sm text-gray-600">Transaksi berhasil!</p>
                </div>
            </div>
            
            <!-- Scrollable Content -->
            <div class="px-4 sm:px-6 py-4">
                <div id="receiptContent" class="receipt-print bg-gray-50 p-3 sm:p-4 rounded-lg text-xs sm:text-sm">
                    <!-- Receipt content will be populated here -->
                </div>
            </div>
            
            <!-- Fixed Footer -->
            <div class="sticky bottom-0 bg-white rounded-b-xl border-t border-gray-200 px-4 sm:px-6 py-4">
                <div class="flex flex-col sm:flex-row gap-3">
                    <button onclick="printReceipt()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200 text-sm sm:text-base">
                        Print Struk
                    </button>
                    <button onclick="closeReceiptModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200 text-sm sm:text-base">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let userRole = null;
        let products = [];
        let cart = [];
        let transactions = [];
        let users = [];
        let categories = [];
        let productCodePrefix = 'P';
        let taxEnabled = true;
        let storeInfo = {
            name: 'Koperasi Sekolah',
            address: 'Jl. Contoh No. 123',
            phone: '021-12345678',
            email: '',
            footer: 'Terima kasih atas kunjungan Anda!'
        };

        // Update transaction date display
        function updateTransactionDate() {
            const transactionDateEl = document.getElementById('transactionDate');
            if (transactionDateEl) {
                const now = new Date();
                transactionDateEl.textContent = now.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }

        // Initialize sample data
        function initializeSampleData() {
            const today = new Date().toISOString().split('T')[0];
            
            products = [
                { id: 1, code: 'P001', name: 'Nasi Goreng', category: 'Makanan', sellPrice: 15000, buyPrice: 10000, stock: 50, totalPurchased: 100, totalSold: 50, purchaseDate: today },
                { id: 2, code: 'P002', name: 'Mie Ayam', category: 'Makanan', sellPrice: 12000, buyPrice: 8000, stock: 30, totalPurchased: 80, totalSold: 50, purchaseDate: today },
                { id: 3, code: 'P003', name: 'Es Teh', category: 'Minuman', sellPrice: 5000, buyPrice: 3000, stock: 100, totalPurchased: 200, totalSold: 100, purchaseDate: today },
                { id: 4, code: 'P004', name: 'Kopi', category: 'Minuman', sellPrice: 8000, buyPrice: 5000, stock: 75, totalPurchased: 150, totalSold: 75, purchaseDate: today },
                { id: 5, code: 'P005', name: 'Ayam Bakar', category: 'Makanan', sellPrice: 20000, buyPrice: 15000, stock: 25, totalPurchased: 50, totalSold: 25, purchaseDate: today }
            ];
            
            users = [
                { id: 1, username: 'admin', password: 'admin123', role: 'admin' },
                { id: 2, username: 'kasir', password: 'kasir123', role: 'kasir' }
            ];
            
            categories = ['Makanan', 'Minuman', 'Elektronik', 'Pakaian', 'Lainnya'];
            
            // Load from localStorage if available
            const savedProducts = localStorage.getItem('products');
            const savedTransactions = localStorage.getItem('transactions');
            const savedUsers = localStorage.getItem('users');
            const savedCategories = localStorage.getItem('categories');
            const savedPrefix = localStorage.getItem('productCodePrefix');
            const savedTaxEnabled = localStorage.getItem('taxEnabled');
            const savedStoreInfo = localStorage.getItem('storeInfo');
            
            if (savedProducts) {
                products = JSON.parse(savedProducts);
            }
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            }
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
            if (savedCategories) {
                categories = JSON.parse(savedCategories);
            }
            if (savedPrefix) {
                productCodePrefix = savedPrefix;
            }
            if (savedTaxEnabled !== null) {
                taxEnabled = JSON.parse(savedTaxEnabled);
            }
            if (savedStoreInfo) {
                storeInfo = JSON.parse(savedStoreInfo);
            }
            
            // Update UI elements
            document.getElementById('productCodePrefixInput').value = productCodePrefix;
            document.getElementById('defaultTaxEnabled').checked = taxEnabled;
            document.getElementById('taxCheckbox').checked = taxEnabled;
        }

        // Initialize sample data first
        function initializeSampleData() {
            const today = new Date().toISOString().split('T')[0];
            
            products = [
                { id: 1, code: 'P001', name: 'Nasi Goreng', category: 'Makanan', sellPrice: 15000, buyPrice: 10000, stock: 50, totalPurchased: 100, totalSold: 50, purchaseDate: today },
                { id: 2, code: 'P002', name: 'Mie Ayam', category: 'Makanan', sellPrice: 12000, buyPrice: 8000, stock: 30, totalPurchased: 80, totalSold: 50, purchaseDate: today },
                { id: 3, code: 'P003', name: 'Es Teh', category: 'Minuman', sellPrice: 5000, buyPrice: 3000, stock: 100, totalPurchased: 200, totalSold: 100, purchaseDate: today },
                { id: 4, code: 'P004', name: 'Kopi', category: 'Minuman', sellPrice: 8000, buyPrice: 5000, stock: 75, totalPurchased: 150, totalSold: 75, purchaseDate: today },
                { id: 5, code: 'P005', name: 'Ayam Bakar', category: 'Makanan', sellPrice: 20000, buyPrice: 15000, stock: 25, totalPurchased: 50, totalSold: 25, purchaseDate: today }
            ];
            
            users = [
                { id: 1, username: 'admin', password: 'admin123', role: 'admin' },
                { id: 2, username: 'kasir', password: 'kasir123', role: 'kasir' }
            ];
            
            categories = ['Makanan', 'Minuman', 'Elektronik', 'Pakaian', 'Lainnya'];
            
            // Load from localStorage if available
            const savedProducts = localStorage.getItem('products');
            const savedTransactions = localStorage.getItem('transactions');
            const savedUsers = localStorage.getItem('users');
            const savedCategories = localStorage.getItem('categories');
            const savedPrefix = localStorage.getItem('productCodePrefix');
            const savedTaxEnabled = localStorage.getItem('taxEnabled');
            const savedStoreInfo = localStorage.getItem('storeInfo');
            
            if (savedProducts) {
                products = JSON.parse(savedProducts);
            }
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            }
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
            if (savedCategories) {
                categories = JSON.parse(savedCategories);
            }
            if (savedPrefix) {
                productCodePrefix = savedPrefix;
            }
            if (savedTaxEnabled !== null) {
                taxEnabled = JSON.parse(savedTaxEnabled);
            }
            if (savedStoreInfo) {
                storeInfo = JSON.parse(savedStoreInfo);
            }
            
            // Update UI elements
            if (document.getElementById('productCodePrefixInput')) {
                document.getElementById('productCodePrefixInput').value = productCodePrefix;
            }
            if (document.getElementById('defaultTaxEnabled')) {
                document.getElementById('defaultTaxEnabled').checked = taxEnabled;
            }
            if (document.getElementById('taxCheckbox')) {
                document.getElementById('taxCheckbox').checked = taxEnabled;
            }
            
            // Update store info fields
            if (document.getElementById('storeName')) {
                document.getElementById('storeName').value = storeInfo.name;
            }
            if (document.getElementById('storeAddress')) {
                document.getElementById('storeAddress').value = storeInfo.address;
            }
            if (document.getElementById('storePhone')) {
                document.getElementById('storePhone').value = storeInfo.phone;
            }
            if (document.getElementById('storeEmail')) {
                document.getElementById('storeEmail').value = storeInfo.email;
            }
            if (document.getElementById('receiptFooter')) {
                document.getElementById('receiptFooter').value = storeInfo.footer;
            }
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Initialize data first to ensure users array is populated
            initializeSampleData();
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = username;
                userRole = user.role === 'admin' ? 'Admin' : 'Kasir';
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('currentUser').textContent = `Selamat datang, ${userRole}`;
                document.getElementById('userRole').textContent = `${userRole} Dashboard`;
                
                // Show/hide features based on role
                if (userRole === 'Admin') {
                    // Show all admin features
                    document.getElementById('inventoryNav').style.display = 'block';
                    document.getElementById('reportsNav').style.display = 'block';
                    document.getElementById('settingsNav').style.display = 'block';
                    document.getElementById('inventoryNavMobile').style.display = 'block';
                    document.getElementById('reportsNavMobile').style.display = 'block';
                    document.getElementById('settingsNavMobile').style.display = 'block';
                    
                    // Add admin badge to header
                    const userRoleEl = document.getElementById('userRole');
                    userRoleEl.innerHTML = `${userRole} Dashboard <span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full">FULL ACCESS</span>`;
                } else {
                    // Kasir can access inventory and reports but not settings
                    document.getElementById('inventoryNav').style.display = 'block';
                    document.getElementById('reportsNav').style.display = 'block';
                    document.getElementById('settingsNav').style.display = 'none';
                    document.getElementById('inventoryNavMobile').style.display = 'block';
                    document.getElementById('reportsNavMobile').style.display = 'block';
                    document.getElementById('settingsNavMobile').style.display = 'none';
                    
                    // Show cashier badge
                    const userRoleEl = document.getElementById('userRole');
                    userRoleEl.innerHTML = `${userRole} Dashboard <span class="ml-2 px-2 py-1 bg-blue-500 text-white text-xs rounded-full">LIMITED ACCESS</span>`;
                }
                
                updateDashboard();
                renderInventoryTable();
                renderProductGrid();
                updateTransactionDate();
                updateUIBasedOnRole();
            } else {
                alert('Username atau password salah!');
            }
        });

        // Logout functionality
        function logout() {
            // Clear admin metrics if exists
            const adminMetrics = document.getElementById('adminMetrics');
            if (adminMetrics) {
                adminMetrics.remove();
            }
            
            currentUser = null;
            userRole = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Reset navigation visibility
            document.getElementById('inventoryNav').style.display = 'block';
            document.getElementById('reportsNav').style.display = 'block';
            document.getElementById('settingsNav').style.display = 'block';
            document.getElementById('inventoryNavMobile').style.display = 'block';
            document.getElementById('reportsNavMobile').style.display = 'block';
            document.getElementById('settingsNavMobile').style.display = 'block';
        }

        // Mobile Navigation Toggle
        function toggleMobileNav() {
            const mobileNav = document.getElementById('mobileNav');
            mobileNav.classList.toggle('hidden');
        }

        // Navigation
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
            
            // Remove active state from all nav buttons (desktop)
            document.querySelectorAll('.desktop-nav .nav-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Remove active state from all nav buttons (mobile)
            document.querySelectorAll('.mobile-nav .nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(section + 'Section').classList.remove('hidden');
            
            // Find and activate the correct nav button
            const desktopBtn = document.querySelector(`.desktop-nav button[onclick="showSection('${section}')"]`);
            const mobileBtn = document.querySelector(`.mobile-nav button[onclick="showSection('${section}')"]`);
            
            if (desktopBtn) {
                desktopBtn.classList.remove('border-transparent', 'text-gray-500');
                desktopBtn.classList.add('border-blue-500', 'text-blue-600');
            }
            
            if (mobileBtn) {
                mobileBtn.classList.add('active');
                // Hide mobile nav after selection
                document.getElementById('mobileNav').classList.add('hidden');
            }
            
            // Update content based on section
            if (section === 'dashboard') {
                updateDashboard();
            } else if (section === 'inventory') {
                renderInventoryTable();
                updateUIBasedOnRole();
            } else if (section === 'pos') {
                renderProductGrid();
            } else if (section === 'reports') {
                updateReports();
            } else if (section === 'settings') {
                updateSettings();
            }
        }



        // Dashboard functions
        function updateDashboard() {
            document.getElementById('totalProducts').textContent = products.length;
            
            const today = new Date().toDateString();
            const todayTransactions = transactions.filter(t => new Date(t.date).toDateString() === today);
            const todaySales = todayTransactions.reduce((sum, t) => sum + t.total, 0);
            
            document.getElementById('todaySales').textContent = formatCurrency(todaySales);
            document.getElementById('totalTransactions').textContent = transactions.length;
            
            const lowStockProducts = products.filter(p => p.stock < 10);
            document.getElementById('lowStock').textContent = lowStockProducts.length;
            
            // Show admin-specific dashboard enhancements
            if (userRole === 'Admin') {
                updateAdminDashboard();
            }
            
            updateTopProducts();
            updateRecentActivity();
        }
        
        function updateAdminDashboard() {
            // Add admin-specific dashboard metrics
            const dashboardSection = document.getElementById('dashboardSection');
            
            // Check if admin metrics already exist
            if (!document.getElementById('adminMetrics')) {
                const adminMetricsHTML = `
                    <div id="adminMetrics" class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl shadow-lg p-6 mb-8 text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">Admin Control Panel</h3>
                            <div class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">
                                Akses Penuh
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white bg-opacity-10 rounded-lg p-4">
                                <div class="flex items-center">
                                    <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                    </svg>
                                    <div>
                                        <p class="text-sm opacity-90">Total Users</p>
                                        <p class="text-2xl font-bold">${users.length}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white bg-opacity-10 rounded-lg p-4">
                                <div class="flex items-center">
                                    <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                    <div>
                                        <p class="text-sm opacity-90">Kategori Produk</p>
                                        <p class="text-2xl font-bold">${categories.length}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white bg-opacity-10 rounded-lg p-4">
                                <div class="flex items-center">
                                    <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <div>
                                        <p class="text-sm opacity-90">Total Revenue</p>
                                        <p class="text-2xl font-bold">${formatCurrency(transactions.reduce((sum, t) => sum + t.total, 0))}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex flex-wrap gap-2">
                            <button onclick="showSection('inventory')" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm transition duration-200">
                                Kelola Inventory
                            </button>
                            <button onclick="showSection('reports')" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm transition duration-200">
                                Lihat Laporan
                            </button>
                            <button onclick="showSection('settings')" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm transition duration-200">
                                Pengaturan
                            </button>
                        </div>
                    </div>
                `;
                
                // Insert admin metrics before the existing grid
                const existingGrid = dashboardSection.querySelector('.grid');
                existingGrid.insertAdjacentHTML('beforebegin', adminMetricsHTML);
            }
        }

        function updateTopProducts() {
            const productSales = {};
            transactions.forEach(transaction => {
                transaction.items.forEach(item => {
                    productSales[item.name] = (productSales[item.name] || 0) + item.quantity;
                });
            });
            
            const sortedProducts = Object.entries(productSales)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            const topProductsEl = document.getElementById('topProducts');
            if (sortedProducts.length === 0) {
                topProductsEl.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada data penjualan</p>';
            } else {
                topProductsEl.innerHTML = sortedProducts.map(([name, qty]) => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium">${name}</span>
                        <span class="text-blue-600 font-bold">${qty} terjual</span>
                    </div>
                `).join('');
            }
        }

        function updateRecentActivity() {
            const recentActivityEl = document.getElementById('recentActivity');
            const recentTransactions = transactions.slice(-5).reverse();
            
            if (recentTransactions.length === 0) {
                recentActivityEl.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada aktivitas</p>';
            } else {
                recentActivityEl.innerHTML = recentTransactions.map(transaction => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-medium">Transaksi #${transaction.id}</p>
                            <p class="text-sm text-gray-600">${new Date(transaction.date).toLocaleString('id-ID')}</p>
                        </div>
                        <span class="text-green-600 font-bold">${formatCurrency(transaction.total)}</span>
                    </div>
                `).join('');
            }
        }

        // Inventory functions
        function renderInventoryTable() {
            const tableBody = document.getElementById('inventoryTable');
            const searchTerm = document.getElementById('searchProduct')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';
            
            let filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                    product.code.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });
            
            tableBody.innerHTML = filteredProducts.map(product => {
                const margin = ((product.sellPrice - product.buyPrice) / product.sellPrice * 100).toFixed(1);
                const totalStockValue = product.stock * product.buyPrice;
                const totalBuyValue = product.totalPurchased * product.buyPrice;
                const totalSellValue = product.totalSold * product.sellPrice;
                
                return `
                <tr>
                    <td class="px-3 py-3 text-sm font-medium text-gray-900">${product.code}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">
                        <div class="font-medium">${product.name}</div>
                        <div class="text-xs text-gray-500">Dibeli: ${product.totalPurchased} | Terjual: ${product.totalSold}</div>
                    </td>
                    <td class="px-3 py-3 text-sm text-gray-900">${product.category}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">${new Date(product.purchaseDate).toLocaleDateString('id-ID')}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">${formatCurrency(product.buyPrice)}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">${formatCurrency(product.sellPrice)}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${margin > 30 ? 'bg-green-100 text-green-800' : margin > 15 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                            ${margin}%
                        </span>
                    </td>
                    <td class="px-3 py-3 text-sm text-gray-900 text-center">${product.stock}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">${formatCurrency(totalStockValue)}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">${formatCurrency(totalBuyValue)}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">${formatCurrency(totalSellValue)}</td>
                    <td class="px-3 py-3">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${product.stock < 10 ? 'bg-red-100 text-red-800' : product.stock < 20 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                            ${product.stock < 10 ? 'Habis' : product.stock < 20 ? 'Menipis' : 'Tersedia'}
                        </span>
                    </td>
                    <td class="px-3 py-3 text-sm font-medium">
                        <div class="mobile-actions">
                            <button onclick="viewProductDetail(${product.id})" class="bg-green-500 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition duration-200 min-w-[60px]" type="button">Detail</button>
                            <button onclick="editProduct(${product.id})" class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition duration-200 min-w-[60px]" type="button">Edit</button>
                            ${userRole === 'Admin' ? `
                                <button onclick="deleteProduct(${product.id})" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition duration-200 min-w-[60px]" type="button">Hapus</button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Add event listeners for search and filter
        function initializeEventListeners() {
            const searchInput = document.getElementById('searchProduct');
            const categoryFilter = document.getElementById('categoryFilter');
            const posSearch = document.getElementById('posSearch');
            const paymentAmount = document.getElementById('paymentAmount');
            const taxCheckbox = document.getElementById('taxCheckbox');
            
            if (searchInput) {
                searchInput.addEventListener('input', renderInventoryTable);
            }
            if (categoryFilter) {
                categoryFilter.addEventListener('change', renderInventoryTable);
            }
            if (posSearch) {
                posSearch.addEventListener('input', renderProductGrid);
            }
            if (paymentAmount) {
                paymentAmount.addEventListener('input', updateCartTotals);
            }
            if (taxCheckbox) {
                taxCheckbox.addEventListener('change', updateCartTotals);
            }
        }

        function showAddProductModal() {
            // Reset modal title and edit mode
            document.querySelector('#addProductModal h3').textContent = 'Tambah Produk Baru';
            window.editingProductId = null;
            
            document.getElementById('addProductModal').classList.remove('hidden');
            document.getElementById('addProductModal').classList.add('flex');
        }

        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.add('hidden');
            document.getElementById('addProductModal').classList.remove('flex');
            document.getElementById('addProductForm').reset();
            
            // Reset modal title and edit mode
            document.querySelector('#addProductModal h3').textContent = 'Tambah Produk Baru';
            window.editingProductId = null;
        }

        function addProductFormHandler(e) {
            e.preventDefault();
            
            if (window.editingProductId) {
                // Edit mode
                const product = products.find(p => p.id === window.editingProductId);
                if (product) {
                    product.code = document.getElementById('productCode').value;
                    product.name = document.getElementById('productName').value;
                    product.category = document.getElementById('productCategory').value;
                    product.purchaseDate = document.getElementById('productPurchaseDate').value;
                    product.buyPrice = parseInt(document.getElementById('productBuyPrice').value);
                    product.sellPrice = parseInt(document.getElementById('productSellPrice').value);
                    product.stock = parseInt(document.getElementById('productStock').value);
                    product.totalPurchased = parseInt(document.getElementById('productTotalPurchased').value);
                    
                    localStorage.setItem('products', JSON.stringify(products));
                    
                    renderInventoryTable();
                    renderProductGrid();
                    updateDashboard();
                    closeAddProductModal();
                    
                    alert('Produk berhasil diperbarui!');
                }
            } else {
                // Add mode
                const newProduct = {
                    id: Date.now(),
                    code: document.getElementById('productCode').value,
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    purchaseDate: document.getElementById('productPurchaseDate').value,
                    buyPrice: parseInt(document.getElementById('productBuyPrice').value),
                    sellPrice: parseInt(document.getElementById('productSellPrice').value),
                    stock: parseInt(document.getElementById('productStock').value),
                    totalPurchased: parseInt(document.getElementById('productTotalPurchased').value),
                    totalSold: 0
                };
                
                products.push(newProduct);
                localStorage.setItem('products', JSON.stringify(products));
                
                renderInventoryTable();
                renderProductGrid();
                updateDashboard();
                closeAddProductModal();
                
                alert('Produk berhasil ditambahkan!');
            }
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                // Fill form with product data
                document.getElementById('productCode').value = product.code;
                document.getElementById('productName').value = product.name;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productPurchaseDate').value = product.purchaseDate;
                document.getElementById('productBuyPrice').value = product.buyPrice;
                document.getElementById('productSellPrice').value = product.sellPrice;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productTotalPurchased').value = product.totalPurchased;
                
                // Change modal title
                document.querySelector('#addProductModal h3').textContent = 'Edit Produk';
                
                // Show modal
                showAddProductModal();
                
                // Set edit mode flag
                window.editingProductId = id;
            }
        }

        function viewProductDetail(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                const margin = ((product.sellPrice - product.buyPrice) / product.sellPrice * 100).toFixed(1);
                const totalBuyValue = product.totalPurchased * product.buyPrice;
                const totalStockValue = product.stock * product.buyPrice;
                const totalSellValue = product.totalSold * product.sellPrice;
                const profit = totalSellValue - (product.totalSold * product.buyPrice);
                
                document.getElementById('productDetailContent').innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Informasi Dasar -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Informasi Produk</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Kode Produk:</span>
                                    <span class="font-medium">${product.code}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Nama Produk:</span>
                                    <span class="font-medium">${product.name}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Kategori:</span>
                                    <span class="font-medium">${product.category}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Stok Saat Ini:</span>
                                    <span class="font-medium ${product.stock < 10 ? 'text-red-600' : 'text-green-600'}">${product.stock}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informasi Harga -->
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Informasi Harga</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Harga Beli:</span>
                                    <span class="font-medium">${formatCurrency(product.buyPrice)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Harga Jual:</span>
                                    <span class="font-medium">${formatCurrency(product.sellPrice)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Margin Keuntungan:</span>
                                    <span class="font-medium ${margin > 30 ? 'text-green-600' : margin > 15 ? 'text-yellow-600' : 'text-red-600'}">${margin}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Keuntungan per Unit:</span>
                                    <span class="font-medium text-green-600">${formatCurrency(product.sellPrice - product.buyPrice)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Kartu Stok Pembelian -->
                        <div class="bg-green-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Kartu Stok Pembelian</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Dibeli:</span>
                                    <span class="font-medium">${product.totalPurchased} unit</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Nilai Stock:</span>
                                    <span class="font-medium">${formatCurrency(totalStockValue)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Nilai Pembelian:</span>
                                    <span class="font-medium">${formatCurrency(totalBuyValue)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Rata-rata Harga Beli:</span>
                                    <span class="font-medium">${formatCurrency(product.buyPrice)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Kartu Stok Penjualan -->
                        <div class="bg-purple-50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">Kartu Stok Penjualan</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Terjual:</span>
                                    <span class="font-medium">${product.totalSold} unit</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Nilai Penjualan:</span>
                                    <span class="font-medium">${formatCurrency(totalSellValue)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Keuntungan:</span>
                                    <span class="font-medium text-green-600">${formatCurrency(profit)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ringkasan Performa -->
                    <div class="mt-6 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg p-6 text-white">
                        <h4 class="text-lg font-semibold mb-4">Ringkasan Performa</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold">${((product.totalSold / product.totalPurchased) * 100).toFixed(1)}%</div>
                                <div class="text-sm opacity-90">Tingkat Penjualan</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${formatCurrency(profit)}</div>
                                <div class="text-sm opacity-90">Total Keuntungan</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${product.stock}</div>
                                <div class="text-sm opacity-90">Sisa Stok</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('productDetailModal').classList.remove('hidden');
                document.getElementById('productDetailModal').classList.add('flex');
            }
        }
        
        function closeProductDetailModal() {
            document.getElementById('productDetailModal').classList.add('hidden');
            document.getElementById('productDetailModal').classList.remove('flex');
        }

        function deleteProduct(id) {
            // Check if user is admin
            if (userRole !== 'Admin') {
                alert('Hanya admin yang dapat menghapus produk!');
                return;
            }
            
            // Find product name for confirmation
            const product = products.find(p => p.id === id);
            if (!product) {
                alert('Produk tidak ditemukan!');
                return;
            }
            
            if (confirm(`Apakah Anda yakin ingin menghapus produk "${product.name}"?\n\nTindakan ini tidak dapat dibatalkan.`)) {
                products = products.filter(p => p.id !== id);
                localStorage.setItem('products', JSON.stringify(products));
                
                renderInventoryTable();
                renderProductGrid();
                updateDashboard();
                
                alert('Produk berhasil dihapus!');
            }
        }

        // POS functions
        function renderProductGrid() {
            const productGrid = document.getElementById('productGrid');
            const searchTerm = document.getElementById('posSearch')?.value.toLowerCase() || '';
            
            let filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) && product.stock > 0
            );
            
            productGrid.innerHTML = filteredProducts.map(product => `
                <div class="bg-gray-50 rounded-lg p-4 cursor-pointer hover:bg-gray-100 transition duration-200" onclick="addToCart(${product.id})">
                    <div class="text-center">
                        <div class="bg-blue-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-white font-bold text-xl">${product.name.charAt(0)}</span>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-1">${product.name}</h3>
                        <p class="text-sm text-gray-600 mb-2">${product.category}</p>
                        <p class="text-lg font-bold text-blue-600">${formatCurrency(product.sellPrice)}</p>
                        <p class="text-xs text-gray-500">Stok: ${product.stock}</p>
                    </div>
                </div>
            `).join('');
        }



        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock === 0) return;
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                } else {
                    alert('Stok tidak mencukupi!');
                    return;
                }
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.sellPrice,
                    quantity: 1
                });
            }
            
            renderCart();
            updateCartTotals();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            renderCart();
            updateCartTotals();
        }

        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);
            
            if (item && product) {
                const newQuantity = item.quantity + change;
                
                if (newQuantity <= 0) {
                    removeFromCart(productId);
                } else if (newQuantity <= product.stock) {
                    item.quantity = newQuantity;
                    renderCart();
                    updateCartTotals();
                } else {
                    alert('Stok tidak mencukupi!');
                }
            }
        }

        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="text-gray-500 text-center py-8">Keranjang kosong</p>';
            } else {
                cartItems.innerHTML = cart.map(item => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${item.name}</h4>
                            <p class="text-sm text-gray-600">${formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="updateQuantity(${item.id}, -1)" class="bg-red-500 text-white w-6 h-6 rounded-full text-xs hover:bg-red-600">-</button>
                            <span class="font-medium">${item.quantity}</span>
                            <button onclick="updateQuantity(${item.id}, 1)" class="bg-green-500 text-white w-6 h-6 rounded-full text-xs hover:bg-green-600">+</button>
                            <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700 ml-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateCartTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const taxCheckbox = document.getElementById('taxCheckbox');
            const taxRate = parseFloat(document.getElementById('taxPercentage')?.value || 11) / 100;
            const tax = taxCheckbox && taxCheckbox.checked ? subtotal * taxRate : 0;
            const total = subtotal + tax;
            
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('tax').textContent = formatCurrency(tax);
            document.getElementById('total').textContent = formatCurrency(total);
            
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const change = paymentAmount - total;
            
            document.getElementById('change').textContent = formatCurrency(Math.max(0, change));
            
            const payButton = document.getElementById('payButton');
            payButton.disabled = cart.length === 0 || paymentAmount < total;
        }



        function clearCart() {
            cart = [];
            renderCart();
            updateCartTotals();
            document.getElementById('paymentAmount').value = '';
        }

        function processPayment() {
            if (cart.length === 0) return;
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const taxCheckbox = document.getElementById('taxCheckbox');
            const taxRate = parseFloat(document.getElementById('taxPercentage')?.value || 11) / 100;
            const tax = taxCheckbox && taxCheckbox.checked ? subtotal * taxRate : 0;
            const total = subtotal + tax;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            if (paymentAmount < total) {
                alert('Jumlah pembayaran tidak mencukupi!');
                return;
            }
            
            // Create transaction
            const transaction = {
                id: 'TRX' + Date.now(),
                date: new Date().toISOString(),
                items: [...cart],
                subtotal: subtotal,
                tax: tax,
                total: total,
                payment: paymentAmount,
                change: paymentAmount - total,
                paymentMethod: paymentMethod,
                cashier: currentUser
            };
            
            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            
            // Update product stock and sales tracking
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    product.stock -= item.quantity;
                    product.totalSold += item.quantity;
                }
            });
            localStorage.setItem('products', JSON.stringify(products));
            
            // Show receipt
            showReceipt(transaction);
            
            // Clear cart and update displays
            clearCart();
            renderProductGrid();
            updateDashboard();
            
            alert('Pembayaran berhasil!');
        }

        function showReceipt(transaction) {
            const receiptContent = document.getElementById('receiptContent');
            
            receiptContent.innerHTML = `
                <div class="text-center mb-4">
                    <h3 class="font-bold">${storeInfo.name}</h3>
                    <p class="text-xs">${storeInfo.address}</p>
                    <p class="text-xs">Telp: ${storeInfo.phone}</p>
                    ${storeInfo.email ? `<p class="text-xs">Email: ${storeInfo.email}</p>` : ''}
                </div>
                
                <div class="border-t border-b border-dashed py-2 mb-2">
                    <p class="text-xs">ID: ${transaction.id}</p>
                    <p class="text-xs">Tanggal: ${new Date(transaction.date).toLocaleString('id-ID')}</p>
                    <p class="text-xs">Kasir: ${transaction.cashier}</p>
                </div>
                
                <div class="mb-2">
                    ${transaction.items.map(item => `
                        <div class="flex justify-between text-xs">
                            <span>${item.name}</span>
                            <span>${item.quantity} x ${formatCurrency(item.price)}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="border-t border-dashed pt-2">
                    <div class="flex justify-between text-xs">
                        <span>Subtotal:</span>
                        <span>${formatCurrency(transaction.subtotal)}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span>Pajak (10%):</span>
                        <span>${formatCurrency(transaction.tax)}</span>
                    </div>
                    <div class="flex justify-between font-bold">
                        <span>Total:</span>
                        <span>${formatCurrency(transaction.total)}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span>Bayar:</span>
                        <span>${formatCurrency(transaction.payment)}</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span>Kembalian:</span>
                        <span>${formatCurrency(transaction.change)}</span>
                    </div>
                </div>
                
                <div class="text-center mt-4 text-xs">
                    <p>${storeInfo.footer}</p>
                </div>
            `;
            
            document.getElementById('receiptModal').classList.remove('hidden');
            document.getElementById('receiptModal').classList.add('flex');
        }

        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.add('hidden');
            document.getElementById('receiptModal').classList.remove('flex');
        }

        function printReceipt() {
            const receiptContent = document.getElementById('receiptContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Struk Pembayaran</title>
                        <style>
                            body { font-family: 'Courier New', monospace; font-size: 12px; margin: 20px; }
                            .text-center { text-align: center; }
                            .font-bold { font-weight: bold; }
                            .text-xs { font-size: 10px; }
                            .border-t { border-top: 1px dashed #000; }
                            .border-b { border-bottom: 1px dashed #000; }
                            .border-dashed { border-style: dashed; }
                            .py-2 { padding: 8px 0; }
                            .pt-2 { padding-top: 8px; }
                            .mb-2 { margin-bottom: 8px; }
                            .mb-4 { margin-bottom: 16px; }
                            .mt-4 { margin-top: 16px; }
                            .flex { display: flex; }
                            .justify-between { justify-content: space-between; }
                        </style>
                    </head>
                    <body>
                        ${receiptContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Reports functions
        function updateReports() {
            const today = new Date();
            const todayStr = today.toDateString();
            const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            const todayTransactions = transactions.filter(t => new Date(t.date).toDateString() === todayStr);
            const weekTransactions = transactions.filter(t => new Date(t.date) >= weekStart);
            const monthTransactions = transactions.filter(t => new Date(t.date) >= monthStart);
            
            const todaySales = todayTransactions.reduce((sum, t) => sum + t.total, 0);
            const weeklySales = weekTransactions.reduce((sum, t) => sum + t.total, 0);
            const monthlySales = monthTransactions.reduce((sum, t) => sum + t.total, 0);
            
            document.getElementById('reportTodaySales').textContent = formatCurrency(todaySales);
            document.getElementById('reportWeeklySales').textContent = formatCurrency(weeklySales);
            document.getElementById('reportMonthlySales').textContent = formatCurrency(monthlySales);
            document.getElementById('reportTotalTransactions').textContent = transactions.length;
            
            renderTransactionHistory();
            initializeStockReportFilters();
        }

        function showReportTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.report-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('.report-tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'ReportTab').classList.remove('hidden');
            
            // Activate selected tab button
            const activeBtn = document.querySelector(`button[onclick="showReportTab('${tabName}')"]`);
            if (activeBtn) {
                activeBtn.classList.remove('border-transparent', 'text-gray-500');
                activeBtn.classList.add('active', 'border-blue-500', 'text-blue-600');
            }
            
            // Initialize specific tab content
            if (tabName === 'stock') {
                initializeStockReportFilters();
            }
        }

        function initializeStockReportFilters() {
            // Set default dates (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            const startDateInput = document.getElementById('stockReportStartDate');
            const endDateInput = document.getElementById('stockReportEndDate');
            const categorySelect = document.getElementById('stockReportCategory');
            
            if (startDateInput) startDateInput.value = startDate.toISOString().split('T')[0];
            if (endDateInput) endDateInput.value = endDate.toISOString().split('T')[0];
            
            // Populate category filter
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">Semua Kategori</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }
        }

        function generateStockReport() {
            const startDate = document.getElementById('stockReportStartDate').value;
            const endDate = document.getElementById('stockReportEndDate').value;
            const selectedCategory = document.getElementById('stockReportCategory').value;
            
            if (!startDate || !endDate) {
                alert('Silakan pilih periode tanggal terlebih dahulu!');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Tanggal mulai tidak boleh lebih besar dari tanggal akhir!');
                return;
            }
            
            // Filter products based on category
            let filteredProducts = products;
            if (selectedCategory) {
                filteredProducts = products.filter(p => p.category === selectedCategory);
            }
            
            // Generate integrated stock movement data
            const stockMovements = [];
            const summaryData = {
                totalStockIn: 0,
                totalStockOut: 0,
                totalStockInValue: 0,
                totalStockOutValue: 0,
                totalMarginValue: 0,
                remainingStock: 0,
                remainingStockValue: 0
            };
            
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            // Create a comprehensive movement tracking system
            const movementsByProduct = new Map();
            
            // Track stock IN movements (purchases/additions)
            filteredProducts.forEach(product => {
                const purchaseDate = new Date(product.purchaseDate);
                
                // Initialize product movement tracking
                if (!movementsByProduct.has(product.id)) {
                    movementsByProduct.set(product.id, {
                        product: product,
                        stockInMovements: [],
                        stockOutMovements: [],
                        totalStockIn: 0,
                        totalStockOut: 0,
                        totalStockInValue: 0,
                        totalStockOutValue: 0
                    });
                }
                
                const productMovement = movementsByProduct.get(product.id);
                
                // Add purchase movement if within date range
                if (purchaseDate >= startDateObj && purchaseDate <= endDateObj) {
                    productMovement.stockInMovements.push({
                        date: purchaseDate,
                        type: 'PEMBELIAN',
                        quantity: product.totalPurchased,
                        unitPrice: product.buyPrice,
                        totalValue: product.totalPurchased * product.buyPrice,
                        reference: `Pembelian ${product.code}`,
                        description: `Pembelian awal produk ${product.name}`
                    });
                    
                    productMovement.totalStockIn += product.totalPurchased;
                    productMovement.totalStockInValue += product.totalPurchased * product.buyPrice;
                }
            });
            
            // Track stock OUT movements (sales)
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                
                if (transactionDate >= startDateObj && transactionDate <= endDateObj) {
                    transaction.items.forEach(item => {
                        const product = products.find(p => p.id === item.id);
                        if (product && (!selectedCategory || product.category === selectedCategory)) {
                            
                            if (!movementsByProduct.has(product.id)) {
                                movementsByProduct.set(product.id, {
                                    product: product,
                                    stockInMovements: [],
                                    stockOutMovements: [],
                                    totalStockIn: 0,
                                    totalStockOut: 0,
                                    totalStockInValue: 0,
                                    totalStockOutValue: 0
                                });
                            }
                            
                            const productMovement = movementsByProduct.get(product.id);
                            
                            productMovement.stockOutMovements.push({
                                date: transactionDate,
                                type: 'PENJUALAN',
                                quantity: item.quantity,
                                unitPrice: item.price,
                                totalValue: item.quantity * item.price,
                                reference: transaction.id,
                                description: `Penjualan via ${transaction.paymentMethod}`,
                                cashier: transaction.cashier
                            });
                            
                            productMovement.totalStockOut += item.quantity;
                            productMovement.totalStockOutValue += item.quantity * item.price;
                        }
                    });
                }
            });
            
            // Generate consolidated report data
            movementsByProduct.forEach((movement, productId) => {
                const product = movement.product;
                const margin = ((product.sellPrice - product.buyPrice) / product.sellPrice * 100);
                const marginValue = movement.totalStockOut * (product.sellPrice - product.buyPrice);
                
                // Create detailed movement entries
                const allMovements = [
                    ...movement.stockInMovements.map(m => ({
                        ...m,
                        productCode: product.code,
                        productName: product.name,
                        category: product.category,
                        movementType: 'IN'
                    })),
                    ...movement.stockOutMovements.map(m => ({
                        ...m,
                        productCode: product.code,
                        productName: product.name,
                        category: product.category,
                        movementType: 'OUT'
                    }))
                ];
                
                // Sort movements by date
                allMovements.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Add consolidated summary for this product
                if (movement.totalStockIn > 0 || movement.totalStockOut > 0) {
                    stockMovements.push({
                        date: product.purchaseDate ? new Date(product.purchaseDate).toLocaleDateString('id-ID') : '-',
                        code: product.code,
                        name: product.name,
                        category: product.category,
                        buyPrice: product.buyPrice,
                        sellPrice: product.sellPrice,
                        margin: margin,
                        stockIn: movement.totalStockIn,
                        stockOut: movement.totalStockOut,
                        remainingStock: product.stock,
                        stockInValue: movement.totalStockInValue,
                        stockOutValue: movement.totalStockOutValue,
                        marginValue: marginValue,
                        movements: allMovements // Detailed movements for drill-down
                    });
                }
                
                // Update summary totals
                summaryData.totalStockIn += movement.totalStockIn;
                summaryData.totalStockOut += movement.totalStockOut;
                summaryData.totalStockInValue += movement.totalStockInValue;
                summaryData.totalStockOutValue += movement.totalStockOutValue;
                summaryData.totalMarginValue += marginValue;
                summaryData.remainingStock += product.stock;
                summaryData.remainingStockValue += product.stock * product.buyPrice;
            });
            
            // Sort by total activity (stock in + stock out)
            stockMovements.sort((a, b) => (b.stockIn + b.stockOut) - (a.stockIn + a.stockOut));
            
            // Update UI
            updateStockReportSummary(summaryData);
            renderStockReportTable(stockMovements, startDate, endDate);
            
            // Show/hide appropriate sections
            if (stockMovements.length > 0) {
                document.getElementById('stockReportSummary').classList.remove('hidden');
                document.getElementById('stockReportTable').classList.remove('hidden');
                document.getElementById('stockReportNoData').classList.add('hidden');
            } else {
                document.getElementById('stockReportSummary').classList.add('hidden');
                document.getElementById('stockReportTable').classList.add('hidden');
                document.getElementById('stockReportNoData').classList.remove('hidden');
            }
        }

        function updateStockReportSummary(data) {
            document.getElementById('totalStockIn').textContent = data.totalStockIn.toLocaleString('id-ID');
            document.getElementById('totalStockInValue').textContent = formatCurrency(data.totalStockInValue);
            
            document.getElementById('totalStockOut').textContent = data.totalStockOut.toLocaleString('id-ID');
            document.getElementById('totalStockOutValue').textContent = formatCurrency(data.totalStockOutValue);
            
            document.getElementById('totalMarginValue').textContent = formatCurrency(data.totalMarginValue);
            const averageMargin = data.totalStockOutValue > 0 ? (data.totalMarginValue / data.totalStockOutValue * 100) : 0;
            document.getElementById('averageMarginPercent').textContent = averageMargin.toFixed(1) + '% rata-rata';
            
            document.getElementById('remainingStock').textContent = data.remainingStock.toLocaleString('id-ID');
            document.getElementById('remainingStockValue').textContent = formatCurrency(data.remainingStockValue);
        }

        function renderStockReportTable(movements, startDate, endDate) {
            const tbody = document.getElementById('stockReportTableBody');
            const periodEl = document.getElementById('stockReportPeriod');
            
            // Update period display
            const startDateFormatted = new Date(startDate).toLocaleDateString('id-ID');
            const endDateFormatted = new Date(endDate).toLocaleDateString('id-ID');
            periodEl.textContent = `Periode: ${startDateFormatted} - ${endDateFormatted}`;
            
            // Render table rows with integrated movement data
            tbody.innerHTML = movements.map((movement, index) => {
                const marginClass = movement.margin > 30 ? 'text-green-600' : movement.margin > 15 ? 'text-yellow-600' : 'text-red-600';
                const hasMovements = movement.movements && movement.movements.length > 0;
                
                return `
                    <tr class="hover:bg-gray-50 ${hasMovements ? 'cursor-pointer' : ''}" ${hasMovements ? `onclick="toggleMovementDetails(${index})"` : ''}>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            <div class="flex items-center">
                                ${hasMovements ? `
                                    <svg class="w-4 h-4 mr-2 transform transition-transform duration-200" id="arrow-${index}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                ` : '<div class="w-6 mr-2"></div>'}
                                ${movement.date}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${movement.code}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            <div class="font-medium">${movement.name}</div>
                            ${hasMovements ? '<div class="text-xs text-blue-600">Klik untuk detail pergerakan</div>' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">${movement.category}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${formatCurrency(movement.buyPrice)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${formatCurrency(movement.sellPrice)}</td>
                        <td class="px-4 py-3 text-sm font-medium ${marginClass}">${movement.margin.toFixed(1)}%</td>
                        <td class="px-4 py-3 text-sm text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${movement.stockIn > 0 ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                ${movement.stockIn}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${movement.stockOut > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${movement.stockOut}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${movement.remainingStock < 10 ? 'bg-red-100 text-red-800' : movement.remainingStock < 20 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                ${movement.remainingStock}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">${formatCurrency(movement.stockInValue)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${formatCurrency(movement.stockOutValue)}</td>
                        <td class="px-4 py-3 text-sm font-medium text-green-600">${formatCurrency(movement.marginValue)}</td>
                    </tr>
                    ${hasMovements ? `
                        <tr id="details-${index}" class="hidden bg-blue-50">
                            <td colspan="13" class="px-4 py-4">
                                <div class="bg-white rounded-lg p-4 shadow-sm">
                                    <h4 class="font-semibold text-gray-900 mb-3">Detail Pergerakan Stok - ${movement.name}</h4>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full text-sm">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jenis</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Referensi</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Deskripsi</th>
                                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Qty</th>
                                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Harga Satuan</th>
                                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total Nilai</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Kasir</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-200">
                                                ${movement.movements.map(m => `
                                                    <tr class="${m.movementType === 'IN' ? 'bg-blue-25' : 'bg-green-25'}">
                                                        <td class="px-3 py-2 text-gray-900">${new Date(m.date).toLocaleDateString('id-ID')}</td>
                                                        <td class="px-3 py-2">
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${m.movementType === 'IN' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                                                                ${m.type}
                                                            </span>
                                                        </td>
                                                        <td class="px-3 py-2 text-gray-900 font-mono text-xs">${m.reference}</td>
                                                        <td class="px-3 py-2 text-gray-600">${m.description}</td>
                                                        <td class="px-3 py-2 text-right font-medium ${m.movementType === 'IN' ? 'text-blue-600' : 'text-green-600'}">
                                                            ${m.movementType === 'IN' ? '+' : '-'}${m.quantity}
                                                        </td>
                                                        <td class="px-3 py-2 text-right text-gray-900">${formatCurrency(m.unitPrice)}</td>
                                                        <td class="px-3 py-2 text-right font-medium text-gray-900">${formatCurrency(m.totalValue)}</td>
                                                        <td class="px-3 py-2 text-gray-600">${m.cashier || '-'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                        <div class="bg-blue-50 p-3 rounded-lg">
                                            <div class="text-blue-600 font-medium">Total Masuk</div>
                                            <div class="text-lg font-bold text-blue-800">${movement.stockIn} unit</div>
                                            <div class="text-blue-600">${formatCurrency(movement.stockInValue)}</div>
                                        </div>
                                        <div class="bg-green-50 p-3 rounded-lg">
                                            <div class="text-green-600 font-medium">Total Keluar</div>
                                            <div class="text-lg font-bold text-green-800">${movement.stockOut} unit</div>
                                            <div class="text-green-600">${formatCurrency(movement.stockOutValue)}</div>
                                        </div>
                                        <div class="bg-purple-50 p-3 rounded-lg">
                                            <div class="text-purple-600 font-medium">Net Movement</div>
                                            <div class="text-lg font-bold text-purple-800">${movement.stockIn - movement.stockOut} unit</div>
                                            <div class="text-purple-600">Sisa: ${movement.remainingStock} unit</div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    ` : ''}
                `;
            }).join('');
        }
        
        function toggleMovementDetails(index) {
            const detailsRow = document.getElementById(`details-${index}`);
            const arrow = document.getElementById(`arrow-${index}`);
            
            if (detailsRow && arrow) {
                if (detailsRow.classList.contains('hidden')) {
                    detailsRow.classList.remove('hidden');
                    arrow.style.transform = 'rotate(90deg)';
                } else {
                    detailsRow.classList.add('hidden');
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        }

        function exportStockReport() {
            try {
                const startDate = document.getElementById('stockReportStartDate').value;
                const endDate = document.getElementById('stockReportEndDate').value;
                const selectedCategory = document.getElementById('stockReportCategory').value;
                
                if (!startDate || !endDate) {
                    alert('Silakan generate laporan stok terlebih dahulu!');
                    return;
                }
            
            // Get integrated stock report data
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            let filteredProducts = products;
            if (selectedCategory) {
                filteredProducts = products.filter(p => p.category === selectedCategory);
            }
            
            // Generate detailed movement data for export
            const detailedMovements = [];
            const summaryMovements = [];
            
            const movementsByProduct = new Map();
            
            // Track all movements
            filteredProducts.forEach(product => {
                const purchaseDate = new Date(product.purchaseDate);
                
                if (!movementsByProduct.has(product.id)) {
                    movementsByProduct.set(product.id, {
                        product: product,
                        stockInMovements: [],
                        stockOutMovements: [],
                        totalStockIn: 0,
                        totalStockOut: 0,
                        totalStockInValue: 0,
                        totalStockOutValue: 0
                    });
                }
                
                const productMovement = movementsByProduct.get(product.id);
                
                // Add purchase movement if within date range
                if (purchaseDate >= startDateObj && purchaseDate <= endDateObj) {
                    const purchaseMovement = {
                        'Tanggal': purchaseDate.toLocaleDateString('id-ID'),
                        'Kode Produk': product.code,
                        'Nama Produk': product.name,
                        'Kategori': product.category,
                        'Jenis Pergerakan': 'PEMBELIAN',
                        'Referensi': `Pembelian ${product.code}`,
                        'Deskripsi': `Pembelian awal produk ${product.name}`,
                        'Quantity': product.totalPurchased,
                        'Harga Satuan': product.buyPrice,
                        'Total Nilai': product.totalPurchased * product.buyPrice,
                        'Kasir/User': currentUser,
                        'Status': 'MASUK'
                    };
                    
                    detailedMovements.push(purchaseMovement);
                    productMovement.totalStockIn += product.totalPurchased;
                    productMovement.totalStockInValue += product.totalPurchased * product.buyPrice;
                }
            });
            
            // Track sales movements
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                
                if (transactionDate >= startDateObj && transactionDate <= endDateObj) {
                    transaction.items.forEach(item => {
                        const product = products.find(p => p.id === item.id);
                        if (product && (!selectedCategory || product.category === selectedCategory)) {
                            
                            const salesMovement = {
                                'Tanggal': transactionDate.toLocaleDateString('id-ID'),
                                'Kode Produk': product.code,
                                'Nama Produk': product.name,
                                'Kategori': product.category,
                                'Jenis Pergerakan': 'PENJUALAN',
                                'Referensi': transaction.id,
                                'Deskripsi': `Penjualan via ${transaction.paymentMethod}`,
                                'Quantity': item.quantity,
                                'Harga Satuan': item.price,
                                'Total Nilai': item.quantity * item.price,
                                'Kasir/User': transaction.cashier,
                                'Status': 'KELUAR'
                            };
                            
                            detailedMovements.push(salesMovement);
                            
                            if (!movementsByProduct.has(product.id)) {
                                movementsByProduct.set(product.id, {
                                    product: product,
                                    stockInMovements: [],
                                    stockOutMovements: [],
                                    totalStockIn: 0,
                                    totalStockOut: 0,
                                    totalStockInValue: 0,
                                    totalStockOutValue: 0
                                });
                            }
                            
                            const productMovement = movementsByProduct.get(product.id);
                            productMovement.totalStockOut += item.quantity;
                            productMovement.totalStockOutValue += item.quantity * item.price;
                        }
                    });
                }
            });
            
            // Generate summary by product
            movementsByProduct.forEach((movement, productId) => {
                const product = movement.product;
                if (movement.totalStockIn > 0 || movement.totalStockOut > 0) {
                    const margin = ((product.sellPrice - product.buyPrice) / product.sellPrice * 100);
                    const marginValue = movement.totalStockOut * (product.sellPrice - product.buyPrice);
                    
                    summaryMovements.push({
                        'Kode Produk': product.code,
                        'Nama Produk': product.name,
                        'Kategori': product.category,
                        'Harga Beli': product.buyPrice,
                        'Harga Jual': product.sellPrice,
                        'Margin (%)': margin.toFixed(1),
                        'Total Stok Masuk': movement.totalStockIn,
                        'Total Stok Keluar': movement.totalStockOut,
                        'Sisa Stok': product.stock,
                        'Nilai Total Masuk': movement.totalStockInValue,
                        'Nilai Total Keluar': movement.totalStockOutValue,
                        'Total Margin Rupiah': marginValue,
                        'Net Movement': movement.totalStockIn - movement.totalStockOut,
                        'Turnover Rate': movement.totalStockIn > 0 ? ((movement.totalStockOut / movement.totalStockIn) * 100).toFixed(1) + '%' : '0%'
                    });
                }
            });
            
            // Sort detailed movements by date
            detailedMovements.sort((a, b) => new Date(a.Tanggal.split('/').reverse().join('-')) - new Date(b.Tanggal.split('/').reverse().join('-')));
            
            // Sort summary by total activity
            summaryMovements.sort((a, b) => (b['Total Stok Masuk'] + b['Total Stok Keluar']) - (a['Total Stok Masuk'] + a['Total Stok Keluar']));
            
            // Create overall summary
            const overallSummary = [{
                'Periode Laporan': `${new Date(startDate).toLocaleDateString('id-ID')} - ${new Date(endDate).toLocaleDateString('id-ID')}`,
                'Kategori Filter': selectedCategory || 'Semua Kategori',
                'Total Produk Terlibat': summaryMovements.length,
                'Total Transaksi Masuk': detailedMovements.filter(m => m.Status === 'MASUK').length,
                'Total Transaksi Keluar': detailedMovements.filter(m => m.Status === 'KELUAR').length,
                'Total Unit Masuk': summaryMovements.reduce((sum, m) => sum + m['Total Stok Masuk'], 0),
                'Total Unit Keluar': summaryMovements.reduce((sum, m) => sum + m['Total Stok Keluar'], 0),
                'Total Nilai Masuk': summaryMovements.reduce((sum, m) => sum + m['Nilai Total Masuk'], 0),
                'Total Nilai Keluar': summaryMovements.reduce((sum, m) => sum + m['Nilai Total Keluar'], 0),
                'Total Margin Keuntungan': summaryMovements.reduce((sum, m) => sum + m['Total Margin Rupiah'], 0),
                'Rata-rata Margin (%)': summaryMovements.length > 0 ? (summaryMovements.reduce((sum, m) => sum + parseFloat(m['Margin (%)']), 0) / summaryMovements.length).toFixed(1) + '%' : '0%',
                'Tanggal Export': new Date().toLocaleString('id-ID'),
                'User Export': currentUser,
                'Sistem': 'Inventory & POS Management System'
            }];
            
            // Create workbook with multiple sheets
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Detailed movements (chronological)
            if (detailedMovements.length > 0) {
                const wsDetailed = XLSX.utils.json_to_sheet(detailedMovements);
                XLSX.utils.book_append_sheet(wb, wsDetailed, "Detail Pergerakan Stok");
            }
            
            // Sheet 2: Summary by product
            if (summaryMovements.length > 0) {
                const wsSummary = XLSX.utils.json_to_sheet(summaryMovements);
                XLSX.utils.book_append_sheet(wb, wsSummary, "Ringkasan Per Produk");
            }
            
            // Sheet 3: Overall summary
            const wsOverall = XLSX.utils.json_to_sheet(overallSummary);
            XLSX.utils.book_append_sheet(wb, wsOverall, "Ringkasan Keseluruhan");
            
            // Sheet 4: Stock in movements only
            const stockInMovements = detailedMovements.filter(m => m.Status === 'MASUK');
            if (stockInMovements.length > 0) {
                const wsStockIn = XLSX.utils.json_to_sheet(stockInMovements);
                XLSX.utils.book_append_sheet(wb, wsStockIn, "Stok Masuk");
            }
            
            // Sheet 5: Stock out movements only
            const stockOutMovements = detailedMovements.filter(m => m.Status === 'KELUAR');
            if (stockOutMovements.length > 0) {
                const wsStockOut = XLSX.utils.json_to_sheet(stockOutMovements);
                XLSX.utils.book_append_sheet(wb, wsStockOut, "Stok Keluar");
            }
            
            // Generate filename
            const dateStr = new Date().toISOString().split('T')[0];
            const categoryStr = selectedCategory ? `_${selectedCategory}` : '';
            const filename = `laporan_stok_terintegrasi_${dateStr}${categoryStr}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            alert('Laporan stok terintegrasi berhasil diekspor!');
            } catch (error) {
                console.error('Error exporting stock report:', error);
                alert('Terjadi kesalahan saat mengekspor laporan stok!');
            }
        }

        function renderTransactionHistory() {
            const tbody = document.getElementById('transactionHistory');
            const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedTransactions.map(transaction => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${transaction.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(transaction.date).toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(transaction.total)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transaction.cashier}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="mobile-actions">
                            <button onclick="viewTransactionDetail('${transaction.id}')" class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition duration-200 min-w-[60px]" type="button">
                                Detail
                            </button>
                            ${userRole === 'Admin' ? `
                                <button onclick="deleteTransaction('${transaction.id}')" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition duration-200 min-w-[60px]" type="button">
                                    Hapus
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function viewTransactionDetail(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (transaction) {
                showReceipt(transaction);
            }
        }

        function deleteTransaction(transactionId) {
            if (userRole !== 'Admin') {
                alert('Hanya admin yang dapat menghapus transaksi!');
                return;
            }
            
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) {
                alert('Transaksi tidak ditemukan!');
                return;
            }
            
            if (confirm(`Apakah Anda yakin ingin menghapus transaksi ${transactionId}?\n\nStok produk akan dikembalikan dan data penjualan akan disesuaikan.\nTindakan ini tidak dapat dibatalkan.`)) {
                // Restore product stock and adjust sales data
                transaction.items.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        // Restore stock
                        product.stock += item.quantity;
                        // Reduce total sold
                        product.totalSold -= item.quantity;
                        
                        // Ensure totalSold doesn't go below 0
                        if (product.totalSold < 0) {
                            product.totalSold = 0;
                        }
                    }
                });
                
                // Remove transaction from array
                transactions = transactions.filter(t => t.id !== transactionId);
                
                // Save to localStorage
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('products', JSON.stringify(products));
                
                // Update displays
                renderTransactionHistory();
                updateReports();
                updateDashboard();
                renderInventoryTable();
                renderProductGrid();
                
                alert('Transaksi berhasil dihapus! Stok produk telah dikembalikan.');
            }
        }

        // Export functions
        function exportInventory() {
            try {
                // Add export information to each product
                const exportDate = new Date().toLocaleString('id-ID');
                const exportedProducts = products.map(product => {
                    const margin = ((product.sellPrice - product.buyPrice) / product.sellPrice * 100).toFixed(1);
                    const totalstockValue = product.stock * product.buyPrice;
                    const totalBuyValue = product.totalPurchased * product.buyPrice;
                    const totalSellValue = product.totalSold * product.sellPrice;
                    const profit = totalSellValue - (product.totalSold * product.buyPrice);
                    
                    return {
                        'Kode Produk': product.code,
                        'Nama Produk': product.name,
                        'Kategori': product.category,
                        'Tanggal Stok Masuk': new Date(product.purchaseDate).toLocaleDateString('id-ID'),
                        'Harga Beli': product.buyPrice,
                        'Harga Jual': product.sellPrice,
                        'Margin (%)': margin,
                        'Stok Saat Ini': product.stock,
                        'Total Dibeli': product.totalPurchased,
                        'Total Terjual': product.totalSold,
                        'Nilai Stock': totalStockValue,
                        'Nilai Pembelian': totalBuyValue,
                        'Nilai Penjualan': totalSellValue,
                        'Total Keuntungan': profit,
                        'Status Stok': product.stock < 6 ? 'Habis' : product.stock < 12 ? 'Menipis' : 'Tersedia',
                        'Tanggal Update Stok': exportDate,
                        'User Export': currentUser
                    };
                });
                
                // Create summary information
                const summaryInfo = [{
                    'Total Produk': products.length,
                    'Total Nilai Inventory': products.reduce((sum, p) => sum + (p.stock * p.buyPrice), 0),
                    'Total Potensi Penjualan': products.reduce((sum, p) => sum + (p.stock * p.sellPrice), 0),
                    'Produk Stok Habis': products.filter(p => p.stock < 6).length,
                    'Produk Stok Menipis': products.filter(p => p.stock >= 12 && p.stock < 20).length,
                    'Produk Stok Aman': products.filter(p => p.stock >= 20).length,
                    'Tanggal Export': exportDate,
                    'User Export': currentUser
                }];
                
                // Create workbook with multiple sheets
                const wb = XLSX.utils.book_new();
                
                // Sheet 1: Detailed inventory
                const wsInventory = XLSX.utils.json_to_sheet(exportedProducts);
                XLSX.utils.book_append_sheet(wb, wsInventory, "Data Inventory");
                
                // Sheet 2: Summary
                const wsSummary = XLSX.utils.json_to_sheet(summaryInfo);
                XLSX.utils.book_append_sheet(wb, wsSummary, "Ringkasan Inventory");
                
                // Sheet 3: Low stock alert
                const lowStockProducts = exportedProducts.filter(p => p['Stok Saat Ini'] < 20);
                if (lowStockProducts.length > 0) {
                    const wsLowStock = XLSX.utils.json_to_sheet(lowStockProducts);
                    XLSX.utils.book_append_sheet(wb, wsLowStock, "Peringatan Stok");
                }
                
                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const filename = `inventory_${dateStr}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                alert('Data inventory berhasil diekspor!');
            } catch (error) {
                console.error('Error exporting inventory:', error);
                alert('Terjadi kesalahan saat mengekspor data inventory!');
            }
        }

        function exportSalesReport() {
            try {
                // Create detailed transaction data with product information
                const detailedReportData = [];
                
                transactions.forEach(transaction => {
                    transaction.items.forEach((item, index) => {
                        detailedReportData.push({
                            'ID Transaksi': transaction.id,
                            'Tanggal Transaksi': new Date(transaction.date).toLocaleString('id-ID'),
                            'Nama Produk': item.name,
                            'Harga Satuan': item.price,
                            'Jumlah Terjual': item.quantity,
                            'Subtotal Produk': item.price * item.quantity,
                            'Subtotal Transaksi': index === 0 ? transaction.subtotal : '', // Only show on first item
                            'Pajak': index === 0 ? transaction.tax : '',
                            'Total Transaksi': index === 0 ? transaction.total : '',
                            'Metode Pembayaran': index === 0 ? transaction.paymentMethod : '',
                            'Jumlah Bayar': index === 0 ? transaction.payment : '',
                            'Kembalian': index === 0 ? transaction.change : '',
                            'Kasir': transaction.cashier
                        });
                    });
                });
                
                // Create summary data
                const summaryData = [];
                const productSales = {};
                
                // Calculate product sales summary
                transactions.forEach(transaction => {
                    transaction.items.forEach(item => {
                        if (!productSales[item.name]) {
                            productSales[item.name] = {
                                totalQuantity: 0,
                                totalRevenue: 0,
                                transactionCount: 0
                            };
                        }
                        productSales[item.name].totalQuantity += item.quantity;
                        productSales[item.name].totalRevenue += item.price * item.quantity;
                        productSales[item.name].transactionCount++;
                    });
                });
                
                // Convert to summary array
                Object.entries(productSales).forEach(([productName, data]) => {
                    summaryData.push({
                        'Nama Produk': productName,
                        'Total Terjual': data.totalQuantity,
                        'Total Pendapatan': data.totalRevenue,
                        'Jumlah Transaksi': data.transactionCount,
                        'Rata-rata per Transaksi': Math.round(data.totalQuantity / data.transactionCount * 100) / 100
                    });
                });
                
                // Sort summary by total revenue
                summaryData.sort((a, b) => b['Total Pendapatan'] - a['Total Pendapatan']);
                
                // Create workbook with multiple sheets
                const wb = XLSX.utils.book_new();
                
                // Sheet 1: Detailed transactions
                const wsDetailed = XLSX.utils.json_to_sheet(detailedReportData);
                XLSX.utils.book_append_sheet(wb, wsDetailed, "Detail Transaksi");
                
                // Sheet 2: Product sales summary
                const wsSummary = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, "Ringkasan Produk");
                
                // Sheet 3: Overall summary
                const overallSummary = [{
                    'Total Transaksi': transactions.length,
                    'Total Pendapatan': transactions.reduce((sum, t) => sum + t.total, 0),
                    'Rata-rata per Transaksi': transactions.length > 0 ? Math.round(transactions.reduce((sum, t) => sum + t.total, 0) / transactions.length) : 0,
                    'Total Pajak Terkumpul': transactions.reduce((sum, t) => sum + t.tax, 0),
                    'Tanggal Export': new Date().toLocaleString('id-ID'),
                    'User Export': currentUser
                }];
                
                const wsOverall = XLSX.utils.json_to_sheet(overallSummary);
                XLSX.utils.book_append_sheet(wb, wsOverall, "Ringkasan Keseluruhan");
                
                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const filename = `laporan_penjualan_${dateStr}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                alert('Laporan penjualan berhasil diekspor!');
            } catch (error) {
                console.error('Error exporting sales report:', error);
                alert('Terjadi kesalahan saat mengekspor laporan penjualan!');
            }
        }

        // Update UI based on user role
        function updateUIBasedOnRole() {
            const addProductBtn = document.getElementById('addProductBtn');
            
            // Both Admin and Kasir can add products
            if (addProductBtn) {
                addProductBtn.style.display = 'block';
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Settings functions
        function updateSettings() {
            updateUserTable();
            updateCategoryList();
            loadStoreInfoToForm();
        }

        function loadStoreInfoToForm() {
            if (document.getElementById('storeName')) {
                document.getElementById('storeName').value = storeInfo.name;
                document.getElementById('storeAddress').value = storeInfo.address;
                document.getElementById('storePhone').value = storeInfo.phone;
                document.getElementById('storeEmail').value = storeInfo.email;
                document.getElementById('receiptFooter').value = storeInfo.footer;
            }
        }

        function updateUserTable() {
            const userTable = document.getElementById('userTable');
            if (userTable) {
                userTable.innerHTML = users.map(user => `
                    <tr>
                        <td class="px-4 py-2 text-sm text-gray-900">${user.username}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${user.role}</td>
                        <td class="px-4 py-2 text-sm">
                            ${user.id !== 1 ? `<button onclick="deleteUser(${user.id})" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition duration-200" type="button">Hapus</button>` : '<span class="text-gray-400 text-xs">Admin Utama</span>'}
                        </td>
                    </tr>
                `).join('');
            }
        }

        function updateCategoryList() {
            const categoryList = document.getElementById('categoryList');
            if (categoryList) {
                categoryList.innerHTML = categories.map(category => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span>${category}</span>
                        <button onclick="deleteCategory('${category}')" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition duration-200" type="button">Hapus</button>
                    </div>
                `).join('');
            }
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').classList.remove('hidden');
            document.getElementById('addUserModal').classList.add('flex');
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserModal').classList.remove('flex');
            document.getElementById('addUserForm').reset();
        }

        function showAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.remove('hidden');
            document.getElementById('addCategoryModal').classList.add('flex');
        }

        function closeAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.add('hidden');
            document.getElementById('addCategoryModal').classList.remove('flex');
            document.getElementById('addCategoryForm').reset();
        }

        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newUser = {
                id: Date.now(),
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                role: document.getElementById('newUserRole').value
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            updateUserTable();
            closeAddUserModal();
            alert('User berhasil ditambahkan!');
        });

        document.getElementById('addCategoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newCategory = document.getElementById('newCategoryName').value;
            if (!categories.includes(newCategory)) {
                categories.push(newCategory);
                localStorage.setItem('categories', JSON.stringify(categories));
                
                updateCategoryList();
                updateCategoryDropdowns();
                closeAddCategoryModal();
                alert('Kategori berhasil ditambahkan!');
            } else {
                alert('Kategori sudah ada!');
            }
        });

        function deleteUser(userId) {
            // Check if user is admin
            if (userRole !== 'Admin') {
                alert('Hanya admin yang dapat menghapus user!');
                return;
            }
            
            // Prevent deleting main admin
            if (userId === 1) {
                alert('Admin utama tidak dapat dihapus!');
                return;
            }
            
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('User tidak ditemukan!');
                return;
            }
            
            if (confirm(`Apakah Anda yakin ingin menghapus user "${user.username}"?\n\nTindakan ini tidak dapat dibatalkan.`)) {
                users = users.filter(u => u.id !== userId);
                localStorage.setItem('users', JSON.stringify(users));
                updateUserTable();
                alert('User berhasil dihapus!');
            }
        }

        function deleteCategory(categoryName) {
            // Check if user is admin
            if (userRole !== 'Admin') {
                alert('Hanya admin yang dapat menghapus kategori!');
                return;
            }
            
            // Check if category is being used by any product
            const productsUsingCategory = products.filter(p => p.category === categoryName);
            if (productsUsingCategory.length > 0) {
                alert(`Kategori "${categoryName}" tidak dapat dihapus karena masih digunakan oleh ${productsUsingCategory.length} produk!`);
                return;
            }
            
            if (confirm(`Apakah Anda yakin ingin menghapus kategori "${categoryName}"?\n\nTindakan ini tidak dapat dibatalkan.`)) {
                categories = categories.filter(c => c !== categoryName);
                localStorage.setItem('categories', JSON.stringify(categories));
                updateCategoryList();
                updateCategoryDropdowns();
                alert('Kategori berhasil dihapus!');
            }
        }

        function updateCategoryDropdowns() {
            const categorySelects = document.querySelectorAll('#productCategory, #categoryFilter');
            categorySelects.forEach(select => {
                const currentValue = select.value;
                const options = select.querySelectorAll('option:not([value=""])');
                options.forEach(option => option.remove());
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        function updateProductCodePrefix() {
            const newPrefix = document.getElementById('productCodePrefixInput').value;
            productCodePrefix = newPrefix;
            localStorage.setItem('productCodePrefix', productCodePrefix);
            alert('Prefix kode produk berhasil diperbarui!');
        }

        function updateDefaultTax() {
            taxEnabled = document.getElementById('defaultTaxEnabled').checked;
            localStorage.setItem('taxEnabled', JSON.stringify(taxEnabled));
            document.getElementById('taxCheckbox').checked = taxEnabled;
            updateCartTotals();
        }

        function updateTaxSettings() {
            const taxPercentage = document.getElementById('taxPercentage').value;
            localStorage.setItem('taxPercentage', taxPercentage);
            updateCartTotals();
            alert('Pengaturan pajak berhasil diperbarui!');
        }

        function updateStoreInfo() {
            storeInfo.name = document.getElementById('storeName').value || 'Koperasi Sekolah';
            storeInfo.address = document.getElementById('storeAddress').value || 'Jl. Contoh No. 123';
            storeInfo.phone = document.getElementById('storePhone').value || '021-12345678';
            storeInfo.email = document.getElementById('storeEmail').value || '';
            storeInfo.footer = document.getElementById('receiptFooter').value || 'Terima kasih atas kunjungan Anda!';
            
            localStorage.setItem('storeInfo', JSON.stringify(storeInfo));
            alert('Informasi toko berhasil diperbarui!');
        }



        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set focus on username field
            document.getElementById('username').focus();
            
            // Initialize sample data on page load
            initializeSampleData();
            
            // Initialize event listeners
            initializeEventListeners();
            
            // Add form event listener
            const addProductForm = document.getElementById('addProductForm');
            if (addProductForm) {
                addProductForm.addEventListener('submit', addProductFormHandler);
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96bc2a3ac0c76040',t:'MTc1NDYyNjIzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
